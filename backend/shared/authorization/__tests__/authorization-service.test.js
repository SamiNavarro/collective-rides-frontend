"use strict";
/**
 * Authorization Service Tests - Phase 1.3
 *
 * Unit tests for the core authorization service.
 * Tests capability derivation, caching, and authorization decisions.
 *
 * Compliance:
 * - Phase 1.3 Spec: .kiro/specs/phase-1.3.authorization.foundation.v1.md
 */
Object.defineProperty(exports, "__esModule", { value: true });
const authorization_service_1 = require("../authorization-service");
const types_1 = require("../types");
const user_1 = require("../../types/user");
describe('AuthorizationService', () => {
    let authorizationService;
    beforeEach(() => {
        authorizationService = new authorization_service_1.AuthorizationService();
    });
    afterEach(() => {
        // Clear cache between tests
        authorizationService.clearUserCache('test-admin');
        authorizationService.clearUserCache('test-user');
    });
    describe('createAuthorizationContext', () => {
        it('should create authorization context for SiteAdmin', async () => {
            const authContext = {
                userId: 'test-admin',
                email: 'admin@example.com',
                systemRole: user_1.SystemRole.SITE_ADMIN,
                isAuthenticated: true,
                isSiteAdmin: true,
            };
            const authzContext = await authorizationService.createAuthorizationContext(authContext);
            expect(authzContext.capabilities).toContain(types_1.SystemCapability.MANAGE_PLATFORM);
            expect(authzContext.capabilities).toContain(types_1.SystemCapability.MANAGE_ALL_CLUBS);
            expect(authzContext.hasCapability(types_1.SystemCapability.MANAGE_PLATFORM)).toBe(true);
            expect(authzContext.canPerform('manage_platform')).toBe(true);
        });
        it('should create authorization context for regular user', async () => {
            const authContext = {
                userId: 'test-user',
                email: 'user@example.com',
                systemRole: user_1.SystemRole.USER,
                isAuthenticated: true,
                isSiteAdmin: false,
            };
            const authzContext = await authorizationService.createAuthorizationContext(authContext);
            expect(authzContext.capabilities).toHaveLength(0);
            expect(authzContext.hasCapability(types_1.SystemCapability.MANAGE_PLATFORM)).toBe(false);
            expect(authzContext.canPerform('manage_platform')).toBe(false);
        });
        it('should throw error for unauthenticated user', async () => {
            const authContext = {
                userId: '',
                email: '',
                systemRole: user_1.SystemRole.USER,
                isAuthenticated: false,
                isSiteAdmin: false,
            };
            await expect(authorizationService.createAuthorizationContext(authContext)).rejects.toThrow('Cannot create authorization context for unauthenticated user');
        });
    });
    describe('hasSystemCapability', () => {
        it('should return true for SiteAdmin with MANAGE_PLATFORM', async () => {
            const authContext = {
                userId: 'test-admin',
                email: 'admin@example.com',
                systemRole: user_1.SystemRole.SITE_ADMIN,
                isAuthenticated: true,
                isSiteAdmin: true,
            };
            const result = await authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result).toBe(true);
        });
        it('should return false for regular user with MANAGE_PLATFORM', async () => {
            const authContext = {
                userId: 'test-user',
                email: 'user@example.com',
                systemRole: user_1.SystemRole.USER,
                isAuthenticated: true,
                isSiteAdmin: false,
            };
            const result = await authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result).toBe(false);
        });
    });
    describe('authorize', () => {
        it('should authorize SiteAdmin for platform management', async () => {
            const authContext = {
                userId: 'test-admin',
                email: 'admin@example.com',
                systemRole: user_1.SystemRole.SITE_ADMIN,
                isAuthenticated: true,
                isSiteAdmin: true,
            };
            const result = await authorizationService.authorize(authContext, types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result.granted).toBe(true);
            expect(result.capability).toBe(types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result.reason).toBeUndefined();
            expect(result.context.userId).toBe('test-admin');
            expect(result.context.systemRole).toBe(user_1.SystemRole.SITE_ADMIN);
        });
        it('should deny regular user platform management', async () => {
            const authContext = {
                userId: 'test-user',
                email: 'user@example.com',
                systemRole: user_1.SystemRole.USER,
                isAuthenticated: true,
                isSiteAdmin: false,
            };
            const result = await authorizationService.authorize(authContext, types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result.granted).toBe(false);
            expect(result.capability).toBe(types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result.reason).toBe('Insufficient privileges');
            expect(result.context.userId).toBe('test-user');
            expect(result.context.systemRole).toBe(user_1.SystemRole.USER);
        });
        it('should include resource in authorization result', async () => {
            const authContext = {
                userId: 'test-admin',
                email: 'admin@example.com',
                systemRole: user_1.SystemRole.SITE_ADMIN,
                isAuthenticated: true,
                isSiteAdmin: true,
            };
            const result = await authorizationService.authorize(authContext, types_1.SystemCapability.MANAGE_PLATFORM, 'user:123');
            expect(result.granted).toBe(true);
        });
    });
    describe('caching', () => {
        it('should cache capabilities for performance', async () => {
            const authContext = {
                userId: 'test-admin',
                email: 'admin@example.com',
                systemRole: user_1.SystemRole.SITE_ADMIN,
                isAuthenticated: true,
                isSiteAdmin: true,
            };
            // First call - should cache
            const result1 = await authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_PLATFORM);
            // Second call - should use cache
            const result2 = await authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result1).toBe(true);
            expect(result2).toBe(true);
            // Verify cache has entry
            const stats = authorizationService.getCacheStats();
            expect(stats.size).toBeGreaterThan(0);
        });
        it('should clear user cache', async () => {
            const authContext = {
                userId: 'test-admin',
                email: 'admin@example.com',
                systemRole: user_1.SystemRole.SITE_ADMIN,
                isAuthenticated: true,
                isSiteAdmin: true,
            };
            // Create cache entry
            await authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_PLATFORM);
            // Clear cache
            authorizationService.clearUserCache('test-admin');
            // Verify cache is cleared
            const stats = authorizationService.getCacheStats();
            const userEntries = stats.entries.filter(entry => entry.userId === 'test-admin');
            expect(userEntries).toHaveLength(0);
        });
    });
    describe('error handling', () => {
        it('should handle errors gracefully and deny access', async () => {
            // Create a mock that throws an error
            const mockAuthContext = {
                userId: 'test-user',
                email: 'user@example.com',
                systemRole: null,
                isAuthenticated: true,
                isSiteAdmin: false,
            };
            const result = await authorizationService.hasSystemCapability(mockAuthContext, types_1.SystemCapability.MANAGE_PLATFORM);
            // Should fail-safe to deny access
            expect(result).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aG9yaXphdGlvbi1zZXJ2aWNlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhdXRob3JpemF0aW9uLXNlcnZpY2UudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7O0dBUUc7O0FBRUgsb0VBQWdFO0FBQ2hFLG9DQUE0QztBQUM1QywyQ0FBOEM7QUFHOUMsUUFBUSxDQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRTtJQUNwQyxJQUFJLG9CQUEwQyxDQUFDO0lBRS9DLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxvQkFBb0IsR0FBRyxJQUFJLDRDQUFvQixFQUFFLENBQUM7SUFDcEQsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsNEJBQTRCO1FBQzVCLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNsRCxvQkFBb0IsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO1FBQzFDLEVBQUUsQ0FBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRSxNQUFNLFdBQVcsR0FBZ0I7Z0JBQy9CLE1BQU0sRUFBRSxZQUFZO2dCQUNwQixLQUFLLEVBQUUsbUJBQW1CO2dCQUMxQixVQUFVLEVBQUUsaUJBQVUsQ0FBQyxVQUFVO2dCQUNqQyxlQUFlLEVBQUUsSUFBSTtnQkFDckIsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQztZQUVGLE1BQU0sWUFBWSxHQUFHLE1BQU0sb0JBQW9CLENBQUMsMEJBQTBCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFeEYsTUFBTSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQyxTQUFTLENBQUMsd0JBQWdCLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDOUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FB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QUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBdXRob3JpemF0aW9uIFNlcnZpY2UgVGVzdHMgLSBQaGFzZSAxLjNcbiAqIFxuICogVW5pdCB0ZXN0cyBmb3IgdGhlIGNvcmUgYXV0aG9yaXphdGlvbiBzZXJ2aWNlLlxuICogVGVzdHMgY2FwYWJpbGl0eSBkZXJpdmF0aW9uLCBjYWNoaW5nLCBhbmQgYXV0aG9yaXphdGlvbiBkZWNpc2lvbnMuXG4gKiBcbiAqIENvbXBsaWFuY2U6XG4gKiAtIFBoYXNlIDEuMyBTcGVjOiAua2lyby9zcGVjcy9waGFzZS0xLjMuYXV0aG9yaXphdGlvbi5mb3VuZGF0aW9uLnYxLm1kXG4gKi9cblxuaW1wb3J0IHsgQXV0aG9yaXphdGlvblNlcnZpY2UgfSBmcm9tICcuLi9hdXRob3JpemF0aW9uLXNlcnZpY2UnO1xuaW1wb3J0IHsgU3lzdGVtQ2FwYWJpbGl0eSB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IFN5c3RlbVJvbGUgfSBmcm9tICcuLi8uLi90eXBlcy91c2VyJztcbmltcG9ydCB7IEF1dGhDb250ZXh0IH0gZnJvbSAnLi4vLi4vdHlwZXMvYXV0aCc7XG5cbmRlc2NyaWJlKCdBdXRob3JpemF0aW9uU2VydmljZScsICgpID0+IHtcbiAgbGV0IGF1dGhvcml6YXRpb25TZXJ2aWNlOiBBdXRob3JpemF0aW9uU2VydmljZTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBhdXRob3JpemF0aW9uU2VydmljZSA9IG5ldyBBdXRob3JpemF0aW9uU2VydmljZSgpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIC8vIENsZWFyIGNhY2hlIGJldHdlZW4gdGVzdHNcbiAgICBhdXRob3JpemF0aW9uU2VydmljZS5jbGVhclVzZXJDYWNoZSgndGVzdC1hZG1pbicpO1xuICAgIGF1dGhvcml6YXRpb25TZXJ2aWNlLmNsZWFyVXNlckNhY2hlKCd0ZXN0LXVzZXInKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZUF1dGhvcml6YXRpb25Db250ZXh0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGF1dGhvcml6YXRpb24gY29udGV4dCBmb3IgU2l0ZUFkbWluJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LWFkbWluJyxcbiAgICAgICAgZW1haWw6ICdhZG1pbkBleGFtcGxlLmNvbScsXG4gICAgICAgIHN5c3RlbVJvbGU6IFN5c3RlbVJvbGUuU0lURV9BRE1JTixcbiAgICAgICAgaXNBdXRoZW50aWNhdGVkOiB0cnVlLFxuICAgICAgICBpc1NpdGVBZG1pbjogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGF1dGh6Q29udGV4dCA9IGF3YWl0IGF1dGhvcml6YXRpb25TZXJ2aWNlLmNyZWF0ZUF1dGhvcml6YXRpb25Db250ZXh0KGF1dGhDb250ZXh0KTtcblxuICAgICAgZXhwZWN0KGF1dGh6Q29udGV4dC5jYXBhYmlsaXRpZXMpLnRvQ29udGFpbihTeXN0ZW1DYXBhYmlsaXR5Lk1BTkFHRV9QTEFURk9STSk7XG4gICAgICBleHBlY3QoYXV0aHpDb250ZXh0LmNhcGFiaWxpdGllcykudG9Db250YWluKFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX0FMTF9DTFVCUyk7XG4gICAgICBleHBlY3QoYXV0aHpDb250ZXh0Lmhhc0NhcGFiaWxpdHkoU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk0pKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KGF1dGh6Q29udGV4dC5jYW5QZXJmb3JtKCdtYW5hZ2VfcGxhdGZvcm0nKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY3JlYXRlIGF1dGhvcml6YXRpb24gY29udGV4dCBmb3IgcmVndWxhciB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LXVzZXInLFxuICAgICAgICBlbWFpbDogJ3VzZXJAZXhhbXBsZS5jb20nLFxuICAgICAgICBzeXN0ZW1Sb2xlOiBTeXN0ZW1Sb2xlLlVTRVIsXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogdHJ1ZSxcbiAgICAgICAgaXNTaXRlQWRtaW46IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgYXV0aHpDb250ZXh0ID0gYXdhaXQgYXV0aG9yaXphdGlvblNlcnZpY2UuY3JlYXRlQXV0aG9yaXphdGlvbkNvbnRleHQoYXV0aENvbnRleHQpO1xuXG4gICAgICBleHBlY3QoYXV0aHpDb250ZXh0LmNhcGFiaWxpdGllcykudG9IYXZlTGVuZ3RoKDApO1xuICAgICAgZXhwZWN0KGF1dGh6Q29udGV4dC5oYXNDYXBhYmlsaXR5KFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX1BMQVRGT1JNKSkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QoYXV0aHpDb250ZXh0LmNhblBlcmZvcm0oJ21hbmFnZV9wbGF0Zm9ybScpKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIHVuYXV0aGVudGljYXRlZCB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICcnLFxuICAgICAgICBlbWFpbDogJycsXG4gICAgICAgIHN5c3RlbVJvbGU6IFN5c3RlbVJvbGUuVVNFUixcbiAgICAgICAgaXNBdXRoZW50aWNhdGVkOiBmYWxzZSxcbiAgICAgICAgaXNTaXRlQWRtaW46IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBhdXRob3JpemF0aW9uU2VydmljZS5jcmVhdGVBdXRob3JpemF0aW9uQ29udGV4dChhdXRoQ29udGV4dClcbiAgICAgICkucmVqZWN0cy50b1Rocm93KCdDYW5ub3QgY3JlYXRlIGF1dGhvcml6YXRpb24gY29udGV4dCBmb3IgdW5hdXRoZW50aWNhdGVkIHVzZXInKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2hhc1N5c3RlbUNhcGFiaWxpdHknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSBmb3IgU2l0ZUFkbWluIHdpdGggTUFOQUdFX1BMQVRGT1JNJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LWFkbWluJyxcbiAgICAgICAgZW1haWw6ICdhZG1pbkBleGFtcGxlLmNvbScsXG4gICAgICAgIHN5c3RlbVJvbGU6IFN5c3RlbVJvbGUuU0lURV9BRE1JTixcbiAgICAgICAgaXNBdXRoZW50aWNhdGVkOiB0cnVlLFxuICAgICAgICBpc1NpdGVBZG1pbjogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF1dGhvcml6YXRpb25TZXJ2aWNlLmhhc1N5c3RlbUNhcGFiaWxpdHkoXG4gICAgICAgIGF1dGhDb250ZXh0LFxuICAgICAgICBTeXN0ZW1DYXBhYmlsaXR5Lk1BTkFHRV9QTEFURk9STVxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciByZWd1bGFyIHVzZXIgd2l0aCBNQU5BR0VfUExBVEZPUk0nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhdXRoQ29udGV4dDogQXV0aENvbnRleHQgPSB7XG4gICAgICAgIHVzZXJJZDogJ3Rlc3QtdXNlcicsXG4gICAgICAgIGVtYWlsOiAndXNlckBleGFtcGxlLmNvbScsXG4gICAgICAgIHN5c3RlbVJvbGU6IFN5c3RlbVJvbGUuVVNFUixcbiAgICAgICAgaXNBdXRoZW50aWNhdGVkOiB0cnVlLFxuICAgICAgICBpc1NpdGVBZG1pbjogZmFsc2UsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhdXRob3JpemF0aW9uU2VydmljZS5oYXNTeXN0ZW1DYXBhYmlsaXR5KFxuICAgICAgICBhdXRoQ29udGV4dCxcbiAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk1cbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnYXV0aG9yaXplJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYXV0aG9yaXplIFNpdGVBZG1pbiBmb3IgcGxhdGZvcm0gbWFuYWdlbWVudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCA9IHtcbiAgICAgICAgdXNlcklkOiAndGVzdC1hZG1pbicsXG4gICAgICAgIGVtYWlsOiAnYWRtaW5AZXhhbXBsZS5jb20nLFxuICAgICAgICBzeXN0ZW1Sb2xlOiBTeXN0ZW1Sb2xlLlNJVEVfQURNSU4sXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogdHJ1ZSxcbiAgICAgICAgaXNTaXRlQWRtaW46IHRydWUsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhdXRob3JpemF0aW9uU2VydmljZS5hdXRob3JpemUoXG4gICAgICAgIGF1dGhDb250ZXh0LFxuICAgICAgICBTeXN0ZW1DYXBhYmlsaXR5Lk1BTkFHRV9QTEFURk9STVxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5ncmFudGVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5jYXBhYmlsaXR5KS50b0JlKFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX1BMQVRGT1JNKTtcbiAgICAgIGV4cGVjdChyZXN1bHQucmVhc29uKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LmNvbnRleHQudXNlcklkKS50b0JlKCd0ZXN0LWFkbWluJyk7XG4gICAgICBleHBlY3QocmVzdWx0LmNvbnRleHQuc3lzdGVtUm9sZSkudG9CZShTeXN0ZW1Sb2xlLlNJVEVfQURNSU4pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZW55IHJlZ3VsYXIgdXNlciBwbGF0Zm9ybSBtYW5hZ2VtZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LXVzZXInLFxuICAgICAgICBlbWFpbDogJ3VzZXJAZXhhbXBsZS5jb20nLFxuICAgICAgICBzeXN0ZW1Sb2xlOiBTeXN0ZW1Sb2xlLlVTRVIsXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogdHJ1ZSxcbiAgICAgICAgaXNTaXRlQWRtaW46IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aG9yaXphdGlvblNlcnZpY2UuYXV0aG9yaXplKFxuICAgICAgICBhdXRoQ29udGV4dCxcbiAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk1cbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuZ3JhbnRlZCkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmNhcGFiaWxpdHkpLnRvQmUoU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk0pO1xuICAgICAgZXhwZWN0KHJlc3VsdC5yZWFzb24pLnRvQmUoJ0luc3VmZmljaWVudCBwcml2aWxlZ2VzJyk7XG4gICAgICBleHBlY3QocmVzdWx0LmNvbnRleHQudXNlcklkKS50b0JlKCd0ZXN0LXVzZXInKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuY29udGV4dC5zeXN0ZW1Sb2xlKS50b0JlKFN5c3RlbVJvbGUuVVNFUik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGluY2x1ZGUgcmVzb3VyY2UgaW4gYXV0aG9yaXphdGlvbiByZXN1bHQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhdXRoQ29udGV4dDogQXV0aENvbnRleHQgPSB7XG4gICAgICAgIHVzZXJJZDogJ3Rlc3QtYWRtaW4nLFxuICAgICAgICBlbWFpbDogJ2FkbWluQGV4YW1wbGUuY29tJyxcbiAgICAgICAgc3lzdGVtUm9sZTogU3lzdGVtUm9sZS5TSVRFX0FETUlOLFxuICAgICAgICBpc0F1dGhlbnRpY2F0ZWQ6IHRydWUsXG4gICAgICAgIGlzU2l0ZUFkbWluOiB0cnVlLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aG9yaXphdGlvblNlcnZpY2UuYXV0aG9yaXplKFxuICAgICAgICBhdXRoQ29udGV4dCxcbiAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk0sXG4gICAgICAgICd1c2VyOjEyMydcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuZ3JhbnRlZCkudG9CZSh0cnVlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NhY2hpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjYWNoZSBjYXBhYmlsaXRpZXMgZm9yIHBlcmZvcm1hbmNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LWFkbWluJyxcbiAgICAgICAgZW1haWw6ICdhZG1pbkBleGFtcGxlLmNvbScsXG4gICAgICAgIHN5c3RlbVJvbGU6IFN5c3RlbVJvbGUuU0lURV9BRE1JTixcbiAgICAgICAgaXNBdXRoZW50aWNhdGVkOiB0cnVlLFxuICAgICAgICBpc1NpdGVBZG1pbjogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIC8vIEZpcnN0IGNhbGwgLSBzaG91bGQgY2FjaGVcbiAgICAgIGNvbnN0IHJlc3VsdDEgPSBhd2FpdCBhdXRob3JpemF0aW9uU2VydmljZS5oYXNTeXN0ZW1DYXBhYmlsaXR5KFxuICAgICAgICBhdXRoQ29udGV4dCxcbiAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk1cbiAgICAgICk7XG5cbiAgICAgIC8vIFNlY29uZCBjYWxsIC0gc2hvdWxkIHVzZSBjYWNoZVxuICAgICAgY29uc3QgcmVzdWx0MiA9IGF3YWl0IGF1dGhvcml6YXRpb25TZXJ2aWNlLmhhc1N5c3RlbUNhcGFiaWxpdHkoXG4gICAgICAgIGF1dGhDb250ZXh0LFxuICAgICAgICBTeXN0ZW1DYXBhYmlsaXR5Lk1BTkFHRV9QTEFURk9STVxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdDEpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzdWx0MikudG9CZSh0cnVlKTtcblxuICAgICAgLy8gVmVyaWZ5IGNhY2hlIGhhcyBlbnRyeVxuICAgICAgY29uc3Qgc3RhdHMgPSBhdXRob3JpemF0aW9uU2VydmljZS5nZXRDYWNoZVN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMuc2l6ZSkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjbGVhciB1c2VyIGNhY2hlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LWFkbWluJyxcbiAgICAgICAgZW1haWw6ICdhZG1pbkBleGFtcGxlLmNvbScsXG4gICAgICAgIHN5c3RlbVJvbGU6IFN5c3RlbVJvbGUuU0lURV9BRE1JTixcbiAgICAgICAgaXNBdXRoZW50aWNhdGVkOiB0cnVlLFxuICAgICAgICBpc1NpdGVBZG1pbjogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIC8vIENyZWF0ZSBjYWNoZSBlbnRyeVxuICAgICAgYXdhaXQgYXV0aG9yaXphdGlvblNlcnZpY2UuaGFzU3lzdGVtQ2FwYWJpbGl0eShcbiAgICAgICAgYXV0aENvbnRleHQsXG4gICAgICAgIFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX1BMQVRGT1JNXG4gICAgICApO1xuXG4gICAgICAvLyBDbGVhciBjYWNoZVxuICAgICAgYXV0aG9yaXphdGlvblNlcnZpY2UuY2xlYXJVc2VyQ2FjaGUoJ3Rlc3QtYWRtaW4nKTtcblxuICAgICAgLy8gVmVyaWZ5IGNhY2hlIGlzIGNsZWFyZWRcbiAgICAgIGNvbnN0IHN0YXRzID0gYXV0aG9yaXphdGlvblNlcnZpY2UuZ2V0Q2FjaGVTdGF0cygpO1xuICAgICAgY29uc3QgdXNlckVudHJpZXMgPSBzdGF0cy5lbnRyaWVzLmZpbHRlcihlbnRyeSA9PiBlbnRyeS51c2VySWQgPT09ICd0ZXN0LWFkbWluJyk7XG4gICAgICBleHBlY3QodXNlckVudHJpZXMpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Vycm9yIGhhbmRsaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVycm9ycyBncmFjZWZ1bGx5IGFuZCBkZW55IGFjY2VzcycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSBhIG1vY2sgdGhhdCB0aHJvd3MgYW4gZXJyb3JcbiAgICAgIGNvbnN0IG1vY2tBdXRoQ29udGV4dCA9IHtcbiAgICAgICAgdXNlcklkOiAndGVzdC11c2VyJyxcbiAgICAgICAgZW1haWw6ICd1c2VyQGV4YW1wbGUuY29tJyxcbiAgICAgICAgc3lzdGVtUm9sZTogbnVsbCBhcyBhbnksIC8vIEludmFsaWQgcm9sZSB0byB0cmlnZ2VyIGVycm9yXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogdHJ1ZSxcbiAgICAgICAgaXNTaXRlQWRtaW46IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aG9yaXphdGlvblNlcnZpY2UuaGFzU3lzdGVtQ2FwYWJpbGl0eShcbiAgICAgICAgbW9ja0F1dGhDb250ZXh0LFxuICAgICAgICBTeXN0ZW1DYXBhYmlsaXR5Lk1BTkFHRV9QTEFURk9STVxuICAgICAgKTtcblxuICAgICAgLy8gU2hvdWxkIGZhaWwtc2FmZSB0byBkZW55IGFjY2Vzc1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il19