"use strict";
/**
 * Capability Resolver Tests - Phase 1.3
 *
 * Unit tests for capability derivation logic.
 * Validates the capability matrix and role-based access control.
 *
 * Compliance:
 * - Phase 1.3 Spec: .kiro/specs/phase-1.3.authorization.foundation.v1.md
 */
Object.defineProperty(exports, "__esModule", { value: true });
const capability_resolver_1 = require("../capability-resolver");
const types_1 = require("../types");
const user_1 = require("../../types/user");
describe('CapabilityResolver', () => {
    let capabilityResolver;
    beforeEach(() => {
        capabilityResolver = new capability_resolver_1.CapabilityResolver();
    });
    describe('deriveCapabilities', () => {
        it('should grant all system capabilities to SiteAdmin', async () => {
            const authContext = {
                userId: 'test-admin',
                email: 'admin@example.com',
                systemRole: user_1.SystemRole.SITE_ADMIN,
                isAuthenticated: true,
                isSiteAdmin: true,
            };
            const capabilities = await capabilityResolver.deriveCapabilities(authContext);
            expect(capabilities).toContain(types_1.SystemCapability.MANAGE_PLATFORM);
            expect(capabilities).toContain(types_1.SystemCapability.MANAGE_ALL_CLUBS);
            expect(capabilities).toHaveLength(2);
        });
        it('should grant no system capabilities to regular users', async () => {
            const authContext = {
                userId: 'test-user',
                email: 'user@example.com',
                systemRole: user_1.SystemRole.USER,
                isAuthenticated: true,
                isSiteAdmin: false,
            };
            const capabilities = await capabilityResolver.deriveCapabilities(authContext);
            expect(capabilities).toHaveLength(0);
        });
        it('should handle invalid system role gracefully', async () => {
            const authContext = {
                userId: 'test-user',
                email: 'user@example.com',
                systemRole: 'INVALID_ROLE',
                isAuthenticated: true,
                isSiteAdmin: false,
            };
            const capabilities = await capabilityResolver.deriveCapabilities(authContext);
            expect(capabilities).toHaveLength(0);
        });
    });
    describe('hasCapability', () => {
        it('should return true for SiteAdmin with MANAGE_PLATFORM', () => {
            const result = capabilityResolver.hasCapability(user_1.SystemRole.SITE_ADMIN, types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result).toBe(true);
        });
        it('should return true for SiteAdmin with MANAGE_ALL_CLUBS', () => {
            const result = capabilityResolver.hasCapability(user_1.SystemRole.SITE_ADMIN, types_1.SystemCapability.MANAGE_ALL_CLUBS);
            expect(result).toBe(true);
        });
        it('should return false for regular user with MANAGE_PLATFORM', () => {
            const result = capabilityResolver.hasCapability(user_1.SystemRole.USER, types_1.SystemCapability.MANAGE_PLATFORM);
            expect(result).toBe(false);
        });
        it('should return false for regular user with MANAGE_ALL_CLUBS', () => {
            const result = capabilityResolver.hasCapability(user_1.SystemRole.USER, types_1.SystemCapability.MANAGE_ALL_CLUBS);
            expect(result).toBe(false);
        });
    });
    describe('isValidCapability', () => {
        it('should return true for valid capabilities', () => {
            expect(capabilityResolver.isValidCapability('manage_platform')).toBe(true);
            expect(capabilityResolver.isValidCapability('manage_all_clubs')).toBe(true);
        });
        it('should return false for invalid capabilities', () => {
            expect(capabilityResolver.isValidCapability('invalid_capability')).toBe(false);
            expect(capabilityResolver.isValidCapability('')).toBe(false);
        });
    });
    describe('getAllCapabilities', () => {
        it('should return all system capabilities', () => {
            const capabilities = capabilityResolver.getAllCapabilities();
            expect(capabilities).toContain(types_1.SystemCapability.MANAGE_PLATFORM);
            expect(capabilities).toContain(types_1.SystemCapability.MANAGE_ALL_CLUBS);
            expect(capabilities).toHaveLength(2);
        });
    });
    describe('getCapabilityMatrix', () => {
        it('should return complete capability matrix', () => {
            const matrix = capabilityResolver.getCapabilityMatrix();
            expect(matrix[user_1.SystemRole.USER]).toEqual([]);
            expect(matrix[user_1.SystemRole.SITE_ADMIN]).toContain(types_1.SystemCapability.MANAGE_PLATFORM);
            expect(matrix[user_1.SystemRole.SITE_ADMIN]).toContain(types_1.SystemCapability.MANAGE_ALL_CLUBS);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FwYWJpbGl0eS1yZXNvbHZlci50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2FwYWJpbGl0eS1yZXNvbHZlci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7QUFFSCxnRUFBNEQ7QUFDNUQsb0NBQTRDO0FBQzVDLDJDQUE4QztBQUc5QyxRQUFRLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLElBQUksa0JBQXNDLENBQUM7SUFFM0MsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLGtCQUFrQixHQUFHLElBQUksd0NBQWtCLEVBQUUsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7UUFDbEMsRUFBRSxDQUFDLG1EQUFtRCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2pFLE1BQU0sV0FBVyxHQUFnQjtnQkFDL0IsTUFBTSxFQUFFLFlBQVk7Z0JBQ3BCLEtBQUssRUFBRSxtQkFBbUI7Z0JBQzFCLFVBQVUsRUFBRSxpQkFBVSxDQUFDLFVBQVU7Z0JBQ2pDLGVBQWUsRUFBRSxJQUFJO2dCQUNyQixXQUFXLEVBQUUsSUFBSTthQUNsQixDQUFDO1lBRUYsTUFBTSxZQUFZLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUU5RSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsU0FBUyxDQUFDLHdCQUFnQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxTQUFTLENBQUMsd0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNsRSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHNEQUFzRCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3BFLE1BQU0sV0FBVyxHQUFnQjtnQkFDL0IsTUFBTSxFQUFFLFdBQVc7Z0JBQ25CLEtBQUssRUFBRSxrQkFBa0I7Z0JBQ3pCLFVBQVUsRUFBRSxpQkFBVSxDQUFDLElBQUk7Z0JBQzNCLGVBQWUsRUFBRSxJQUFJO2dCQUNyQixXQUFXLEVBQUUsS0FBSzthQUNuQixDQUFDO1lBRUYsTUFBTSxZQUFZLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUU5RSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDhDQUE4QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzVELE1BQU0sV0FBVyxHQUFnQjtnQkFDL0IsTUFBTSxFQUFFLFdBQVc7Z0JBQ25CLEtBQUssRUFBRSxrQkFBa0I7Z0JBQ3pCLFVBQVUsRUFBRSxjQUE0QjtnQkFDeEMsZUFBZSxFQUFFLElBQUk7Z0JBQ3JCLFdBQVcsRUFBRSxLQUFLO2FBQ25CLENBQUM7WUFFRixNQUFNLFlBQVksR0FBRyxNQUFNLGtCQUFrQixDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRTlFLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO1FBQzdCLEVBQUUsQ0FBQyx1REFBdUQsRUFBRSxHQUFHLEVBQUU7WUFDL0QsTUFBTSxNQUFNLEdBQUcsa0JBQWtCLENBQUMsYUFBYSxDQUM3QyxpQkFBVSxDQUFDLFVBQVUsRUFDckIsd0JBQWdCLENBQUMsZUFBZSxDQUNqQyxDQUFDO1lBRUYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx3REFBd0QsRUFBRSxHQUFHLEVBQUU7WUFDaEUsTUFBTSxNQUFNLEdBQUcsa0JBQWtCLENBQUMsYUFBYSxDQUM3QyxpQkFBVSxDQUFDLFVBQVUsRUFDckIsd0JBQWdCLENBQUMsZ0JBQWdCLENBQ2xDLENBQUM7WUFFRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDJEQUEyRCxFQUFFLEdBQUcsRUFBRTtZQUNuRSxNQUFNLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxhQUFhLENBQzdDLGlCQUFVLENBQUMsSUFBSSxFQUNmLHdCQUFnQixDQUFDLGVBQWUsQ0FDakMsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNERBQTRELEVBQUUsR0FBRyxFQUFFO1lBQ3BFLE1BQU0sTUFBTSxHQUFHLGtCQUFrQixDQUFDLGFBQWEsQ0FDN0MsaUJBQVUsQ0FBQyxJQUFJLEVBQ2Ysd0JBQWdCLENBQUMsZ0JBQWdCLENBQ2xDLENBQUM7WUFFRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQ2pDLEVBQUUsQ0FBQywyQ0FBMkMsRUFBRSxHQUFHLEVBQUU7WUFDbkQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0UsTUFBTSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUUsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOENBQThDLEVBQUUsR0FBRyxFQUFFO1lBQ3RELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9FLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtRQUNsQyxFQUFFLENBQUMsdUNBQXVDLEVBQUUsR0FBRyxFQUFFO1lBQy9DLE1BQU0sWUFBWSxHQUFHLGtCQUFrQixDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFFN0QsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyx3QkFBZ0IsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNqRSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsU0FBUyxDQUFDLHdCQUFnQixDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDbEUsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtRQUNuQyxFQUFFLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFO1lBQ2xELE1BQU0sTUFBTSxHQUFHLGtCQUFrQixDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFFeEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxpQkFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsaUJBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyx3QkFBZ0IsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNsRixNQUFNLENBQUMsTUFBTSxDQUFDLGlCQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsd0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNyRixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENhcGFiaWxpdHkgUmVzb2x2ZXIgVGVzdHMgLSBQaGFzZSAxLjNcbiAqIFxuICogVW5pdCB0ZXN0cyBmb3IgY2FwYWJpbGl0eSBkZXJpdmF0aW9uIGxvZ2ljLlxuICogVmFsaWRhdGVzIHRoZSBjYXBhYmlsaXR5IG1hdHJpeCBhbmQgcm9sZS1iYXNlZCBhY2Nlc3MgY29udHJvbC5cbiAqIFxuICogQ29tcGxpYW5jZTpcbiAqIC0gUGhhc2UgMS4zIFNwZWM6IC5raXJvL3NwZWNzL3BoYXNlLTEuMy5hdXRob3JpemF0aW9uLmZvdW5kYXRpb24udjEubWRcbiAqL1xuXG5pbXBvcnQgeyBDYXBhYmlsaXR5UmVzb2x2ZXIgfSBmcm9tICcuLi9jYXBhYmlsaXR5LXJlc29sdmVyJztcbmltcG9ydCB7IFN5c3RlbUNhcGFiaWxpdHkgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBTeXN0ZW1Sb2xlIH0gZnJvbSAnLi4vLi4vdHlwZXMvdXNlcic7XG5pbXBvcnQgeyBBdXRoQ29udGV4dCB9IGZyb20gJy4uLy4uL3R5cGVzL2F1dGgnO1xuXG5kZXNjcmliZSgnQ2FwYWJpbGl0eVJlc29sdmVyJywgKCkgPT4ge1xuICBsZXQgY2FwYWJpbGl0eVJlc29sdmVyOiBDYXBhYmlsaXR5UmVzb2x2ZXI7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY2FwYWJpbGl0eVJlc29sdmVyID0gbmV3IENhcGFiaWxpdHlSZXNvbHZlcigpO1xuICB9KTtcblxuICBkZXNjcmliZSgnZGVyaXZlQ2FwYWJpbGl0aWVzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ3JhbnQgYWxsIHN5c3RlbSBjYXBhYmlsaXRpZXMgdG8gU2l0ZUFkbWluJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZXN0LWFkbWluJyxcbiAgICAgICAgZW1haWw6ICdhZG1pbkBleGFtcGxlLmNvbScsXG4gICAgICAgIHN5c3RlbVJvbGU6IFN5c3RlbVJvbGUuU0lURV9BRE1JTixcbiAgICAgICAgaXNBdXRoZW50aWNhdGVkOiB0cnVlLFxuICAgICAgICBpc1NpdGVBZG1pbjogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGNhcGFiaWxpdGllcyA9IGF3YWl0IGNhcGFiaWxpdHlSZXNvbHZlci5kZXJpdmVDYXBhYmlsaXRpZXMoYXV0aENvbnRleHQpO1xuXG4gICAgICBleHBlY3QoY2FwYWJpbGl0aWVzKS50b0NvbnRhaW4oU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk0pO1xuICAgICAgZXhwZWN0KGNhcGFiaWxpdGllcykudG9Db250YWluKFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX0FMTF9DTFVCUyk7XG4gICAgICBleHBlY3QoY2FwYWJpbGl0aWVzKS50b0hhdmVMZW5ndGgoMik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdyYW50IG5vIHN5c3RlbSBjYXBhYmlsaXRpZXMgdG8gcmVndWxhciB1c2VycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCA9IHtcbiAgICAgICAgdXNlcklkOiAndGVzdC11c2VyJyxcbiAgICAgICAgZW1haWw6ICd1c2VyQGV4YW1wbGUuY29tJyxcbiAgICAgICAgc3lzdGVtUm9sZTogU3lzdGVtUm9sZS5VU0VSLFxuICAgICAgICBpc0F1dGhlbnRpY2F0ZWQ6IHRydWUsXG4gICAgICAgIGlzU2l0ZUFkbWluOiBmYWxzZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGNhcGFiaWxpdGllcyA9IGF3YWl0IGNhcGFiaWxpdHlSZXNvbHZlci5kZXJpdmVDYXBhYmlsaXRpZXMoYXV0aENvbnRleHQpO1xuXG4gICAgICBleHBlY3QoY2FwYWJpbGl0aWVzKS50b0hhdmVMZW5ndGgoMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBpbnZhbGlkIHN5c3RlbSByb2xlIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhdXRoQ29udGV4dDogQXV0aENvbnRleHQgPSB7XG4gICAgICAgIHVzZXJJZDogJ3Rlc3QtdXNlcicsXG4gICAgICAgIGVtYWlsOiAndXNlckBleGFtcGxlLmNvbScsXG4gICAgICAgIHN5c3RlbVJvbGU6ICdJTlZBTElEX1JPTEUnIGFzIFN5c3RlbVJvbGUsXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogdHJ1ZSxcbiAgICAgICAgaXNTaXRlQWRtaW46IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgY2FwYWJpbGl0aWVzID0gYXdhaXQgY2FwYWJpbGl0eVJlc29sdmVyLmRlcml2ZUNhcGFiaWxpdGllcyhhdXRoQ29udGV4dCk7XG5cbiAgICAgIGV4cGVjdChjYXBhYmlsaXRpZXMpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2hhc0NhcGFiaWxpdHknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSBmb3IgU2l0ZUFkbWluIHdpdGggTUFOQUdFX1BMQVRGT1JNJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gY2FwYWJpbGl0eVJlc29sdmVyLmhhc0NhcGFiaWxpdHkoXG4gICAgICAgIFN5c3RlbVJvbGUuU0lURV9BRE1JTixcbiAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk1cbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiB0cnVlIGZvciBTaXRlQWRtaW4gd2l0aCBNQU5BR0VfQUxMX0NMVUJTJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gY2FwYWJpbGl0eVJlc29sdmVyLmhhc0NhcGFiaWxpdHkoXG4gICAgICAgIFN5c3RlbVJvbGUuU0lURV9BRE1JTixcbiAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfQUxMX0NMVUJTXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2UgZm9yIHJlZ3VsYXIgdXNlciB3aXRoIE1BTkFHRV9QTEFURk9STScsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGNhcGFiaWxpdHlSZXNvbHZlci5oYXNDYXBhYmlsaXR5KFxuICAgICAgICBTeXN0ZW1Sb2xlLlVTRVIsXG4gICAgICAgIFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX1BMQVRGT1JNXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciByZWd1bGFyIHVzZXIgd2l0aCBNQU5BR0VfQUxMX0NMVUJTJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gY2FwYWJpbGl0eVJlc29sdmVyLmhhc0NhcGFiaWxpdHkoXG4gICAgICAgIFN5c3RlbVJvbGUuVVNFUixcbiAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfQUxMX0NMVUJTXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2lzVmFsaWRDYXBhYmlsaXR5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgZm9yIHZhbGlkIGNhcGFiaWxpdGllcycsICgpID0+IHtcbiAgICAgIGV4cGVjdChjYXBhYmlsaXR5UmVzb2x2ZXIuaXNWYWxpZENhcGFiaWxpdHkoJ21hbmFnZV9wbGF0Zm9ybScpKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KGNhcGFiaWxpdHlSZXNvbHZlci5pc1ZhbGlkQ2FwYWJpbGl0eSgnbWFuYWdlX2FsbF9jbHVicycpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2UgZm9yIGludmFsaWQgY2FwYWJpbGl0aWVzJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KGNhcGFiaWxpdHlSZXNvbHZlci5pc1ZhbGlkQ2FwYWJpbGl0eSgnaW52YWxpZF9jYXBhYmlsaXR5JykpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KGNhcGFiaWxpdHlSZXNvbHZlci5pc1ZhbGlkQ2FwYWJpbGl0eSgnJykpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0QWxsQ2FwYWJpbGl0aWVzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGFsbCBzeXN0ZW0gY2FwYWJpbGl0aWVzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eVJlc29sdmVyLmdldEFsbENhcGFiaWxpdGllcygpO1xuXG4gICAgICBleHBlY3QoY2FwYWJpbGl0aWVzKS50b0NvbnRhaW4oU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfUExBVEZPUk0pO1xuICAgICAgZXhwZWN0KGNhcGFiaWxpdGllcykudG9Db250YWluKFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX0FMTF9DTFVCUyk7XG4gICAgICBleHBlY3QoY2FwYWJpbGl0aWVzKS50b0hhdmVMZW5ndGgoMik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRDYXBhYmlsaXR5TWF0cml4JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvbXBsZXRlIGNhcGFiaWxpdHkgbWF0cml4JywgKCkgPT4ge1xuICAgICAgY29uc3QgbWF0cml4ID0gY2FwYWJpbGl0eVJlc29sdmVyLmdldENhcGFiaWxpdHlNYXRyaXgoKTtcblxuICAgICAgZXhwZWN0KG1hdHJpeFtTeXN0ZW1Sb2xlLlVTRVJdKS50b0VxdWFsKFtdKTtcbiAgICAgIGV4cGVjdChtYXRyaXhbU3lzdGVtUm9sZS5TSVRFX0FETUlOXSkudG9Db250YWluKFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX1BMQVRGT1JNKTtcbiAgICAgIGV4cGVjdChtYXRyaXhbU3lzdGVtUm9sZS5TSVRFX0FETUlOXSkudG9Db250YWluKFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX0FMTF9DTFVCUyk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il19