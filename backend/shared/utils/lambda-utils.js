"use strict";
/**
 * Lambda Utilities - Phase 1.2
 *
 * Utilities for Lambda function responses, error handling, and common
 * Lambda patterns.
 *
 * Compliance:
 * - Phase 1.2 Spec: .kiro/specs/phase-1.2.user-profile.v1.md
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.logStructured = exports.handleLambdaError = exports.createInternalErrorResponse = exports.createNotFoundResponse = exports.createForbiddenResponse = exports.createUnauthorizedResponse = exports.createValidationErrorResponse = exports.createErrorResponse = exports.createSuccessResponse = exports.parseJsonBody = exports.parseJSON = exports.createResponse = void 0;
const api_1 = require("../types/api");
/**
 * Get CORS headers based on the request origin
 * Supports both localhost and Vercel deployments
 */
function getCorsHeaders(origin) {
    // List of allowed origins
    const allowedOrigins = [
        'http://localhost:3000',
        'http://127.0.0.1:3000',
        'https://collective-rides-frontend.vercel.app',
        'https://sydneycycles.com',
        'https://collectiverides.com',
    ];
    // Check if the origin is allowed
    const allowOrigin = origin && allowedOrigins.includes(origin)
        ? origin
        : allowedOrigins[0]; // Default to localhost
    return {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': allowOrigin,
        'Access-Control-Allow-Credentials': 'true',
        'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent',
        'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',
    };
}
/**
 * Create a generic API response
 *
 * @param statusCode - HTTP status code
 * @param body - Response body
 * @param origin - Request origin for CORS
 * @returns API Gateway proxy result
 */
function createResponse(statusCode, body, origin) {
    return {
        statusCode,
        headers: getCorsHeaders(origin),
        body: JSON.stringify(body),
    };
}
exports.createResponse = createResponse;
/**
 * Parse JSON from request body with error handling
 *
 * @param body - Request body string
 * @returns Parsed JSON object
 */
function parseJSON(body) {
    if (!body) {
        throw new Error('Request body is required');
    }
    try {
        return JSON.parse(body);
    }
    catch (error) {
        throw new Error('Invalid JSON in request body');
    }
}
exports.parseJSON = parseJSON;
/**
 * Parse JSON from API Gateway event body
 *
 * @param event - API Gateway proxy event
 * @returns Parsed JSON object
 */
function parseJsonBody(event) {
    return parseJSON(event.body);
}
exports.parseJsonBody = parseJsonBody;
/**
 * Create a successful API response
 *
 * @param data - Response data
 * @param statusCode - HTTP status code (default: 200)
 * @param origin - Request origin for CORS
 * @returns API Gateway proxy result
 */
function createSuccessResponse(data, statusCode = api_1.HttpStatusCode.OK, origin) {
    const response = {
        success: true,
        data,
        timestamp: new Date().toISOString(),
    };
    return {
        statusCode,
        headers: getCorsHeaders(origin),
        body: JSON.stringify(response),
    };
}
exports.createSuccessResponse = createSuccessResponse;
/**
 * Create an error API response
 *
 * @param error - Error type
 * @param message - Error message
 * @param statusCode - HTTP status code
 * @param requestId - Optional request ID
 * @param origin - Request origin for CORS
 * @returns API Gateway proxy result
 */
function createErrorResponse(error, message, statusCode, requestId, origin) {
    const response = {
        error,
        message,
        timestamp: new Date().toISOString(),
        requestId,
    };
    return {
        statusCode,
        headers: getCorsHeaders(origin),
        body: JSON.stringify(response),
    };
}
exports.createErrorResponse = createErrorResponse;
/**
 * Create a validation error response
 *
 * @param message - Validation error message
 * @param requestId - Optional request ID
 * @returns API Gateway proxy result
 */
function createValidationErrorResponse(message, requestId) {
    return createErrorResponse(api_1.ApiErrorType.VALIDATION_ERROR, message, api_1.HttpStatusCode.BAD_REQUEST, requestId);
}
exports.createValidationErrorResponse = createValidationErrorResponse;
/**
 * Create an unauthorized error response
 *
 * @param message - Error message (default: 'Unauthorized')
 * @param requestId - Optional request ID
 * @returns API Gateway proxy result
 */
function createUnauthorizedResponse(message = 'Unauthorized', requestId) {
    return createErrorResponse(api_1.ApiErrorType.UNAUTHORIZED, message, api_1.HttpStatusCode.UNAUTHORIZED, requestId);
}
exports.createUnauthorizedResponse = createUnauthorizedResponse;
/**
 * Create a forbidden error response
 *
 * @param message - Error message (default: 'Forbidden')
 * @param requestId - Optional request ID
 * @returns API Gateway proxy result
 */
function createForbiddenResponse(message = 'Forbidden', requestId) {
    return createErrorResponse(api_1.ApiErrorType.FORBIDDEN, message, api_1.HttpStatusCode.FORBIDDEN, requestId);
}
exports.createForbiddenResponse = createForbiddenResponse;
/**
 * Create a not found error response
 *
 * @param message - Error message (default: 'Not found')
 * @param requestId - Optional request ID
 * @returns API Gateway proxy result
 */
function createNotFoundResponse(message = 'Not found', requestId) {
    return createErrorResponse(api_1.ApiErrorType.NOT_FOUND, message, api_1.HttpStatusCode.NOT_FOUND, requestId);
}
exports.createNotFoundResponse = createNotFoundResponse;
/**
 * Create an internal server error response
 *
 * @param message - Error message (default: 'Internal server error')
 * @param requestId - Optional request ID
 * @returns API Gateway proxy result
 */
function createInternalErrorResponse(message = 'Internal server error', requestId) {
    return createErrorResponse(api_1.ApiErrorType.INTERNAL_ERROR, message, api_1.HttpStatusCode.INTERNAL_SERVER_ERROR, requestId);
}
exports.createInternalErrorResponse = createInternalErrorResponse;
/**
 * Handle Lambda function errors and convert to appropriate HTTP responses
 *
 * @param error - Error object
 * @param requestId - Request ID for logging
 * @returns API Gateway proxy result
 */
function handleLambdaError(error, requestId) {
    console.error('Lambda error:', error, { requestId });
    if (error instanceof Error) {
        const message = error.message;
        // Map specific error messages to HTTP status codes
        if (message.includes('Authentication required') || message.includes('JWT')) {
            return createUnauthorizedResponse(message, requestId);
        }
        if (message.includes('privileges required') || message.includes('Forbidden')) {
            return createForbiddenResponse(message, requestId);
        }
        if (message.includes('not found') || message.includes('Not found')) {
            return createNotFoundResponse(message, requestId);
        }
        if (message.includes('validation') || message.includes('Invalid')) {
            return createValidationErrorResponse(message, requestId);
        }
    }
    // Default to internal server error
    return createInternalErrorResponse('An unexpected error occurred', requestId);
}
exports.handleLambdaError = handleLambdaError;
/**
 * Log structured information for CloudWatch
 *
 * @param level - Log level
 * @param message - Log message
 * @param context - Additional context
 */
function logStructured(level, message, context = {}) {
    const logEntry = {
        timestamp: new Date().toISOString(),
        level,
        message,
        ...context,
    };
    console.log(JSON.stringify(logEntry));
}
exports.logStructured = logStructured;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGFtYmRhLXV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7O0FBR0gsc0NBQXdGO0FBRXhGOzs7R0FHRztBQUNILFNBQVMsY0FBYyxDQUFDLE1BQWU7SUFDckMsMEJBQTBCO0lBQzFCLE1BQU0sY0FBYyxHQUFHO1FBQ3JCLHVCQUF1QjtRQUN2Qix1QkFBdUI7UUFDdkIsOENBQThDO1FBQzlDLDBCQUEwQjtRQUMxQiw2QkFBNkI7S0FDOUIsQ0FBQztJQUVGLGlDQUFpQztJQUNqQyxNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDM0QsQ0FBQyxDQUFDLE1BQU07UUFDUixDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCO0lBRTlDLE9BQU87UUFDTCxjQUFjLEVBQUUsa0JBQWtCO1FBQ2xDLDZCQUE2QixFQUFFLFdBQVc7UUFDMUMsa0NBQWtDLEVBQUUsTUFBTTtRQUMxQyw4QkFBOEIsRUFBRSx1RkFBdUY7UUFDdkgsOEJBQThCLEVBQUUsNkJBQTZCO0tBQzlELENBQUM7QUFDSixDQUFDO0FBRUQ7Ozs7Ozs7R0FPRztBQUNILFNBQWdCLGNBQWMsQ0FDNUIsVUFBa0IsRUFDbEIsSUFBUyxFQUNULE1BQWU7SUFFZixPQUFPO1FBQ0wsVUFBVTtRQUNWLE9BQU8sRUFBRSxjQUFjLENBQUMsTUFBTSxDQUFDO1FBQy9CLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztLQUMzQixDQUFDO0FBQ0osQ0FBQztBQVZELHdDQVVDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixTQUFTLENBQUksSUFBbUI7SUFDOUMsSUFBSSxDQUFDLElBQUksRUFBRTtRQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztLQUM3QztJQUVE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K0IsRUFBRTtJQUVqQyxNQUFNLFFBQVEsR0FBRztRQUNmLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtRQUNuQyxLQUFLO1FBQ0wsT0FBTztRQUNQLEdBQUcsT0FBTztLQUNYLENBQUM7SUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUN4QyxDQUFDO0FBYkQsc0NBYUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIExhbWJkYSBVdGlsaXRpZXMgLSBQaGFzZSAxLjJcbiAqIFxuICogVXRpbGl0aWVzIGZvciBMYW1iZGEgZnVuY3Rpb24gcmVzcG9uc2VzLCBlcnJvciBoYW5kbGluZywgYW5kIGNvbW1vblxuICogTGFtYmRhIHBhdHRlcm5zLlxuICogXG4gKiBDb21wbGlhbmNlOlxuICogLSBQaGFzZSAxLjIgU3BlYzogLmtpcm8vc3BlY3MvcGhhc2UtMS4yLnVzZXItcHJvZmlsZS52MS5tZFxuICovXG5cbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQXBpUmVzcG9uc2UsIEVycm9yUmVzcG9uc2UsIEh0dHBTdGF0dXNDb2RlLCBBcGlFcnJvclR5cGUgfSBmcm9tICcuLi90eXBlcy9hcGknO1xuXG4vKipcbiAqIEdldCBDT1JTIGhlYWRlcnMgYmFzZWQgb24gdGhlIHJlcXVlc3Qgb3JpZ2luXG4gKiBTdXBwb3J0cyBib3RoIGxvY2FsaG9zdCBhbmQgVmVyY2VsIGRlcGxveW1lbnRzXG4gKi9cbmZ1bmN0aW9uIGdldENvcnNIZWFkZXJzKG9yaWdpbj86IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4ge1xuICAvLyBMaXN0IG9mIGFsbG93ZWQgb3JpZ2luc1xuICBjb25zdCBhbGxvd2VkT3JpZ2lucyA9IFtcbiAgICAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICAnaHR0cDovLzEyNy4wLjAuMTozMDAwJyxcbiAgICAnaHR0cHM6Ly9jb2xsZWN0aXZlLXJpZGVzLWZyb250ZW5kLnZlcmNlbC5hcHAnLFxuICAgICdodHRwczovL3N5ZG5leWN5Y2xlcy5jb20nLFxuICAgICdodHRwczovL2NvbGxlY3RpdmVyaWRlcy5jb20nLFxuICBdO1xuICBcbiAgLy8gQ2hlY2sgaWYgdGhlIG9yaWdpbiBpcyBhbGxvd2VkXG4gIGNvbnN0IGFsbG93T3JpZ2luID0gb3JpZ2luICYmIGFsbG93ZWRPcmlnaW5zLmluY2x1ZGVzKG9yaWdpbikgXG4gICAgPyBvcmlnaW4gXG4gICAgOiBhbGxvd2VkT3JpZ2luc1swXTsgLy8gRGVmYXVsdCB0byBsb2NhbGhvc3RcbiAgXG4gIHJldHVybiB7XG4gICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogYWxsb3dPcmlnaW4sXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUNyZWRlbnRpYWxzJzogJ3RydWUnLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxYLUFtei1EYXRlLEF1dGhvcml6YXRpb24sWC1BcGktS2V5LFgtQW16LVNlY3VyaXR5LVRva2VuLFgtQW16LVVzZXItQWdlbnQnLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxQT1NULFBVVCxERUxFVEUsT1BUSU9OUycsXG4gIH07XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgZ2VuZXJpYyBBUEkgcmVzcG9uc2VcbiAqIFxuICogQHBhcmFtIHN0YXR1c0NvZGUgLSBIVFRQIHN0YXR1cyBjb2RlXG4gKiBAcGFyYW0gYm9keSAtIFJlc3BvbnNlIGJvZHlcbiAqIEBwYXJhbSBvcmlnaW4gLSBSZXF1ZXN0IG9yaWdpbiBmb3IgQ09SU1xuICogQHJldHVybnMgQVBJIEdhdGV3YXkgcHJveHkgcmVzdWx0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSZXNwb25zZShcbiAgc3RhdHVzQ29kZTogbnVtYmVyLFxuICBib2R5OiBhbnksXG4gIG9yaWdpbj86IHN0cmluZ1xuKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlLFxuICAgIGhlYWRlcnM6IGdldENvcnNIZWFkZXJzKG9yaWdpbiksXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoYm9keSksXG4gIH07XG59XG5cbi8qKlxuICogUGFyc2UgSlNPTiBmcm9tIHJlcXVlc3QgYm9keSB3aXRoIGVycm9yIGhhbmRsaW5nXG4gKiBcbiAqIEBwYXJhbSBib2R5IC0gUmVxdWVzdCBib2R5IHN0cmluZ1xuICogQHJldHVybnMgUGFyc2VkIEpTT04gb2JqZWN0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUpTT048VD4oYm9keTogc3RyaW5nIHwgbnVsbCk6IFQge1xuICBpZiAoIWJvZHkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYm9keSBpcyByZXF1aXJlZCcpO1xuICB9XG4gIFxuICB0cnkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKGJvZHkpIGFzIFQ7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5Jyk7XG4gIH1cbn1cblxuLyoqXG4gKiBQYXJzZSBKU09OIGZyb20gQVBJIEdhdGV3YXkgZXZlbnQgYm9keVxuICogXG4gKiBAcGFyYW0gZXZlbnQgLSBBUEkgR2F0ZXdheSBwcm94eSBldmVudFxuICogQHJldHVybnMgUGFyc2VkIEpTT04gb2JqZWN0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUpzb25Cb2R5PFQ+KGV2ZW50OiB7IGJvZHk6IHN0cmluZyB8IG51bGwgfSk6IFQge1xuICByZXR1cm4gcGFyc2VKU09OPFQ+KGV2ZW50LmJvZHkpO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIHN1Y2Nlc3NmdWwgQVBJIHJlc3BvbnNlXG4gKiBcbiAqIEBwYXJhbSBkYXRhIC0gUmVzcG9uc2UgZGF0YVxuICogQHBhcmFtIHN0YXR1c0NvZGUgLSBIVFRQIHN0YXR1cyBjb2RlIChkZWZhdWx0OiAyMDApXG4gKiBAcGFyYW0gb3JpZ2luIC0gUmVxdWVzdCBvcmlnaW4gZm9yIENPUlNcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IHByb3h5IHJlc3VsdFxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU3VjY2Vzc1Jlc3BvbnNlPFQ+KFxuICBkYXRhOiBULFxuICBzdGF0dXNDb2RlOiBIdHRwU3RhdHVzQ29kZSA9IEh0dHBTdGF0dXNDb2RlLk9LLFxuICBvcmlnaW4/OiBzdHJpbmdcbik6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XG4gIGNvbnN0IHJlc3BvbnNlOiBBcGlSZXNwb25zZTxUPiA9IHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGRhdGEsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gIH07XG4gIFxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGUsXG4gICAgaGVhZGVyczogZ2V0Q29yc0hlYWRlcnMob3JpZ2luKSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSksXG4gIH07XG59XG5cbi8qKlxuICogQ3JlYXRlIGFuIGVycm9yIEFQSSByZXNwb25zZVxuICogXG4gKiBAcGFyYW0gZXJyb3IgLSBFcnJvciB0eXBlXG4gKiBAcGFyYW0gbWVzc2FnZSAtIEVycm9yIG1lc3NhZ2VcbiAqIEBwYXJhbSBzdGF0dXNDb2RlIC0gSFRUUCBzdGF0dXMgY29kZVxuICogQHBhcmFtIHJlcXVlc3RJZCAtIE9wdGlvbmFsIHJlcXVlc3QgSURcbiAqIEBwYXJhbSBvcmlnaW4gLSBSZXF1ZXN0IG9yaWdpbiBmb3IgQ09SU1xuICogQHJldHVybnMgQVBJIEdhdGV3YXkgcHJveHkgcmVzdWx0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFcnJvclJlc3BvbnNlKFxuICBlcnJvcjogQXBpRXJyb3JUeXBlIHwgc3RyaW5nLFxuICBtZXNzYWdlOiBzdHJpbmcsXG4gIHN0YXR1c0NvZGU6IEh0dHBTdGF0dXNDb2RlLFxuICByZXF1ZXN0SWQ/OiBzdHJpbmcsXG4gIG9yaWdpbj86IHN0cmluZ1xuKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcbiAgY29uc3QgcmVzcG9uc2U6IEVycm9yUmVzcG9uc2UgPSB7XG4gICAgZXJyb3IsXG4gICAgbWVzc2FnZSxcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICByZXF1ZXN0SWQsXG4gIH07XG4gIFxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGUsXG4gICAgaGVhZGVyczogZ2V0Q29yc0hlYWRlcnMob3JpZ2luKSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSksXG4gIH07XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgdmFsaWRhdGlvbiBlcnJvciByZXNwb25zZVxuICogXG4gKiBAcGFyYW0gbWVzc2FnZSAtIFZhbGlkYXRpb24gZXJyb3IgbWVzc2FnZVxuICogQHBhcmFtIHJlcXVlc3RJZCAtIE9wdGlvbmFsIHJlcXVlc3QgSURcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IHByb3h5IHJlc3VsdFxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlVmFsaWRhdGlvbkVycm9yUmVzcG9uc2UoXG4gIG1lc3NhZ2U6IHN0cmluZyxcbiAgcmVxdWVzdElkPzogc3RyaW5nXG4pOiBBUElHYXRld2F5UHJveHlSZXN1bHQge1xuICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZShcbiAgICBBcGlFcnJvclR5cGUuVkFMSURBVElPTl9FUlJPUixcbiAgICBtZXNzYWdlLFxuICAgIEh0dHBTdGF0dXNDb2RlLkJBRF9SRVFVRVNULFxuICAgIHJlcXVlc3RJZFxuICApO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhbiB1bmF1dGhvcml6ZWQgZXJyb3IgcmVzcG9uc2VcbiAqIFxuICogQHBhcmFtIG1lc3NhZ2UgLSBFcnJvciBtZXNzYWdlIChkZWZhdWx0OiAnVW5hdXRob3JpemVkJylcbiAqIEBwYXJhbSByZXF1ZXN0SWQgLSBPcHRpb25hbCByZXF1ZXN0IElEXG4gKiBAcmV0dXJucyBBUEkgR2F0ZXdheSBwcm94eSByZXN1bHRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVVuYXV0aG9yaXplZFJlc3BvbnNlKFxuICBtZXNzYWdlOiBzdHJpbmcgPSAnVW5hdXRob3JpemVkJyxcbiAgcmVxdWVzdElkPzogc3RyaW5nXG4pOiBBUElHYXRld2F5UHJveHlSZXN1bHQge1xuICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZShcbiAgICBBcGlFcnJvclR5cGUuVU5BVVRIT1JJWkVELFxuICAgIG1lc3NhZ2UsXG4gICAgSHR0cFN0YXR1c0NvZGUuVU5BVVRIT1JJWkVELFxuICAgIHJlcXVlc3RJZFxuICApO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIGZvcmJpZGRlbiBlcnJvciByZXNwb25zZVxuICogXG4gKiBAcGFyYW0gbWVzc2FnZSAtIEVycm9yIG1lc3NhZ2UgKGRlZmF1bHQ6ICdGb3JiaWRkZW4nKVxuICogQHBhcmFtIHJlcXVlc3RJZCAtIE9wdGlvbmFsIHJlcXVlc3QgSURcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IHByb3h5IHJlc3VsdFxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRm9yYmlkZGVuUmVzcG9uc2UoXG4gIG1lc3NhZ2U6IHN0cmluZyA9ICdGb3JiaWRkZW4nLFxuICByZXF1ZXN0SWQ/OiBzdHJpbmdcbik6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XG4gIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKFxuICAgIEFwaUVycm9yVHlwZS5GT1JCSURERU4sXG4gICAgbWVzc2FnZSxcbiAgICBIdHRwU3RhdHVzQ29kZS5GT1JCSURERU4sXG4gICAgcmVxdWVzdElkXG4gICk7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgbm90IGZvdW5kIGVycm9yIHJlc3BvbnNlXG4gKiBcbiAqIEBwYXJhbSBtZXNzYWdlIC0gRXJyb3IgbWVzc2FnZSAoZGVmYXVsdDogJ05vdCBmb3VuZCcpXG4gKiBAcGFyYW0gcmVxdWVzdElkIC0gT3B0aW9uYWwgcmVxdWVzdCBJRFxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgcHJveHkgcmVzdWx0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVOb3RGb3VuZFJlc3BvbnNlKFxuICBtZXNzYWdlOiBzdHJpbmcgPSAnTm90IGZvdW5kJyxcbiAgcmVxdWVzdElkPzogc3RyaW5nXG4pOiBBUElHYXRld2F5UHJveHlSZXN1bHQge1xuICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZShcbiAgICBBcGlFcnJvclR5cGUuTk9UX0ZPVU5ELFxuICAgIG1lc3NhZ2UsXG4gICAgSHR0cFN0YXR1c0NvZGUuTk9UX0ZPVU5ELFxuICAgIHJlcXVlc3RJZFxuICApO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhbiBpbnRlcm5hbCBzZXJ2ZXIgZXJyb3IgcmVzcG9uc2VcbiAqIFxuICogQHBhcmFtIG1lc3NhZ2UgLSBFcnJvciBtZXNzYWdlIChkZWZhdWx0OiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJylcbiAqIEBwYXJhbSByZXF1ZXN0SWQgLSBPcHRpb25hbCByZXF1ZXN0IElEXG4gKiBAcmV0dXJucyBBUEkgR2F0ZXdheSBwcm94eSByZXN1bHRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUludGVybmFsRXJyb3JSZXNwb25zZShcbiAgbWVzc2FnZTogc3RyaW5nID0gJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gIHJlcXVlc3RJZD86IHN0cmluZ1xuKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcbiAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoXG4gICAgQXBpRXJyb3JUeXBlLklOVEVSTkFMX0VSUk9SLFxuICAgIG1lc3NhZ2UsXG4gICAgSHR0cFN0YXR1c0NvZGUuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgIHJlcXVlc3RJZFxuICApO1xufVxuXG4vKipcbiAqIEhhbmRsZSBMYW1iZGEgZnVuY3Rpb24gZXJyb3JzIGFuZCBjb252ZXJ0IHRvIGFwcHJvcHJpYXRlIEhUVFAgcmVzcG9uc2VzXG4gKiBcbiAqIEBwYXJhbSBlcnJvciAtIEVycm9yIG9iamVjdFxuICogQHBhcmFtIHJlcXVlc3RJZCAtIFJlcXVlc3QgSUQgZm9yIGxvZ2dpbmdcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IHByb3h5IHJlc3VsdFxuICovXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlTGFtYmRhRXJyb3IoZXJyb3I6IHVua25vd24sIHJlcXVlc3RJZD86IHN0cmluZyk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XG4gIGNvbnNvbGUuZXJyb3IoJ0xhbWJkYSBlcnJvcjonLCBlcnJvciwgeyByZXF1ZXN0SWQgfSk7XG4gIFxuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgIFxuICAgIC8vIE1hcCBzcGVjaWZpYyBlcnJvciBtZXNzYWdlcyB0byBIVFRQIHN0YXR1cyBjb2Rlc1xuICAgIGlmIChtZXNzYWdlLmluY2x1ZGVzKCdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcpIHx8IG1lc3NhZ2UuaW5jbHVkZXMoJ0pXVCcpKSB7XG4gICAgICByZXR1cm4gY3JlYXRlVW5hdXRob3JpemVkUmVzcG9uc2UobWVzc2FnZSwgcmVxdWVzdElkKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKG1lc3NhZ2UuaW5jbHVkZXMoJ3ByaXZpbGVnZXMgcmVxdWlyZWQnKSB8fCBtZXNzYWdlLmluY2x1ZGVzKCdGb3JiaWRkZW4nKSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUZvcmJpZGRlblJlc3BvbnNlKG1lc3NhZ2UsIHJlcXVlc3RJZCk7XG4gICAgfVxuICAgIFxuICAgIGlmIChtZXNzYWdlLmluY2x1ZGVzKCdub3QgZm91bmQnKSB8fCBtZXNzYWdlLmluY2x1ZGVzKCdOb3QgZm91bmQnKSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZU5vdEZvdW5kUmVzcG9uc2UobWVzc2FnZSwgcmVxdWVzdElkKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKG1lc3NhZ2UuaW5jbHVkZXMoJ3ZhbGlkYXRpb24nKSB8fCBtZXNzYWdlLmluY2x1ZGVzKCdJbnZhbGlkJykpIHtcbiAgICAgIHJldHVybiBjcmVhdGVWYWxpZGF0aW9uRXJyb3JSZXNwb25zZShtZXNzYWdlLCByZXF1ZXN0SWQpO1xuICAgIH1cbiAgfVxuICBcbiAgLy8gRGVmYXVsdCB0byBpbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcbiAgcmV0dXJuIGNyZWF0ZUludGVybmFsRXJyb3JSZXNwb25zZSgnQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZCcsIHJlcXVlc3RJZCk7XG59XG5cbi8qKlxuICogTG9nIHN0cnVjdHVyZWQgaW5mb3JtYXRpb24gZm9yIENsb3VkV2F0Y2hcbiAqIFxuICogQHBhcmFtIGxldmVsIC0gTG9nIGxldmVsXG4gKiBAcGFyYW0gbWVzc2FnZSAtIExvZyBtZXNzYWdlXG4gKiBAcGFyYW0gY29udGV4dCAtIEFkZGl0aW9uYWwgY29udGV4dFxuICovXG5leHBvcnQgZnVuY3Rpb24gbG9nU3RydWN0dXJlZChcbiAgbGV2ZWw6ICdJTkZPJyB8ICdXQVJOJyB8ICdFUlJPUicsXG4gIG1lc3NhZ2U6IHN0cmluZyxcbiAgY29udGV4dDogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9XG4pOiB2b2lkIHtcbiAgY29uc3QgbG9nRW50cnkgPSB7XG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgbGV2ZWwsXG4gICAgbWVzc2FnZSxcbiAgICAuLi5jb250ZXh0LFxuICB9O1xuICBcbiAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkobG9nRW50cnkpKTtcbn0iXX0=