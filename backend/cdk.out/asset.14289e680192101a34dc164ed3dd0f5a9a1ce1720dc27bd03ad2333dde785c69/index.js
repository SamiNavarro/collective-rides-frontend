"use strict";var a=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var g=(t,e)=>{for(var r in e)a(t,r,{get:e[r],enumerable:!0})},E=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of x(e))!y.call(t,s)&&s!==r&&a(t,s,{get:()=>e[s],enumerable:!(n=f(e,s))||n.enumerable});return t};var I=t=>E(a({},"__esModule",{value:!0}),t);var U={};g(U,{handler:()=>h});module.exports=I(U);function i(t,e){return{statusCode:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS"},body:JSON.stringify(e)}}function c(t){let{claims:e}=t;if(!e)throw new Error("No JWT claims found in authorizer context");if(!e.sub)throw new Error("Missing required claim: sub");if(!e.email)throw new Error("Missing required claim: email");if(!e.iat)throw new Error("Missing required claim: iat");if(!e.exp)throw new Error("Missing required claim: exp");let r,n;if(typeof e.iat=="string"?/^\d+$/.test(e.iat)?r=parseInt(e.iat,10):r=Math.floor(new Date(e.iat).getTime()/1e3):r=Number(e.iat),typeof e.exp=="string"?/^\d+$/.test(e.exp)?n=parseInt(e.exp,10):n=Math.floor(new Date(e.exp).getTime()/1e3):n=Number(e.exp),isNaN(r)||isNaN(n))throw new Error("Invalid timestamp claims");let s=Math.floor(Date.now()/1e3);if(n<s)throw new Error("JWT token has expired");return{sub:e.sub,email:e.email,iat:r,exp:n,iss:e.iss||"",aud:e.aud||"","custom:system_role":e["custom:system_role"]}}function m(t){return t.sub}function l(t){return t.email}async function p(t){return w(t.requestContext)}function w(t){if(!t.authorizer)return{userId:"",email:"",systemRole:"User",isAuthenticated:!1,isSiteAdmin:!1};try{let e=c(t.authorizer),r=m(e),n=l(e),s="User";return{userId:r,email:n,systemRole:s,isAuthenticated:!0,isSiteAdmin:!1}}catch(e){throw new Error(`Failed to create auth context: ${e instanceof Error?e.message:"Unknown error"}`)}}var d=require("crypto");function A(t){let e=Date.now().toString(36),r=(0,d.randomBytes)(6).toString("hex");return`${t}_${e}_${r}`}var h=async t=>{try{let e=await p(t),r=process.env.STRAVA_CLIENT_ID,n=process.env.STRAVA_REDIRECT_URI;if(!r||!n)return i(500,{success:!1,error:"Strava integration not configured"});let u=`${A("strava_state")}:${e.userId}`,o=new URL("https://www.strava.com/oauth/authorize");o.searchParams.set("client_id",r),o.searchParams.set("redirect_uri",n),o.searchParams.set("response_type","code"),o.searchParams.set("scope","read,activity:read"),o.searchParams.set("state",u);let R={authUrl:o.toString(),state:u};return i(200,{success:!0,data:R})}catch(e){return console.error("Strava connect error:",e),i(500,{success:!1,error:e instanceof Error?e.message:"Failed to generate Strava connect URL"})}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
