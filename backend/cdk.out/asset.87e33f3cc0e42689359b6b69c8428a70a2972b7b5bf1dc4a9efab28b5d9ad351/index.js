"use strict";var a=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var g=(t,e)=>{for(var r in e)a(t,r,{get:e[r],enumerable:!0})},E=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of y(e))!x.call(t,o)&&o!==r&&a(t,o,{get:()=>e[o],enumerable:!(n=f(e,o))||n.enumerable});return t};var I=t=>E(a({},"__esModule",{value:!0}),t);var T={};g(T,{handler:()=>h});module.exports=I(T);function s(t,e){return{statusCode:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS"},body:JSON.stringify(e)}}function l(t){let{claims:e}=t;if(!e)throw new Error("No JWT claims found in authorizer context");if(!e.sub)throw new Error("Missing required claim: sub");if(!e.email)throw new Error("Missing required claim: email");if(!e.iat)throw new Error("Missing required claim: iat");if(!e.exp)throw new Error("Missing required claim: exp");let r,n;if(typeof e.iat=="string"?/^\d+$/.test(e.iat)?r=parseInt(e.iat,10):r=Math.floor(new Date(e.iat).getTime()/1e3):r=Number(e.iat),typeof e.exp=="string"?/^\d+$/.test(e.exp)?n=parseInt(e.exp,10):n=Math.floor(new Date(e.exp).getTime()/1e3):n=Number(e.exp),isNaN(r)||isNaN(n))throw new Error("Invalid timestamp claims");let o=Math.floor(Date.now()/1e3);if(n<o)throw new Error("JWT token has expired");return{sub:e.sub,email:e.email,iat:r,exp:n,iss:e.iss||"",aud:e.aud||"","custom:system_role":e["custom:system_role"]}}function m(t){return t.sub}function d(t){return t.email}async function p(t){return w(t.requestContext)}function w(t){if(!t.authorizer)return{userId:"",email:"",systemRole:"User",isAuthenticated:!1,isSiteAdmin:!1};try{let e=l(t.authorizer),r=m(e),n=d(e),o="User";return{userId:r,email:n,systemRole:o,isAuthenticated:!0,isSiteAdmin:!1}}catch(e){throw new Error(`Failed to create auth context: ${e instanceof Error?e.message:"Unknown error"}`)}}var h=async t=>{try{let e=await p(t),r=t.queryStringParameters?.code,n=t.queryStringParameters?.state;if(!r||!n)return s(400,{success:!1,error:"Missing code or state parameter"});let[o,A]=n.split(":");if(A!==e.userId)return s(400,{success:!1,error:"Invalid state parameter"});let u=process.env.STRAVA_CLIENT_ID,c=process.env.STRAVA_CLIENT_SECRET;if(!u||!c)return s(500,{success:!1,error:"Strava integration not configured"});let i=await fetch("https://www.strava.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:u,client_secret:c,code:r,grant_type:"authorization_code"})});if(!i.ok)throw new Error(`Strava token exchange failed: ${i.status}`);let R=await i.json();return s(200,{success:!0,data:{athleteId:R.athlete.id.toString(),connectedAt:new Date().toISOString(),scopesGranted:["read","activity:read"]}})}catch(e){return console.error("Strava OAuth callback error:",e),s(400,{success:!1,error:e instanceof Error?e.message:"OAuth callback failed"})}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
