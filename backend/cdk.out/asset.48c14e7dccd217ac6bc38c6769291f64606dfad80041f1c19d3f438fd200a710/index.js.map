{
  "version": 3,
  "sources": ["../../services/strava-integration-service/handlers/webhook/webhook.ts"],
  "sourcesContent": ["import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { StravaWebhookEvent, StravaWebhookChallenge } from '../../../../shared/types/strava';\n\nexport const handler = async (\n  event: APIGatewayProxyEvent\n): Promise<APIGatewayProxyResult> => {\n  const method = event.httpMethod;\n  \n  if (method === 'GET') {\n    // Handle subscription verification challenge\n    return handleSubscriptionChallenge(event);\n  } else if (method === 'POST') {\n    // Handle webhook event\n    return handleWebhookEvent(event);\n  }\n  \n  return {\n    statusCode: 405,\n    body: JSON.stringify({\n      success: false,\n      error: 'Method not allowed'\n    })\n  };\n};\n\nasync function handleSubscriptionChallenge(\n  event: APIGatewayProxyEvent\n): Promise<APIGatewayProxyResult> {\n  const params = event.queryStringParameters;\n  \n  if (!params) {\n    return {\n      statusCode: 400,\n      body: JSON.stringify({\n        success: false,\n        error: 'Missing query parameters'\n      })\n    };\n  }\n\n  const mode = params['hub.mode'];\n  const challenge = params['hub.challenge'];\n  const verifyToken = params['hub.verify_token'];\n  \n  const expectedToken = process.env.STRAVA_WEBHOOK_VERIFY_TOKEN;\n  \n  if (mode === 'subscribe' && verifyToken === expectedToken) {\n    console.log('Strava webhook subscription verified');\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        'hub.challenge': challenge\n      })\n    };\n  }\n  \n  return {\n    statusCode: 403,\n    body: JSON.stringify({\n      success: false,\n      error: 'Forbidden'\n    })\n  };\n}\n\nasync function handleWebhookEvent(\n  event: APIGatewayProxyEvent\n): Promise<APIGatewayProxyResult> {\n  try {\n    // Verify webhook authenticity (implementation depends on Strava's verification method)\n    if (!verifyWebhookSignature(event)) {\n      return {\n        statusCode: 403,\n        body: JSON.stringify({\n          success: false,\n          error: 'Invalid webhook signature'\n        })\n      };\n    }\n\n    const webhookEvent: StravaWebhookEvent = JSON.parse(event.body || '{}');\n    \n    // Process webhook event asynchronously\n    await processWebhookEvent(webhookEvent);\n    \n    return {\n      statusCode: 200,\n      body: JSON.stringify({\n        success: true\n      })\n    };\n  } catch (error) {\n    console.error('Webhook processing error:', error);\n    return {\n      statusCode: 500,\n      body: JSON.stringify({\n        success: false,\n        error: 'Webhook processing failed'\n      })\n    };\n  }\n}\n\nfunction verifyWebhookSignature(event: APIGatewayProxyEvent): boolean {\n  // Implementation depends on Strava's webhook verification mechanism\n  // This is a placeholder that should be implemented based on Strava's documentation\n  \n  // For now, return true for development\n  // In production, this should verify the webhook signature\n  return true;\n}\n\nasync function processWebhookEvent(webhookEvent: StravaWebhookEvent): Promise<void> {\n  console.log('Processing Strava webhook event:', webhookEvent);\n  \n  // Only process activity events\n  if (webhookEvent.object_type !== 'activity') {\n    console.log('Ignoring non-activity webhook event');\n    return;\n  }\n  \n  // Handle different aspect types\n  switch (webhookEvent.aspect_type) {\n    case 'create':\n      await handleActivityCreated(webhookEvent);\n      break;\n    case 'update':\n      await handleActivityUpdated(webhookEvent);\n      break;\n    case 'delete':\n      await handleActivityDeleted(webhookEvent);\n      break;\n    default:\n      console.log(`Unhandled aspect type: ${webhookEvent.aspect_type}`);\n  }\n}\n\nasync function handleActivityCreated(webhookEvent: StravaWebhookEvent): Promise<void> {\n  console.log(`Activity created: ${webhookEvent.object_id} by athlete ${webhookEvent.owner_id}`);\n  \n  // TODO: Implement activity ingestion and matching\n  // 1. Fetch activity details from Strava API\n  // 2. Store activity in our database\n  // 3. Attempt to match with recent rides\n  // 4. Update participation evidence if matched\n}\n\nasync function handleActivityUpdated(webhookEvent: StravaWebhookEvent): Promise<void> {\n  console.log(`Activity updated: ${webhookEvent.object_id}`);\n  \n  // TODO: Update stored activity data\n  // Re-evaluate ride matching if relevant fields changed\n}\n\nasync function handleActivityDeleted(webhookEvent: StravaWebhookEvent): Promise<void> {\n  console.log(`Activity deleted: ${webhookEvent.object_id}`);\n  \n  // TODO: Remove activity from our database\n  // Remove evidence links if this activity was used as evidence\n}"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAGO,IAAME,EAAU,MACrBE,GACmC,CACnC,IAAMC,EAASD,EAAM,WAErB,OAAIC,IAAW,MAENC,EAA4BF,CAAK,EAC/BC,IAAW,OAEbE,EAAmBH,CAAK,EAG1B,CACL,WAAY,IACZ,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,MAAO,oBACT,CAAC,CACH,CACF,EAEA,eAAeE,EACbF,EACgC,CAChC,IAAMI,EAASJ,EAAM,sBAErB,GAAI,CAACI,EACH,MAAO,CACL,WAAY,IACZ,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,MAAO,0BACT,CAAC,CACH,EAGF,IAAMC,EAAOD,EAAO,UAAU,EACxBE,EAAYF,EAAO,eAAe,EAClCG,EAAcH,EAAO,kBAAkB,EAEvCI,EAAgB,QAAQ,IAAI,4BAElC,OAAIH,IAAS,aAAeE,IAAgBC,GAC1C,QAAQ,IAAI,sCAAsC,EAC3C,CACL,WAAY,IACZ,QAAS,CACP,eAAgB,kBAClB,EACA,KAAM,KAAK,UAAU,CACnB,gBAAiBF,CACnB,CAAC,CACH,GAGK,CACL,WAAY,IACZ,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,MAAO,WACT,CAAC,CACH,CACF,CAEA,eAAeH,EACbH,EACgC,CAChC,GAAI,CAEF,GAAI,CAACS,EAAuBT,CAAK,EAC/B,MAAO,CACL,WAAY,IACZ,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,MAAO,2BACT,CAAC,CACH,EAGF,IAAMU,EAAmC,KAAK,MAAMV,EAAM,MAAQ,IAAI,EAGtE,aAAMW,EAAoBD,CAAY,EAE/B,CACL,WAAY,IACZ,KAAM,KAAK,UAAU,CACnB,QAAS,EACX,CAAC,CACH,CACF,OAASE,EAAO,CACd,eAAQ,MAAM,4BAA6BA,CAAK,EACzC,CACL,WAAY,IACZ,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,MAAO,2BACT,CAAC,CACH,CACF,CACF,CAEA,SAASH,EAAuBT,EAAsC,CAMpE,MAAO,EACT,CAEA,eAAeW,EAAoBD,EAAiD,CAIlF,GAHA,QAAQ,IAAI,mCAAoCA,CAAY,EAGxDA,EAAa,cAAgB,WAAY,CAC3C,QAAQ,IAAI,qCAAqC,EACjD,MACF,CAGA,OAAQA,EAAa,YAAa,CAChC,IAAK,SACH,MAAMG,EAAsBH,CAAY,EACxC,MACF,IAAK,SACH,MAAMI,EAAsBJ,CAAY,EACxC,MACF,IAAK,SACH,MAAMK,EAAsBL,CAAY,EACxC,MACF,QACE,QAAQ,IAAI,0BAA0BA,EAAa,WAAW,EAAE,CACpE,CACF,CAEA,eAAeG,EAAsBH,EAAiD,CACpF,QAAQ,IAAI,qBAAqBA,EAAa,SAAS,eAAeA,EAAa,QAAQ,EAAE,CAO/F,CAEA,eAAeI,EAAsBJ,EAAiD,CACpF,QAAQ,IAAI,qBAAqBA,EAAa,SAAS,EAAE,CAI3D,CAEA,eAAeK,EAAsBL,EAAiD,CACpF,QAAQ,IAAI,qBAAqBA,EAAa,SAAS,EAAE,CAI3D",
  "names": ["webhook_exports", "__export", "handler", "__toCommonJS", "event", "method", "handleSubscriptionChallenge", "handleWebhookEvent", "params", "mode", "challenge", "verifyToken", "expectedToken", "verifyWebhookSignature", "webhookEvent", "processWebhookEvent", "error", "handleActivityCreated", "handleActivityUpdated", "handleActivityDeleted"]
}
