"use strict";
/**
 * Club Authorization System - Phase 2.2
 *
 * Club-level authorization middleware and capability checking.
 * Extends Phase 1.3 authorization with club-specific permissions.
 *
 * Compliance:
 * - Phase 2.2 Spec: .kiro/specs/phase-2.2.club-membership-roles.v1.md
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.requireClubCapabilityDynamic = exports.requireClubCapability = exports.ClubAuthorizationService = void 0;
const club_authorization_1 = require("../../../../shared/types/club-authorization");
const membership_1 = require("../../../../shared/types/membership");
const types_1 = require("../../../../shared/authorization/types");
const authorization_errors_1 = require("../../../../shared/authorization/authorization-errors");
/**
 * Club authorization service
 */
class ClubAuthorizationService {
    constructor(membershipRepository, authorizationService) {
        this.membershipRepository = membershipRepository;
        this.authorizationService = authorizationService;
    }
    /**
     * Create enhanced authorization context with club membership
     */
    async createClubAuthContext(authContext, clubId) {
        // Get user's club membership
        const membership = await this.membershipRepository.getMembershipByClubAndUser(clubId, authContext.userId);
        let clubCapabilities = [];
        let clubMembership = undefined;
        if (membership && membership.status === membership_1.MembershipStatus.ACTIVE) {
            clubCapabilities = (0, club_authorization_1.getCapabilitiesForRole)(membership.role);
            clubMembership = {
                membershipId: membership.membershipId,
                clubId: membership.clubId,
                role: membership.role,
                status: membership.status,
                joinedAt: membership.joinedAt,
            };
        }
        return {
            ...authContext,
            clubMembership,
            clubCapabilities,
        };
    }
    /**
     * Check if user has club capability
     */
    async hasClubCapability(authContext, clubId, capability) {
        try {
            await this.requireClubCapability(authContext, clubId, capability);
            return true;
        }
        catch {
            return false;
        }
    }
    /**
     * Require club capability (throws if not authorized)
     */
    async requireClubCapability(authContext, clubId, capability) {
        // Check system-level capabilities first (SiteAdmin override)
        const hasSystemOverride = await this.authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_ALL_CLUBS);
        if (hasSystemOverride) {
            return; // System admin has all club capabilities
        }
        // Get user's club membership (real-time check - no caching)
        const membership = await this.membershipRepository.getMembershipByClubAndUser(clubId, authContext.userId);
        if (!membership || membership.status !== membership_1.MembershipStatus.ACTIVE) {
            throw new authorization_errors_1.AuthorizationError(`Insufficient privileges: ${capability} required`, authorization_errors_1.AuthorizationErrorType.INSUFFICIENT_PRIVILEGES, 403, {
                capability: capability,
                userId: authContext.userId,
                resource: `club:${clubId}`,
            });
        }
        // Check club-level capability
        if (!(0, club_authorization_1.roleHasCapability)(membership.role, capability)) {
            const requiredRoles = [(0, club_authorization_1.getMinimumRoleForCapability)(capability)].filter(Boolean);
            throw new authorization_errors_1.AuthorizationError(`Insufficient privileges: ${capability} requires ${requiredRoles.join(' or ')} role`, authorization_errors_1.AuthorizationErrorType.INSUFFICIENT_PRIVILEGES, 403, {
                capability: capability,
                userId: authContext.userId,
                resource: `club:${clubId}`,
            });
        }
    }
    /**
     * Check if user can manage member (role hierarchy check)
     */
    async canManageMember(authContext, clubId, targetMemberRole) {
        // System admins can manage anyone
        const hasSystemOverride = await this.authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_ALL_CLUBS);
        if (hasSystemOverride) {
            return true;
        }
        // Get user's club membership
        const membership = await this.membershipRepository.getMembershipByClubAndUser(clubId, authContext.userId);
        if (!membership || membership.status !== membership_1.MembershipStatus.ACTIVE) {
            return false;
        }
        // Role hierarchy: Owner > Admin > Member
        const roleHierarchy = {
            [membership_1.ClubRole.MEMBER]: 1,
            [membership_1.ClubRole.ADMIN]: 2,
            [membership_1.ClubRole.OWNER]: 3,
        };
        const userLevel = roleHierarchy[membership.role];
        const targetLevel = roleHierarchy[targetMemberRole];
        // Can only manage members with lower or equal role level
        // Exception: Owners cannot be managed by anyone except system admins
        if (targetMemberRole === membership_1.ClubRole.OWNER) {
            return false; // Owners cannot be managed (ownership transfer required)
        }
        return userLevel >= targetLevel;
    }
    /**
     * Validate role assignment permissions
     */
    async validateRoleAssignment(authContext, clubId, targetRole) {
        // System admins can assign any role
        const hasSystemOverride = await this.authorizationService.hasSystemCapability(authContext, types_1.SystemCapability.MANAGE_ALL_CLUBS);
        if (hasSystemOverride) {
            return;
        }
        // Get user's club membership
        const membership = await this.membershipRepository.getMembershipByClubAndUser(clubId, authContext.userId);
        if (!membership || membership.status !== membership_1.MembershipStatus.ACTIVE) {
            throw new authorization_errors_1.AuthorizationError('Must be an active club member to assign roles', authorization_errors_1.AuthorizationErrorType.INSUFFICIENT_PRIVILEGES, 403, {
                userId: authContext.userId,
                resource: `club:${clubId}`,
            });
        }
        // Role assignment rules:
        // - Only owners can assign admin roles
        // - Admins and owners can assign member roles
        // - Nobody can assign owner roles (ownership transfer required)
        if (targetRole === membership_1.ClubRole.OWNER) {
            throw new authorization_errors_1.AuthorizationError('Cannot assign owner role - ownership transfer required', authorization_errors_1.AuthorizationErrorType.INSUFFICIENT_PRIVILEGES, 403, {
                userId: authContext.userId,
                resource: `club:${clubId}`,
            });
        }
        if (targetRole === membership_1.ClubRole.ADMIN && membership.role !== membership_1.ClubRole.OWNER) {
            throw new authorization_errors_1.AuthorizationError('Only club owners can assign admin roles', authorization_errors_1.AuthorizationErrorType.INSUFFICIENT_PRIVILEGES, 403, {
                userId: authContext.userId,
                resource: `club:${clubId}`,
            });
        }
        if (targetRole === membership_1.ClubRole.MEMBER && !this.isAdminOrOwner(membership.role)) {
            throw new authorization_errors_1.AuthorizationError('Only club admins and owners can assign member roles', authorization_errors_1.AuthorizationErrorType.INSUFFICIENT_PRIVILEGES, 403, {
                userId: authContext.userId,
                resource: `club:${clubId}`,
            });
        }
    }
    /**
     * Check if role is admin or owner
     */
    isAdminOrOwner(role) {
        return role === membership_1.ClubRole.ADMIN || role === membership_1.ClubRole.OWNER;
    }
}
exports.ClubAuthorizationService = ClubAuthorizationService;
/**
 * Create club authorization middleware function
 */
function requireClubCapability(capability, clubId, membershipRepository, authorizationService) {
    return async (authContext) => {
        const authService = new ClubAuthorizationService(membershipRepository, authorizationService);
        await authService.requireClubCapability(authContext, clubId, capability);
    };
}
exports.requireClubCapability = requireClubCapability;
/**
 * Create club authorization middleware with dynamic club ID
 */
function requireClubCapabilityDynamic(capability, membershipRepository, authorizationService) {
    return (clubId) => async (authContext) => {
        const authService = new ClubAuthorizationService(membershipRepository, authorizationService);
        await authService.requireClubCapability(authContext, clubId, capability);
    };
}
exports.requireClubCapabilityDynamic = requireClubCapabilityDynamic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2x1Yi1hdXRob3JpemF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2x1Yi1hdXRob3JpemF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7O0FBRUgsb0ZBTXFEO0FBQ3JELG9FQUFpRjtBQUVqRixrRUFBaUc7QUFDakcsZ0dBQW1IO0FBR25IOztHQUVHO0FBQ0gsTUFBYSx3QkFBd0I7SUFDakMsWUFDWSxvQkFBMkMsRUFDM0Msb0JBQTJDO1FBRDNDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBdUI7UUFDM0MseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF1QjtJQUNuRCxDQUFDO0lBRUw7O09BRUc7SUFDSCxLQUFLLENBQUMscUJBQXFCLENBQ3ZCLFdBQXdCLEVBQ3hCLE1BQWM7UUFFZCw2QkFBNkI7UUFDN0IsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsMEJBQTBCLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUxRyxJQUFJLGdCQUFnQixHQUFxQixFQUFFLENBQUM7UUFDNUMsSUFBSSxjQUFjLEdBQXNDLFNBQVMsQ0FBQztRQUVsRSxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxLQUFLLDZCQUFnQixDQUFDLE1BQU0sRUFBRTtZQUM3RCxnQkFBZ0IsR0FBRyxJQUFBLDJDQUFzQixFQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzRCxjQUFjLEdBQUc7Z0JBQ2IsWUFBWSxFQUFFLFVBQVUsQ0FBQyxZQUFZO2dCQUNyQyxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU07Z0JBQ3pCLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSTtnQkFDckIsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNO2dCQUN6QixRQUFRLEVBQUUsVUFBVSxDQUFDLFFBQVE7YUFDaEMsQ0FBQztTQUNMO1FBRUQsT0FBTztZQUNILEdBQUcsV0FBVztZQUNkLGNB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QyxVQUEwQixFQUMxQixNQUFjLEVBQ2Qsb0JBQTJDLEVBQzNDLG9CQUEyQztJQUUzQyxPQUFPLEtBQUssRUFBRSxXQUF3QixFQUFpQixFQUFFO1FBQ3JELE1BQU0sV0FBVyxHQUFHLElBQUksd0JBQXdCLENBQUMsb0JBQW9CLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUM3RixNQUFNLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzdFLENBQUMsQ0FBQztBQUNOLENBQUM7QUFWRCxzREFVQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsNEJBQTRCLENBQ3hDLFVBQTBCLEVBQzFCLG9CQUEyQyxFQUMzQyxvQkFBMkM7SUFFM0MsT0FBTyxDQUFDLE1BQWMsRUFBRSxFQUFFLENBQUMsS0FBSyxFQUFFLFdBQXdCLEVBQWlCLEVBQUU7UUFDekUsTUFBTSxXQUFXLEdBQUcsSUFBSSx3QkFBd0IsQ0FBQyxvQkFBb0IsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBQzdGLE1BQU0sV0FBVyxDQUFDLHFCQUFxQixDQUFDLFdBQVcsRUFBRSxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDN0UsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQVRELG9FQVNDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDbHViIEF1dGhvcml6YXRpb24gU3lzdGVtIC0gUGhhc2UgMi4yXG4gKiBcbiAqIENsdWItbGV2ZWwgYXV0aG9yaXphdGlvbiBtaWRkbGV3YXJlIGFuZCBjYXBhYmlsaXR5IGNoZWNraW5nLlxuICogRXh0ZW5kcyBQaGFzZSAxLjMgYXV0aG9yaXphdGlvbiB3aXRoIGNsdWItc3BlY2lmaWMgcGVybWlzc2lvbnMuXG4gKiBcbiAqIENvbXBsaWFuY2U6XG4gKiAtIFBoYXNlIDIuMiBTcGVjOiAua2lyby9zcGVjcy9waGFzZS0yLjIuY2x1Yi1tZW1iZXJzaGlwLXJvbGVzLnYxLm1kXG4gKi9cblxuaW1wb3J0IHtcbiAgICBDbHViQ2FwYWJpbGl0eSxcbiAgICBDbHViQXV0aENvbnRleHQsXG4gICAgZ2V0Q2FwYWJpbGl0aWVzRm9yUm9sZSxcbiAgICByb2xlSGFzQ2FwYWJpbGl0eSxcbiAgICBnZXRNaW5pbXVtUm9sZUZvckNhcGFiaWxpdHlcbn0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL3R5cGVzL2NsdWItYXV0aG9yaXphdGlvbic7XG5pbXBvcnQgeyBDbHViUm9sZSwgTWVtYmVyc2hpcFN0YXR1cyB9IGZyb20gJy4uLy4uLy4uLy4uL3NoYXJlZC90eXBlcy9tZW1iZXJzaGlwJztcbmltcG9ydCB7IEF1dGhDb250ZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL3R5cGVzL2F1dGgnO1xuaW1wb3J0IHsgU3lzdGVtQ2FwYWJpbGl0eSwgSUF1dGhvcml6YXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL2F1dGhvcml6YXRpb24vdHlwZXMnO1xuaW1wb3J0IHsgQXV0aG9yaXphdGlvbkVycm9yLCBBdXRob3JpemF0aW9uRXJyb3JUeXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL2F1dGhvcml6YXRpb24vYXV0aG9yaXphdGlvbi1lcnJvcnMnO1xuaW1wb3J0IHsgSU1lbWJlcnNoaXBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vbWVtYmVyc2hpcC9tZW1iZXJzaGlwLXJlcG9zaXRvcnknO1xuXG4vKipcbiAqIENsdWIgYXV0aG9yaXphdGlvbiBzZXJ2aWNlXG4gKi9cbmV4cG9ydCBjbGFzcyBDbHViQXV0aG9yaXphdGlvblNlcnZpY2Uge1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIG1lbWJlcnNoaXBSZXBvc2l0b3J5OiBJTWVtYmVyc2hpcFJlcG9zaXRvcnksXG4gICAgICAgIHByaXZhdGUgYXV0aG9yaXphdGlvblNlcnZpY2U6IElBdXRob3JpemF0aW9uU2VydmljZVxuICAgICkgeyB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgZW5oYW5jZWQgYXV0aG9yaXphdGlvbiBjb250ZXh0IHdpdGggY2x1YiBtZW1iZXJzaGlwXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlQ2x1YkF1dGhDb250ZXh0KFxuICAgICAgICBhdXRoQ29udGV4dDogQXV0aENvbnRleHQsXG4gICAgICAgIGNsdWJJZDogc3RyaW5nXG4gICAgKTogUHJvbWlzZTxDbHViQXV0aENvbnRleHQ+IHtcbiAgICAgICAgLy8gR2V0IHVzZXIncyBjbHViIG1lbWJlcnNoaXBcbiAgICAgICAgY29uc3QgbWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMubWVtYmVyc2hpcFJlcG9zaXRvcnkuZ2V0TWVtYmVyc2hpcEJ5Q2x1YkFuZFVzZXIoY2x1YklkLCBhdXRoQ29udGV4dC51c2VySWQpO1xuXG4gICAgICAgIGxldCBjbHViQ2FwYWJpbGl0aWVzOiBDbHViQ2FwYWJpbGl0eVtdID0gW107XG4gICAgICAgIGxldCBjbHViTWVtYmVyc2hpcDogQ2x1YkF1dGhDb250ZXh0WydjbHViTWVtYmVyc2hpcCddID0gdW5kZWZpbmVkO1xuXG4gICAgICAgIGlmIChtZW1iZXJzaGlwICYmIG1lbWJlcnNoaXAuc3RhdHVzID09PSBNZW1iZXJzaGlwU3RhdHVzLkFDVElWRSkge1xuICAgICAgICAgICAgY2x1YkNhcGFiaWxpdGllcyA9IGdldENhcGFiaWxpdGllc0ZvclJvbGUobWVtYmVyc2hpcC5yb2xlKTtcbiAgICAgICAgICAgIGNsdWJNZW1iZXJzaGlwID0ge1xuICAgICAgICAgICAgICAgIG1lbWJlcnNoaXBJZDogbWVtYmVyc2hpcC5tZW1iZXJzaGlwSWQsXG4gICAgICAgICAgICAgICAgY2x1YklkOiBtZW1iZXJzaGlwLmNsdWJJZCxcbiAgICAgICAgICAgICAgICByb2xlOiBtZW1iZXJzaGlwLnJvbGUsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiBtZW1iZXJzaGlwLnN0YXR1cyxcbiAgICAgICAgICAgICAgICBqb2luZWRBdDogbWVtYmVyc2hpcC5qb2luZWRBdCxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uYXV0aENvbnRleHQsXG4gICAgICAgICAgICBjbHViTWVtYmVyc2hpcCxcbiAgICAgICAgICAgIGNsdWJDYXBhYmlsaXRpZXMsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgdXNlciBoYXMgY2x1YiBjYXBhYmlsaXR5XG4gICAgICovXG4gICAgYXN5bmMgaGFzQ2x1YkNhcGFiaWxpdHkoXG4gICAgICAgIGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCxcbiAgICAgICAgY2x1YklkOiBzdHJpbmcsXG4gICAgICAgIGNhcGFiaWxpdHk6IENsdWJDYXBhYmlsaXR5XG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJlcXVpcmVDbHViQ2FwYWJpbGl0eShhdXRoQ29udGV4dCwgY2x1YklkLCBjYXBhYmlsaXR5KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcXVpcmUgY2x1YiBjYXBhYmlsaXR5ICh0aHJvd3MgaWYgbm90IGF1dGhvcml6ZWQpXG4gICAgICovXG4gICAgYXN5bmMgcmVxdWlyZUNsdWJDYXBhYmlsaXR5KFxuICAgICAgICBhdXRoQ29udGV4dDogQXV0aENvbnRleHQsXG4gICAgICAgIGNsdWJJZDogc3RyaW5nLFxuICAgICAgICBjYXBhYmlsaXR5OiBDbHViQ2FwYWJpbGl0eVxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICAvLyBDaGVjayBzeXN0ZW0tbGV2ZWwgY2FwYWJpbGl0aWVzIGZpcnN0IChTaXRlQWRtaW4gb3ZlcnJpZGUpXG4gICAgICAgIGNvbnN0IGhhc1N5c3RlbU92ZXJyaWRlID0gYXdhaXQgdGhpcy5hdXRob3JpemF0aW9uU2VydmljZS5oYXNTeXN0ZW1DYXBhYmlsaXR5KFxuICAgICAgICAgICAgYXV0aENvbnRleHQsIFxuICAgICAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfQUxMX0NMVUJTXG4gICAgICAgICk7XG4gICAgICAgIGlmIChoYXNTeXN0ZW1PdmVycmlkZSkge1xuICAgICAgICAgICAgcmV0dXJuOyAvLyBTeXN0ZW0gYWRtaW4gaGFzIGFsbCBjbHViIGNhcGFiaWxpdGllc1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2V0IHVzZXIncyBjbHViIG1lbWJlcnNoaXAgKHJlYWwtdGltZSBjaGVjayAtIG5vIGNhY2hpbmcpXG4gICAgICAgIGNvbnN0IG1lbWJlcnNoaXAgPSBhd2FpdCB0aGlzLm1lbWJlcnNoaXBSZXBvc2l0b3J5LmdldE1lbWJlcnNoaXBCeUNsdWJBbmRVc2VyKGNsdWJJZCwgYXV0aENvbnRleHQudXNlcklkKTtcblxuICAgICAgICBpZiAoIW1lbWJlcnNoaXAgfHwgbWVtYmVyc2hpcC5zdGF0dXMgIT09IE1lbWJlcnNoaXBTdGF0dXMuQUNUSVZFKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvbkVycm9yKFxuICAgICAgICAgICAgICAgIGBJbnN1ZmZpY2llbnQgcHJpdmlsZWdlczogJHtjYXBhYmlsaXR5fSByZXF1aXJlZGAsXG4gICAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbkVycm9yVHlwZS5JTlNVRkZJQ0lFTlRfUFJJVklMRUdFUyxcbiAgICAgICAgICAgICAgICA0MDMsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBjYXBhYmlsaXR5OiBjYXBhYmlsaXR5IGFzIGFueSwgLy8gVHlwZSBhc3NlcnRpb24gZm9yIGNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkOiBhdXRoQ29udGV4dC51c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiBgY2x1Yjoke2NsdWJJZH1gLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBjbHViLWxldmVsIGNhcGFiaWxpdHlcbiAgICAgICAgaWYgKCFyb2xlSGFzQ2FwYWJpbGl0eShtZW1iZXJzaGlwLnJvbGUsIGNhcGFiaWxpdHkpKSB7XG4gICAgICAgICAgICBjb25zdCByZXF1aXJlZFJvbGVzID0gW2dldE1pbmltdW1Sb2xlRm9yQ2FwYWJpbGl0eShjYXBhYmlsaXR5KV0uZmlsdGVyKEJvb2xlYW4pIGFzIENsdWJSb2xlW107XG5cbiAgICAgICAgICAgIHRocm93IG5ldyBBdXRob3JpemF0aW9uRXJyb3IoXG4gICAgICAgICAgICAgICAgYEluc3VmZmljaWVudCBwcml2aWxlZ2VzOiAke2NhcGFiaWxpdHl9IHJlcXVpcmVzICR7cmVxdWlyZWRSb2xlcy5qb2luKCcgb3IgJyl9IHJvbGVgLFxuICAgICAgICAgICAgICAgIEF1dGhvcml6YXRpb25FcnJvclR5cGUuSU5TVUZGSUNJRU5UX1BSSVZJTEVHRVMsXG4gICAgICAgICAgICAgICAgNDAzLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgY2FwYWJpbGl0eTogY2FwYWJpbGl0eSBhcyBhbnksIC8vIFR5cGUgYXNzZXJ0aW9uIGZvciBjb21wYXRpYmlsaXR5XG4gICAgICAgICAgICAgICAgICAgIHVzZXJJZDogYXV0aENvbnRleHQudXNlcklkLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZTogYGNsdWI6JHtjbHViSWR9YCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgdXNlciBjYW4gbWFuYWdlIG1lbWJlciAocm9sZSBoaWVyYXJjaHkgY2hlY2spXG4gICAgICovXG4gICAgYXN5bmMgY2FuTWFuYWdlTWVtYmVyKFxuICAgICAgICBhdXRoQ29udGV4dDogQXV0aENvbnRleHQsXG4gICAgICAgIGNsdWJJZDogc3RyaW5nLFxuICAgICAgICB0YXJnZXRNZW1iZXJSb2xlOiBDbHViUm9sZVxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICAvLyBTeXN0ZW0gYWRtaW5zIGNhbiBtYW5hZ2UgYW55b25lXG4gICAgICAgIGNvbnN0IGhhc1N5c3RlbU92ZXJyaWRlID0gYXdhaXQgdGhpcy5hdXRob3JpemF0aW9uU2VydmljZS5oYXNTeXN0ZW1DYXBhYmlsaXR5KFxuICAgICAgICAgICAgYXV0aENvbnRleHQsIFxuICAgICAgICAgICAgU3lzdGVtQ2FwYWJpbGl0eS5NQU5BR0VfQUxMX0NMVUJTXG4gICAgICAgICk7XG4gICAgICAgIGlmIChoYXNTeXN0ZW1PdmVycmlkZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBHZXQgdXNlcidzIGNsdWIgbWVtYmVyc2hpcFxuICAgICAgICBjb25zdCBtZW1iZXJzaGlwID0gYXdhaXQgdGhpcy5tZW1iZXJzaGlwUmVwb3NpdG9yeS5nZXRNZW1iZXJzaGlwQnlDbHViQW5kVXNlcihjbHViSWQsIGF1dGhDb250ZXh0LnVzZXJJZCk7XG5cbiAgICAgICAgaWYgKCFtZW1iZXJzaGlwIHx8IG1lbWJlcnNoaXAuc3RhdHVzICE9PSBNZW1iZXJzaGlwU3RhdHVzLkFDVElWRSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUm9sZSBoaWVyYXJjaHk6IE93bmVyID4gQWRtaW4gPiBNZW1iZXJcbiAgICAgICAgY29uc3Qgcm9sZUhpZXJhcmNoeSA9IHtcbiAgICAgICAgICAgIFtDbHViUm9sZS5NRU1CRVJdOiAxLFxuICAgICAgICAgICAgW0NsdWJSb2xlLkFETUlOXTogMixcbiAgICAgICAgICAgIFtDbHViUm9sZS5PV05FUl06IDMsXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgdXNlckxldmVsID0gcm9sZUhpZXJhcmNoeVttZW1iZXJzaGlwLnJvbGVdO1xuICAgICAgICBjb25zdCB0YXJnZXRMZXZlbCA9IHJvbGVIaWVyYXJjaHlbdGFyZ2V0TWVtYmVyUm9sZV07XG5cbiAgICAgICAgLy8gQ2FuIG9ubHkgbWFuYWdlIG1lbWJlcnMgd2l0aCBsb3dlciBvciBlcXVhbCByb2xlIGxldmVsXG4gICAgICAgIC8vIEV4Y2VwdGlvbjogT3duZXJzIGNhbm5vdCBiZSBtYW5hZ2VkIGJ5IGFueW9uZSBleGNlcHQgc3lzdGVtIGFkbWluc1xuICAgICAgICBpZiAodGFyZ2V0TWVtYmVyUm9sZSA9PT0gQ2x1YlJvbGUuT1dORVIpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gT3duZXJzIGNhbm5vdCBiZSBtYW5hZ2VkIChvd25lcnNoaXAgdHJhbnNmZXIgcmVxdWlyZWQpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXNlckxldmVsID49IHRhcmdldExldmVsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlIHJvbGUgYXNzaWdubWVudCBwZXJtaXNzaW9uc1xuICAgICAqL1xuICAgIGFzeW5jIHZhbGlkYXRlUm9sZUFzc2lnbm1lbnQoXG4gICAgICAgIGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCxcbiAgICAgICAgY2x1YklkOiBzdHJpbmcsXG4gICAgICAgIHRhcmdldFJvbGU6IENsdWJSb2xlXG4gICAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIFN5c3RlbSBhZG1pbnMgY2FuIGFzc2lnbiBhbnkgcm9sZVxuICAgICAgICBjb25zdCBoYXNTeXN0ZW1PdmVycmlkZSA9IGF3YWl0IHRoaXMuYXV0aG9yaXphdGlvblNlcnZpY2UuaGFzU3lzdGVtQ2FwYWJpbGl0eShcbiAgICAgICAgICAgIGF1dGhDb250ZXh0LCBcbiAgICAgICAgICAgIFN5c3RlbUNhcGFiaWxpdHkuTUFOQUdFX0FMTF9DTFVCU1xuICAgICAgICApO1xuICAgICAgICBpZiAoaGFzU3lzdGVtT3ZlcnJpZGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdldCB1c2VyJ3MgY2x1YiBtZW1iZXJzaGlwXG4gICAgICAgIGNvbnN0IG1lbWJlcnNoaXAgPSBhd2FpdCB0aGlzLm1lbWJlcnNoaXBSZXBvc2l0b3J5LmdldE1lbWJlcnNoaXBCeUNsdWJBbmRVc2VyKGNsdWJJZCwgYXV0aENvbnRleHQudXNlcklkKTtcblxuICAgICAgICBpZiAoIW1lbWJlcnNoaXAgfHwgbWVtYmVyc2hpcC5zdGF0dXMgIT09IE1lbWJlcnNoaXBTdGF0dXMuQUNUSVZFKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvbkVycm9yKFxuICAgICAgICAgICAgICAgICdNdXN0IGJlIGFuIGFjdGl2ZSBjbHViIG1lbWJlciB0byBhc3NpZ24gcm9sZXMnLFxuICAgICAgICAgICAgICAgIEF1dGhvcml6YXRpb25FcnJvclR5cGUuSU5TVUZGSUNJRU5UX1BSSVZJTEVHRVMsXG4gICAgICAgICAgICAgICAgNDAzLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkOiBhdXRoQ29udGV4dC51c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiBgY2x1Yjoke2NsdWJJZH1gLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSb2xlIGFzc2lnbm1lbnQgcnVsZXM6XG4gICAgICAgIC8vIC0gT25seSBvd25lcnMgY2FuIGFzc2lnbiBhZG1pbiByb2xlc1xuICAgICAgICAvLyAtIEFkbWlucyBhbmQgb3duZXJzIGNhbiBhc3NpZ24gbWVtYmVyIHJvbGVzXG4gICAgICAgIC8vIC0gTm9ib2R5IGNhbiBhc3NpZ24gb3duZXIgcm9sZXMgKG93bmVyc2hpcCB0cmFuc2ZlciByZXF1aXJlZClcblxuICAgICAgICBpZiAodGFyZ2V0Um9sZSA9PT0gQ2x1YlJvbGUuT1dORVIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBdXRob3JpemF0aW9uRXJyb3IoXG4gICAgICAgICAgICAgICAgJ0Nhbm5vdCBhc3NpZ24gb3duZXIgcm9sZSAtIG93bmVyc2hpcCB0cmFuc2ZlciByZXF1aXJlZCcsXG4gICAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbkVycm9yVHlwZS5JTlNVRkZJQ0lFTlRfUFJJVklMRUdFUyxcbiAgICAgICAgICAgICAgICA0MDMsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IGF1dGhDb250ZXh0LnVzZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2U6IGBjbHViOiR7Y2x1YklkfWAsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0YXJnZXRSb2xlID09PSBDbHViUm9sZS5BRE1JTiAmJiBtZW1iZXJzaGlwLnJvbGUgIT09IENsdWJSb2xlLk9XTkVSKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvbkVycm9yKFxuICAgICAgICAgICAgICAgICdPbmx5IGNsdWIgb3duZXJzIGNhbiBhc3NpZ24gYWRtaW4gcm9sZXMnLFxuICAgICAgICAgICAgICAgIEF1dGhvcml6YXRpb25FcnJvclR5cGUuSU5TVUZGSUNJRU5UX1BSSVZJTEVHRVMsXG4gICAgICAgICAgICAgICAgNDAzLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkOiBhdXRoQ29udGV4dC51c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiBgY2x1Yjoke2NsdWJJZH1gLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGFyZ2V0Um9sZSA9PT0gQ2x1YlJvbGUuTUVNQkVSICYmICF0aGlzLmlzQWRtaW5Pck93bmVyKG1lbWJlcnNoaXAucm9sZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBdXRob3JpemF0aW9uRXJyb3IoXG4gICAgICAgICAgICAgICAgJ09ubHkgY2x1YiBhZG1pbnMgYW5kIG93bmVycyBjYW4gYXNzaWduIG1lbWJlciByb2xlcycsXG4gICAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbkVycm9yVHlwZS5JTlNVRkZJQ0lFTlRfUFJJVklMRUdFUyxcbiAgICAgICAgICAgICAgICA0MDMsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IGF1dGhDb250ZXh0LnVzZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2U6IGBjbHViOiR7Y2x1YklkfWAsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIHJvbGUgaXMgYWRtaW4gb3Igb3duZXJcbiAgICAgKi9cbiAgICBwcml2YXRlIGlzQWRtaW5Pck93bmVyKHJvbGU6IENsdWJSb2xlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiByb2xlID09PSBDbHViUm9sZS5BRE1JTiB8fCByb2xlID09PSBDbHViUm9sZS5PV05FUjtcbiAgICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIGNsdWIgYXV0aG9yaXphdGlvbiBtaWRkbGV3YXJlIGZ1bmN0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQ2x1YkNhcGFiaWxpdHkoXG4gICAgY2FwYWJpbGl0eTogQ2x1YkNhcGFiaWxpdHksXG4gICAgY2x1YklkOiBzdHJpbmcsXG4gICAgbWVtYmVyc2hpcFJlcG9zaXRvcnk6IElNZW1iZXJzaGlwUmVwb3NpdG9yeSxcbiAgICBhdXRob3JpemF0aW9uU2VydmljZTogSUF1dGhvcml6YXRpb25TZXJ2aWNlXG4pIHtcbiAgICByZXR1cm4gYXN5bmMgKGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICBjb25zdCBhdXRoU2VydmljZSA9IG5ldyBDbHViQXV0aG9yaXphdGlvblNlcnZpY2UobWVtYmVyc2hpcFJlcG9zaXRvcnksIGF1dGhvcml6YXRpb25TZXJ2aWNlKTtcbiAgICAgICAgYXdhaXQgYXV0aFNlcnZpY2UucmVxdWlyZUNsdWJDYXBhYmlsaXR5KGF1dGhDb250ZXh0LCBjbHViSWQsIGNhcGFiaWxpdHkpO1xuICAgIH07XG59XG5cbi8qKlxuICogQ3JlYXRlIGNsdWIgYXV0aG9yaXphdGlvbiBtaWRkbGV3YXJlIHdpdGggZHluYW1pYyBjbHViIElEXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQ2x1YkNhcGFiaWxpdHlEeW5hbWljKFxuICAgIGNhcGFiaWxpdHk6IENsdWJDYXBhYmlsaXR5LFxuICAgIG1lbWJlcnNoaXBSZXBvc2l0b3J5OiBJTWVtYmVyc2hpcFJlcG9zaXRvcnksXG4gICAgYXV0aG9yaXphdGlvblNlcnZpY2U6IElBdXRob3JpemF0aW9uU2VydmljZVxuKSB7XG4gICAgcmV0dXJuIChjbHViSWQ6IHN0cmluZykgPT4gYXN5bmMgKGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICBjb25zdCBhdXRoU2VydmljZSA9IG5ldyBDbHViQXV0aG9yaXphdGlvblNlcnZpY2UobWVtYmVyc2hpcFJlcG9zaXRvcnksIGF1dGhvcml6YXRpb25TZXJ2aWNlKTtcbiAgICAgICAgYXdhaXQgYXV0aFNlcnZpY2UucmVxdWlyZUNsdWJDYXBhYmlsaXR5KGF1dGhDb250ZXh0LCBjbHViSWQsIGNhcGFiaWxpdHkpO1xuICAgIH07XG59Il19