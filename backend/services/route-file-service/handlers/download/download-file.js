"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const lambda_utils_1 = require("../../../../shared/utils/lambda-utils");
const auth_context_1 = require("../../../../shared/auth/auth-context");
const authorization_service_1 = require("../../../../shared/authorization/authorization-service");
const club_authorization_1 = require("../../../../shared/types/club-authorization");
const route_file_1 = require("../../../../shared/types/route-file");
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const dynamoClient = lib_dynamodb_1.DynamoDBDocumentClient.from(new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION }));
const BUCKET_NAME = process.env.ROUTES_BUCKET_NAME;
const TABLE_NAME = process.env.MAIN_TABLE_NAME;
const CLOUDFRONT_DOMAIN = process.env.CLOUDFRONT_DOMAIN;
const DOWNLOAD_URL_EXPIRY = 15 * 60; // 15 minutes
const handler = async (event) => {
    try {
        // Validate authentication
        const authContext = (0, auth_context_1.validateAuthContext)(event);
        // Extract path parameters
        const clubId = event.pathParameters?.clubId;
        const routeId = event.pathParameters?.routeId;
        const version = event.pathParameters?.version;
        if (!clubId || !routeId || !version) {
            throw new route_file_1.RouteFileError('Missing required path parameters', 'MISSING_PARAMETERS', 400);
        }
        // Check authorization - club members can download files
        const authService = new authorization_service_1.AuthorizationService();
        const hasPermission = await authService.hasCapability(authContext.userId, clubId, club_authorization_1.ClubCapability.DOWNLOAD_ROUTE_FILES);
        if (!hasPermission) {
            throw new route_file_1.RouteFileError('Insufficient privileges to download route files', 'INSUFFICIENT_PRIVILEGES', 403);
        }
        // Get file record from DynamoDB
        const fileRecord = await getFileRecord(clubId, routeId, parseInt(version));
        if (!fileRecord) {
            throw new route_file_1.RouteFileError('File not found', 'FILE_NOT_FOUND', 404);
        }
        if (fileRecord.processingStatus !== 'completed') {
            throw new route_file_1.RouteFileError('File is not ready for download', 'FILE_NOT_READY', 400);
        }
        // Verify file exists in S3
        await verifyFileExists(fileRecord.fileKey);
        // Generate signed download URL
        const downloadUrl = await generateSignedDownloadUrl(fileRecord.fileKey);
        return (0, lambda_utils_1.createResponse)(200, {
            success: true,
            data: {
                downloadUrl,
                expiresAt: new Date(Date.now() + DOWNLOAD_URL_EXPIRY * 1000).toISOString(),
                fileName: fileRecord.fileName,
                fileSize: fileRecord.fileSize,
            },
        });
    }
    catch (error) {
        console.error('Error generating download URL:', error);
        if (error instanceof route_file_1.RouteFileError) {
            return (0, lambda_utils_1.createResponse)(error.statusCode, {
                success: false,
                error: error.code,
                message: error.message,
            });
        }
        return (0, lambda_utils_1.createResponse)(500, {
            success: false,
            error: 'INTERNAL_ERROR',
            message: 'Failed to generate download URL',
        });
    }
};
exports.handler = handler;
async function getFileRecord(clubId, routeId, version) {
    const response = await dynamoClient.send(new lib_dynamodb_1.GetCommand({
        TableName: TABLE_NAME,
        Key: {
            PK: `CLUB#${clubId}#ROUTE#${routeId}`,
            SK: `FILE#${version}`,
        },
    }));
    return response.Item;
}
async function verifyFileExists(fileKey) {
    try {
        await s3Client.send(new client_s3_1.HeadObjectCommand({
            Bucket: BUCKET_NAME,
            Key: fileKey,
        }));
    }
    catch (error) {
        if (error.name === 'NotFound' || error.$metadata?.httpStatusCode === 404) {
            throw new route_file_1.RouteFileError('File not found in storage', 'FILE_NOT_FOUND_IN_STORAGE', 404);
        }
        throw error;
    }
}
async function generateSignedDownloadUrl(fileKey) {
    const command = new client_s3_1.GetObjectCommand({
        Bucket: BUCKET_NAME,
        Key: fileKey,
    });
    const signedUrl = await (0, s3_request_presigner_1.getSignedUrl)(s3Client, command, {
        expiresIn: DOWNLOAD_URL_EXPIRY,
    });
    // If CloudFront is configured, replace S3 URL with CloudFront URL
    if (CLOUDFRONT_DOMAIN) {
        const s3UrlPattern = new RegExp(`https://${BUCKET_NAME}\\.s3\\.[^/]+\\.amazonaws\\.com/`);
        return signedUrl.replace(s3UrlPattern, `https://${CLOUDFRONT_DOMAIN}/`);
    }
    return signedUrl;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG93bmxvYWQtZmlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRvd25sb2FkLWZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0Esa0RBQW1GO0FBQ25GLHdFQUE2RDtBQUM3RCw4REFBMEQ7QUFDMUQsd0RBQTJFO0FBQzNFLHdFQUF1RTtBQUN2RSx1RUFBMkU7QUFDM0Usa0dBQThGO0FBQzlGLG9GQUE2RTtBQUM3RSxvRUFBcUU7QUFFckUsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztBQUNsRSxNQUFNLFlBQVksR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBRXpHLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQW1CLENBQUM7QUFDcEQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFnQixDQUFDO0FBQ2hELE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBa0IsQ0FBQztBQUN6RCxNQUFNLG1CQUFtQixHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO0FBRTNDLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLElBQUk7UUFDRiwwQkFBMEI7UUFDMUIsTUFBTSxXQUFXLEdBQUcsSUFBQSxrQ0FBbUIsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUUvQywwQkFBMEI7UUFDMUIsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUM7UUFDNUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLGNBQWMsRUFBRSxPQUFPLENBQUM7UUFDOUMsTUFB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YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgUzNDbGllbnQsIEdldE9iamVjdENvbW1hbmQsIEhlYWRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IGdldFNpZ25lZFVybCB9IGZyb20gJ0Bhd3Mtc2RrL3MzLXJlcXVlc3QtcHJlc2lnbmVyJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgY3JlYXRlUmVzcG9uc2UgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvdXRpbHMvbGFtYmRhLXV0aWxzJztcbmltcG9ydCB7IHZhbGlkYXRlQXV0aENvbnRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvYXV0aC9hdXRoLWNvbnRleHQnO1xuaW1wb3J0IHsgQXV0aG9yaXphdGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvYXV0aG9yaXphdGlvbi9hdXRob3JpemF0aW9uLXNlcnZpY2UnO1xuaW1wb3J0IHsgQ2x1YkNhcGFiaWxpdHkgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvdHlwZXMvY2x1Yi1hdXRob3JpemF0aW9uJztcbmltcG9ydCB7IFJvdXRlRmlsZUVycm9yIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL3R5cGVzL3JvdXRlLWZpbGUnO1xuXG5jb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB9KTtcbmNvbnN0IGR5bmFtb0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSkpO1xuXG5jb25zdCBCVUNLRVRfTkFNRSA9IHByb2Nlc3MuZW52LlJPVVRFU19CVUNLRVRfTkFNRSE7XG5jb25zdCBUQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuTUFJTl9UQUJMRV9OQU1FITtcbmNvbnN0IENMT1VERlJPTlRfRE9NQUlOID0gcHJvY2Vzcy5lbnYuQ0xPVURGUk9OVF9ET01BSU4hO1xuY29uc3QgRE9XTkxPQURfVVJMX0VYUElSWSA9IDE1ICogNjA7IC8vIDE1IG1pbnV0ZXNcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBWYWxpZGF0ZSBhdXRoZW50aWNhdGlvblxuICAgIGNvbnN0IGF1dGhDb250ZXh0ID0gdmFsaWRhdGVBdXRoQ29udGV4dChldmVudCk7XG4gICAgXG4gICAgLy8gRXh0cmFjdCBwYXRoIHBhcmFtZXRlcnNcbiAgICBjb25zdCBjbHViSWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uY2x1YklkO1xuICAgIGNvbnN0IHJvdXRlSWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8ucm91dGVJZDtcbiAgICBjb25zdCB2ZXJzaW9uID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LnZlcnNpb247XG4gICAgXG4gICAgaWYgKCFjbHViSWQgfHwgIXJvdXRlSWQgfHwgIXZlcnNpb24pIHtcbiAgICAgIHRocm93IG5ldyBSb3V0ZUZpbGVFcnJvcignTWlzc2luZyByZXF1aXJlZCBwYXRoIHBhcmFtZXRlcnMnLCAnTUlTU0lOR19QQVJBTUVURVJTJywgNDAwKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBhdXRob3JpemF0aW9uIC0gY2x1YiBtZW1iZXJzIGNhbiBkb3dubG9hZCBmaWxlc1xuICAgIGNvbnN0IGF1dGhTZXJ2aWNlID0gbmV3IEF1dGhvcml6YXRpb25TZXJ2aWNlKCk7XG4gICAgY29uc3QgaGFzUGVybWlzc2lvbiA9IGF3YWl0IGF1dGhTZXJ2aWNlLmhhc0NhcGFiaWxpdHkoXG4gICAgICBhdXRoQ29udGV4dC51c2VySWQsXG4gICAgICBjbHViSWQsXG4gICAgICBDbHViQ2FwYWJpbGl0eS5ET1dOTE9BRF9ST1VURV9GSUxFU1xuICAgICk7XG4gICAgXG4gICAgaWYgKCFoYXNQZXJtaXNzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgUm91dGVGaWxlRXJyb3IoJ0luc3VmZmljaWVudCBwcml2aWxlZ2VzIHRvIGRvd25sb2FkIHJvdXRlIGZpbGVzJywgJ0lOU1VGRklDSUVOVF9QUklWSUxFR0VTJywgNDAzKTtcbiAgICB9XG5cbiAgICAvLyBHZXQgZmlsZSByZWNvcmQgZnJvbSBEeW5hbW9EQlxuICAgIGNvbnN0IGZpbGVSZWNvcmQgPSBhd2FpdCBnZXRGaWxlUmVjb3JkKGNsdWJJZCwgcm91dGVJZCwgcGFyc2VJbnQodmVyc2lvbikpO1xuICAgIFxuICAgIGlmICghZmlsZVJlY29yZCkge1xuICAgICAgdGhyb3cgbmV3IFJvdXRlRmlsZUVycm9yKCdGaWxlIG5vdCBmb3VuZCcsICdGSUxFX05PVF9GT1VORCcsIDQwNCk7XG4gICAgfVxuICAgIFxuICAgIGlmIChmaWxlUmVjb3JkLnByb2Nlc3NpbmdTdGF0dXMgIT09ICdjb21wbGV0ZWQnKSB7XG4gICAgICB0aHJvdyBuZXcgUm91dGVGaWxlRXJyb3IoJ0ZpbGUgaXMgbm90IHJlYWR5IGZvciBkb3dubG9hZCcsICdGSUxFX05PVF9SRUFEWScsIDQwMCk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZ5IGZpbGUgZXhpc3RzIGluIFMzXG4gICAgYXdhaXQgdmVyaWZ5RmlsZUV4aXN0cyhmaWxlUmVjb3JkLmZpbGVLZXkpO1xuICAgIFxuICAgIC8vIEdlbmVyYXRlIHNpZ25lZCBkb3dubG9hZCBVUkxcbiAgICBjb25zdCBkb3dubG9hZFVybCA9IGF3YWl0IGdlbmVyYXRlU2lnbmVkRG93bmxvYWRVcmwoZmlsZVJlY29yZC5maWxlS2V5KTtcbiAgICBcbiAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoMjAwLCB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBkb3dubG9hZFVybCxcbiAgICAgICAgZXhwaXJlc0F0OiBuZXcgRGF0ZShEYXRlLm5vdygpICsgRE9XTkxPQURfVVJMX0VYUElSWSAqIDEwMDApLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGZpbGVOYW1lOiBmaWxlUmVjb3JkLmZpbGVOYW1lLFxuICAgICAgICBmaWxlU2l6ZTogZmlsZVJlY29yZC5maWxlU2l6ZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyBkb3dubG9hZCBVUkw6JywgZXJyb3IpO1xuICAgIFxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFJvdXRlRmlsZUVycm9yKSB7XG4gICAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoZXJyb3Iuc3RhdHVzQ29kZSwge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IGVycm9yLmNvZGUsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDUwMCwge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0lOVEVSTkFMX0VSUk9SJyxcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZ2VuZXJhdGUgZG93bmxvYWQgVVJMJyxcbiAgICB9KTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZVJlY29yZChjbHViSWQ6IHN0cmluZywgcm91dGVJZDogc3RyaW5nLCB2ZXJzaW9uOiBudW1iZXIpOiBQcm9taXNlPGFueT4ge1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgS2V5OiB7XG4gICAgICBQSzogYENMVUIjJHtjbHViSWR9I1JPVVRFIyR7cm91dGVJZH1gLFxuICAgICAgU0s6IGBGSUxFIyR7dmVyc2lvbn1gLFxuICAgIH0sXG4gIH0pKTtcbiAgXG4gIHJldHVybiByZXNwb25zZS5JdGVtO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlGaWxlRXhpc3RzKGZpbGVLZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIGF3YWl0IHMzQ2xpZW50LnNlbmQobmV3IEhlYWRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogQlVDS0VUX05BTUUsXG4gICAgICBLZXk6IGZpbGVLZXksXG4gICAgfSkpO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdOb3RGb3VuZCcgfHwgZXJyb3IuJG1ldGFkYXRhPy5odHRwU3RhdHVzQ29kZSA9PT0gNDA0KSB7XG4gICAgICB0aHJvdyBuZXcgUm91dGVGaWxlRXJyb3IoJ0ZpbGUgbm90IGZvdW5kIGluIHN0b3JhZ2UnLCAnRklMRV9OT1RfRk9VTkRfSU5fU1RPUkFHRScsIDQwNCk7XG4gICAgfVxuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlU2lnbmVkRG93bmxvYWRVcmwoZmlsZUtleTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICBCdWNrZXQ6IEJVQ0tFVF9OQU1FLFxuICAgIEtleTogZmlsZUtleSxcbiAgfSk7XG4gIFxuICBjb25zdCBzaWduZWRVcmwgPSBhd2FpdCBnZXRTaWduZWRVcmwoczNDbGllbnQsIGNvbW1hbmQsIHtcbiAgICBleHBpcmVzSW46IERPV05MT0FEX1VSTF9FWFBJUlksXG4gIH0pO1xuICBcbiAgLy8gSWYgQ2xvdWRGcm9udCBpcyBjb25maWd1cmVkLCByZXBsYWNlIFMzIFVSTCB3aXRoIENsb3VkRnJvbnQgVVJMXG4gIGlmIChDTE9VREZST05UX0RPTUFJTikge1xuICAgIGNvbnN0IHMzVXJsUGF0dGVybiA9IG5ldyBSZWdFeHAoYGh0dHBzOi8vJHtCVUNLRVRfTkFNRX1cXFxcLnMzXFxcXC5bXi9dK1xcXFwuYW1hem9uYXdzXFxcXC5jb20vYCk7XG4gICAgcmV0dXJuIHNpZ25lZFVybC5yZXBsYWNlKHMzVXJsUGF0dGVybiwgYGh0dHBzOi8vJHtDTE9VREZST05UX0RPTUFJTn0vYCk7XG4gIH1cbiAgXG4gIHJldHVybiBzaWduZWRVcmw7XG59Il19