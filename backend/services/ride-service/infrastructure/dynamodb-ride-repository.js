"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DynamoDBRideRepository = void 0;
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const ride_1 = require("../domain/ride/ride");
class DynamoDBRideRepository {
    constructor(dynamoClient, tableName) {
        this.docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
        this.tableName = tableName;
    }
    async create(ride) {
        const rideData = ride.toJSON();
        const now = new Date().toISOString();
        const items = [
            // Main ride item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}`,
                        SK: `RIDE#${rideData.rideId}`,
                        GSI1PK: `RIDE#${rideData.rideId}`,
                        GSI1SK: 'METADATA',
                        entityType: 'RIDE',
                        ...rideData
                    }
                }
            },
            // Club ride index item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}#RIDES`,
                        SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        GSI2PK: `CLUB#${rideData.clubId}#RIDES#${rideData.status}`,
                        GSI2SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        entityType: 'CLUB_RIDE_INDEX',
                        rideId: rideData.rideId,
                        title: rideData.title,
                        rideType: rideData.rideType,
                        difficulty: rideData.difficulty,
                        status: rideData.status,
                        startDateTime: rideData.startDateTime,
                        currentParticipants: rideData.currentParticipants,
                        maxParticipants: rideData.maxParticipants,
                        createdBy: rideData.createdBy,
                        publishedBy: rideData.publishedBy,
                        publishedAt: rideData.publishedAt
                    }
                }
            }
        ];
        await this.docClient.send(new lib_dynamodb_1.TransactWriteCommand({ TransactItems: items }));
    }
    async findById(rideId) {
        const result = await this.docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: this.tableName,
            IndexName: 'GSI1',
            KeyConditionExpression: 'GSI1PK = :pk AND GSI1SK = :sk',
            ExpressionAttributeValues: {
                ':pk': `RIDE#${rideId}`,
                ':sk': 'METADATA'
            }
        }));
        if (!result.Items || result.Items.length === 0) {
            return null;
        }
        const item = result.Items[0];
        return new ride_1.RideEntity(item);
    }
    async findByClubId(clubId, query) {
        let keyCondition;
        let expressionAttributeValues;
        if (query.status) {
            // Query by status using GSI2
            keyCondition = 'GSI2PK = :pk';
            expressionAttributeValues = {
                ':pk': `CLUB#${clubId}#RIDES#${query.status}`
            };
        }
        else {
            // Query all rides for club
            keyCondition = 'PK = :pk';
            expressionAttributeValues = {
                ':pk': `CLUB#${clubId}#RIDES`
            };
        }
        // Add date filtering if provided
        if (query.startDate || query.endDate) {
            if (query.startDate && query.endDate) {
                keyCondition += ' AND SK BETWEEN :startDate AND :endDate';
                expressionAttributeValues[':startDate'] = `DATE#${query.startDate}#RIDE#`;
                expressionAttributeValues[':endDate'] = `DATE#${query.endDate}#RIDE#~`;
            }
            else if (query.startDate) {
                keyCondition += ' AND SK >= :startDate';
                expressionAttributeValues[':startDate'] = `DATE#${query.startDate}#RIDE#`;
            }
            else if (query.endDate) {
                keyCondition += ' AND SK <= :endDate';
                expressionAttributeValues[':endDate'] = `DATE#${query.endDate}#RIDE#~`;
            }
        }
        const queryParams = {
            TableName: this.tableName,
            KeyConditionExpression: keyCondition,
            ExpressionAttributeValues: expressionAttributeValues,
            Limit: query.limit || 20,
            ScanIndexForward: true // Sort by date ascending
        };
        if (query.status) {
            queryParams.IndexName = 'GSI2';
        }
        if (query.cursor) {
            queryParams.ExclusiveStartKey = JSON.parse(Buffer.from(query.cursor, 'base64').toString());
        }
        // Add filtering for other attributes
        const filterExpressions = [];
        if (query.rideType) {
            filterExpressions.push('rideType = :rideType');
            expressionAttributeValues[':rideType'] = query.rideType;
        }
        if (query.difficulty) {
            filterExpressions.push('difficulty = :difficulty');
            expressionAttributeValues[':difficulty'] = query.difficulty;
        }
        if (filterExpressions.length > 0) {
            queryParams.FilterExpression = filterExpressions.join(' AND ');
        }
        const result = await this.docClient.send(new lib_dynamodb_1.QueryCommand(queryParams));
        // Get full ride details for each result
        const rides = [];
        if (result.Items) {
            for (const item of result.Items) {
                const fullRide = await this.findById(item.rideId);
                if (fullRide) {
                    rides.push(fullRide);
                }
            }
        }
        let nextCursor;
        if (result.LastEvaluatedKey) {
            nextCursor = Buffer.from(JSON.stringify(result.LastEvaluatedKey)).toString('base64');
        }
        return { rides, nextCursor };
    }
    async update(ride) {
        const rideData = ride.toJSON();
        const now = new Date().toISOString();
        const items = [
            // Update main ride item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}`,
                        SK: `RIDE#${rideData.rideId}`,
                        GSI1PK: `RIDE#${rideData.rideId}`,
                        GSI1SK: 'METADATA',
                        entityType: 'RIDE',
                        ...rideData,
                        updatedAt: now
                    }
                }
            },
            // Update club ride index item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}#RIDES`,
                        SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        GSI2PK: `CLUB#${rideData.clubId}#RIDES#${rideData.status}`,
                        GSI2SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        entityType: 'CLUB_RIDE_INDEX',
                        rideId: rideData.rideId,
                        title: rideData.title,
                        rideType: rideData.rideType,
                        difficulty: rideData.difficulty,
                        status: rideData.status,
                        startDateTime: rideData.startDateTime,
                        currentParticipants: rideData.currentParticipants,
                        maxParticipants: rideData.maxParticipants,
                        createdBy: rideData.createdBy,
                        publishedBy: rideData.publishedBy,
                        publishedAt: rideData.publishedAt,
                        updatedAt: now
                    }
                }
            }
        ];
        await this.docClient.send(new lib_dynamodb_1.TransactWriteCommand({ TransactItems: items }));
    }
    async delete(rideId) {
        // First get the ride to know its club
        const ride = await this.findById(rideId);
        if (!ride) {
            return; // Already deleted
        }
        const rideData = ride.toJSON();
        const items = [
            // Delete main ride item
            {
                Delete: {
                    TableName: this.tableName,
                    Key: {
                        PK: `CLUB#${rideData.clubId}`,
                        SK: `RIDE#${rideId}`
                    }
                }
            },
            // Delete club ride index item
            {
                Delete: {
                    TableName: this.tableName,
                    Key: {
                        PK: `CLUB#${rideData.clubId}#RIDES`,
                        SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideId}`
                    }
                }
            }
        ];
        await this.docClient.send(new lib_dynamodb_1.TransactWriteCommand({ TransactItems: items }));
    }
    // Phase 2.5: Additional methods for completion and summary support
    async findParticipations(rideId) {
        const result = await this.docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: this.tableName,
            KeyConditionExpression: 'PK = :pk AND begins_with(SK, :sk)',
            ExpressionAttributeValues: {
                ':pk': `RIDE#${rideId}#PARTICIPANTS`,
                ':sk': 'PARTICIPANT#'
            }
        }));
        return result.Items?.map(item => item) || [];
    }
    async saveRideSummary(summary) {
        await this.docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: this.tableName,
            Item: {
                PK: `RIDE#${summary.rideId}`,
                SK: 'SUMMARY',
                entityType: 'RIDE_SUMMARY',
                ...summary
            }
        }));
    }
    async findRideSummary(rideId) {
        const result = await this.docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: this.tableName,
            Key: {
                PK: `RIDE#${rideId}`,
                SK: 'SUMMARY'
            }
        }));
        if (!result.Item) {
            return null;
        }
        const { PK, SK, entityType, ...summary } = result.Item;
        return summary;
    }
}
exports.DynamoDBRideRepository = DynamoDBRideRepository;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vZGItcmlkZS1yZXBvc2l0b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1vZGItcmlkZS1yZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHdEQVErQjtBQUMvQiw4Q0FBaUQ7QUFNakQsTUFBYSxzQkFBc0I7SUFJakMsWUFBWSxZQUE0QixFQUFFLFNBQWlCO1FBQ3pELElBQUksQ0FBQyxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQzdCLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLElBQWdCO1FBQzNCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMvQixNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXJDLE1BQU0sS0FBSyxHQUFHO1lBQ1osaUJBQWlCO1lBQ2pCO2dCQUNFLEdBQUcsRUFBRTtvQkFDSCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7b0JBQ3pCLElBQUksRUFBRTt3QkFDSixFQUFFLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxFQUFFO3dCQUM3QixFQUFFLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxFQUFFO3dCQUM3QixNQUFNLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxFQUFFO3dCQUNqQyxNQUFNLEVBQUUsVUFBVTt3QkFDbEIsVUFBVSxFQUFFLE1BQU07d0JBQ2xCLEdBQUcsUUFBUTtxQkFDWjtpQkFDRjthQUNGO1lBQ0QsdUJBQXVCO1lBQ3ZCO2dCQUNFLEdBQUcsRUFBRTtvQkFDSCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7b0JBQ3pCLElBQUksRUFBRTt3QkFDSixFQUFFLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxRQUFRO3dCQUNuQyxFQUFFLEVBQUUsUUFBUSxR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QUFHLE9BQU87YUFDWDtTQUNGLENBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBYztRQUNsQyxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUkseUJBQVUsQ0FBQztZQUN0RCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsR0FBRyxFQUFFO2dCQUNILEVBQUUsRUFBRSxRQUFRLE1BQU0sRUFBRTtnQkFDcEIsRUFBRSxFQUFFLFNBQVM7YUFDZDtTQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUU7WUFDaEIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxHQUFHLE9BQU8sRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDdkQsT0FBTyxPQUFzQixDQUFDO0lBQ2hDLENBQUM7Q0FDRjtBQWhTRCx3REFnU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCwgXG4gIFB1dENvbW1hbmQsIFxuICBHZXRDb21tYW5kLCBcbiAgUXVlcnlDb21tYW5kLCBcbiAgVXBkYXRlQ29tbWFuZCxcbiAgRGVsZXRlQ29tbWFuZCxcbiAgVHJhbnNhY3RXcml0ZUNvbW1hbmRcbn0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFJpZGVFbnRpdHkgfSBmcm9tICcuLi9kb21haW4vcmlkZS9yaWRlJztcbmltcG9ydCB7IFJpZGVSZXBvc2l0b3J5LCBQYWdpbmF0ZWRSaWRlcyB9IGZyb20gJy4uL2RvbWFpbi9yaWRlL3JpZGUtcmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBMaXN0UmlkZXNRdWVyeSwgUmlkZVN0YXR1cyB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC90eXBlcy9yaWRlJztcbmltcG9ydCB7IFJpZGVTdW1tYXJ5IH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL3R5cGVzL3N0cmF2YSc7XG5pbXBvcnQgeyBSaWRlUGFydGljaXBhdGlvbiB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC90eXBlcy9wYXJ0aWNpcGF0aW9uJztcblxuZXhwb3J0IGNsYXNzIER5bmFtb0RCUmlkZVJlcG9zaXRvcnkgaW1wbGVtZW50cyBSaWRlUmVwb3NpdG9yeSB7XG4gIHByaXZhdGUgZG9jQ2xpZW50OiBEeW5hbW9EQkRvY3VtZW50Q2xpZW50O1xuICBwcml2YXRlIHRhYmxlTmFtZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKGR5bmFtb0NsaWVudDogRHluYW1vREJDbGllbnQsIHRhYmxlTmFtZTogc3RyaW5nKSB7XG4gICAgdGhpcy5kb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbiAgICB0aGlzLnRhYmxlTmFtZSA9IHRhYmxlTmFtZTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZShyaWRlOiBSaWRlRW50aXR5KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcmlkZURhdGEgPSByaWRlLnRvSlNPTigpO1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcblxuICAgIGNvbnN0IGl0ZW1zID0gW1xuICAgICAgLy8gTWFpbiByaWRlIGl0ZW1cbiAgICAgIHtcbiAgICAgICAgUHV0OiB7XG4gICAgICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgICBQSzogYENMVUIjJHtyaWRlRGF0YS5jbHViSWR9YCxcbiAgICAgICAgICAgIFNLOiBgUklERSMke3JpZGVEYXRhLnJpZGVJZH1gLFxuICAgICAgICAgICAgR1NJMVBLOiBgUklERSMke3JpZGVEYXRhLnJpZGVJZH1gLFxuICAgICAgICAgICAgR1NJMVNLOiAnTUVUQURBVEEnLFxuICAgICAgICAgICAgZW50aXR5VHlwZTogJ1JJREUnLFxuICAgICAgICAgICAgLi4ucmlkZURhdGFcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICAvLyBDbHViIHJpZGUgaW5kZXggaXRlbVxuICAgICAge1xuICAgICAgICBQdXQ6IHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgIFBLOiBgQ0xVQiMke3JpZGVEYXRhLmNsdWJJZH0jUklERVNgLFxuICAgICAgICAgICAgU0s6IGBEQVRFIyR7cmlkZURhdGEuc3RhcnREYXRlVGltZS5zcGxpdCgnVCcpWzBdfSNSSURFIyR7cmlkZURhdGEucmlkZUlkfWAsXG4gICAgICAgICAgICBHU0kyUEs6IGBDTFVCIyR7cmlkZURhdGEuY2x1YklkfSNSSURFUyMke3JpZGVEYXRhLnN0YXR1c31gLFxuICAgICAgICAgICAgR1NJMlNLOiBgREFURSMke3JpZGVEYXRhLnN0YXJ0RGF0ZVRpbWUuc3BsaXQoJ1QnKVswXX0jUklERSMke3JpZGVEYXRhLnJpZGVJZH1gLFxuICAgICAgICAgICAgZW50aXR5VHlwZTogJ0NMVUJfUklERV9JTkRFWCcsXG4gICAgICAgICAgICByaWRlSWQ6IHJpZGVEYXRhLnJpZGVJZCxcbiAgICAgICAgICAgIHRpdGxlOiByaWRlRGF0YS50aXRsZSxcbiAgICAgICAgICAgIHJpZGVUeXBlOiByaWRlRGF0YS5yaWRlVHlwZSxcbiAgICAgICAgICAgIGRpZmZpY3VsdHk6IHJpZGVEYXRhLmRpZmZpY3VsdHksXG4gICAgICAgICAgICBzdGF0dXM6IHJpZGVEYXRhLnN0YXR1cyxcbiAgICAgICAgICAgIHN0YXJ0RGF0ZVRpbWU6IHJpZGVEYXRhLnN0YXJ0RGF0ZVRpbWUsXG4gICAgICAgICAgICBjdXJyZW50UGFydGljaXBhbnRzOiByaWRlRGF0YS5jdXJyZW50UGFydGljaXBhbnRzLFxuICAgICAgICAgICAgbWF4UGFydGljaXBhbnRzOiByaWRlRGF0YS5tYXhQYXJ0aWNpcGFudHMsXG4gICAgICAgICAgICBjcmVhdGVkQnk6IHJpZGVEYXRhLmNyZWF0ZWRCeSxcbiAgICAgICAgICAgIHB1Ymxpc2hlZEJ5OiByaWRlRGF0YS5wdWJsaXNoZWRCeSxcbiAgICAgICAgICAgIHB1Ymxpc2hlZEF0OiByaWRlRGF0YS5wdWJsaXNoZWRBdFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIF07XG5cbiAgICBhd2FpdCB0aGlzLmRvY0NsaWVudC5zZW5kKG5ldyBUcmFuc2FjdFdyaXRlQ29tbWFuZCh7IFRyYW5zYWN0SXRlbXM6IGl0ZW1zIH0pKTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRCeUlkKHJpZGVJZDogc3RyaW5nKTogUHJvbWlzZTxSaWRlRW50aXR5IHwgbnVsbD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZG9jQ2xpZW50LnNlbmQobmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgSW5kZXhOYW1lOiAnR1NJMScsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnR1NJMVBLID0gOnBrIEFORCBHU0kxU0sgPSA6c2snLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBrJzogYFJJREUjJHtyaWRlSWR9YCxcbiAgICAgICAgJzpzayc6ICdNRVRBREFUQSdcbiAgICAgIH1cbiAgICB9KSk7XG5cbiAgICBpZiAoIXJlc3VsdC5JdGVtcyB8fCByZXN1bHQuSXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBpdGVtID0gcmVzdWx0Lkl0ZW1zWzBdO1xuICAgIHJldHVybiBuZXcgUmlkZUVudGl0eShpdGVtIGFzIGFueSk7XG4gIH1cblxuICBhc3luYyBmaW5kQnlDbHViSWQoY2x1YklkOiBzdHJpbmcsIHF1ZXJ5OiBMaXN0UmlkZXNRdWVyeSk6IFByb21pc2U8UGFnaW5hdGVkUmlkZXM+IHtcbiAgICBsZXQga2V5Q29uZGl0aW9uOiBzdHJpbmc7XG4gICAgbGV0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT47XG5cbiAgICBpZiAocXVlcnkuc3RhdHVzKSB7XG4gICAgICAvLyBRdWVyeSBieSBzdGF0dXMgdXNpbmcgR1NJMlxuICAgICAga2V5Q29uZGl0aW9uID0gJ0dTSTJQSyA9IDpwayc7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzID0ge1xuICAgICAgICAnOnBrJzogYENMVUIjJHtjbHViSWR9I1JJREVTIyR7cXVlcnkuc3RhdHVzfWBcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFF1ZXJ5IGFsbCByaWRlcyBmb3IgY2x1YlxuICAgICAga2V5Q29uZGl0aW9uID0gJ1BLID0gOnBrJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7XG4gICAgICAgICc6cGsnOiBgQ0xVQiMke2NsdWJJZH0jUklERVNgXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEFkZCBkYXRlIGZpbHRlcmluZyBpZiBwcm92aWRlZFxuICAgIGlmIChxdWVyeS5zdGFydERhdGUgfHwgcXVlcnkuZW5kRGF0ZSkge1xuICAgICAgaWYgKHF1ZXJ5LnN0YXJ0RGF0ZSAmJiBxdWVyeS5lbmREYXRlKSB7XG4gICAgICAgIGtleUNvbmRpdGlvbiArPSAnIEFORCBTSyBCRVRXRUVOIDpzdGFydERhdGUgQU5EIDplbmREYXRlJztcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0RGF0ZSddID0gYERBVEUjJHtxdWVyeS5zdGFydERhdGV9I1JJREUjYDtcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmVuZERhdGUnXSA9IGBEQVRFIyR7cXVlcnkuZW5kRGF0ZX0jUklERSN+YDtcbiAgICAgIH0gZWxzZSBpZiAocXVlcnkuc3RhcnREYXRlKSB7XG4gICAgICAgIGtleUNvbmRpdGlvbiArPSAnIEFORCBTSyA+PSA6c3RhcnREYXRlJztcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0RGF0ZSddID0gYERBVEUjJHtxdWVyeS5zdGFydERhdGV9I1JJREUjYDtcbiAgICAgIH0gZWxzZSBpZiAocXVlcnkuZW5kRGF0ZSkge1xuICAgICAgICBrZXlDb25kaXRpb24gKz0gJyBBTkQgU0sgPD0gOmVuZERhdGUnO1xuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kRGF0ZSddID0gYERBVEUjJHtxdWVyeS5lbmREYXRlfSNSSURFI35gO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHF1ZXJ5UGFyYW1zOiBhbnkgPSB7XG4gICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjoga2V5Q29uZGl0aW9uLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIExpbWl0OiBxdWVyeS5saW1pdCB8fCAyMCxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IHRydWUgLy8gU29ydCBieSBkYXRlIGFzY2VuZGluZ1xuICAgIH07XG5cbiAgICBpZiAocXVlcnkuc3RhdHVzKSB7XG4gICAgICBxdWVyeVBhcmFtcy5JbmRleE5hbWUgPSAnR1NJMic7XG4gICAgfVxuXG4gICAgaWYgKHF1ZXJ5LmN1cnNvcikge1xuICAgICAgcXVlcnlQYXJhbXMuRXhjbHVzaXZlU3RhcnRLZXkgPSBKU09OLnBhcnNlKEJ1ZmZlci5mcm9tKHF1ZXJ5LmN1cnNvciwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCkpO1xuICAgIH1cblxuICAgIC8vIEFkZCBmaWx0ZXJpbmcgZm9yIG90aGVyIGF0dHJpYnV0ZXNcbiAgICBjb25zdCBmaWx0ZXJFeHByZXNzaW9uczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAocXVlcnkucmlkZVR5cGUpIHtcbiAgICAgIGZpbHRlckV4cHJlc3Npb25zLnB1c2goJ3JpZGVUeXBlID0gOnJpZGVUeXBlJyk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6cmlkZVR5cGUnXSA9IHF1ZXJ5LnJpZGVUeXBlO1xuICAgIH1cbiAgICBpZiAocXVlcnkuZGlmZmljdWx0eSkge1xuICAgICAgZmlsdGVyRXhwcmVzc2lvbnMucHVzaCgnZGlmZmljdWx0eSA9IDpkaWZmaWN1bHR5Jyk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZGlmZmljdWx0eSddID0gcXVlcnkuZGlmZmljdWx0eTtcbiAgICB9XG5cbiAgICBpZiAoZmlsdGVyRXhwcmVzc2lvbnMubGVuZ3RoID4gMCkge1xuICAgICAgcXVlcnlQYXJhbXMuRmlsdGVyRXhwcmVzc2lvbiA9IGZpbHRlckV4cHJlc3Npb25zLmpvaW4oJyBBTkQgJyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChuZXcgUXVlcnlDb21tYW5kKHF1ZXJ5UGFyYW1zKSk7XG5cbiAgICAvLyBHZXQgZnVsbCByaWRlIGRldGFpbHMgZm9yIGVhY2ggcmVzdWx0XG4gICAgY29uc3QgcmlkZXM6IFJpZGVFbnRpdHlbXSA9IFtdO1xuICAgIGlmIChyZXN1bHQuSXRlbXMpIHtcbiAgICAgIGZvciAoY29uc3QgaXRlbSBvZiByZXN1bHQuSXRlbXMpIHtcbiAgICAgICAgY29uc3QgZnVsbFJpZGUgPSBhd2FpdCB0aGlzLmZpbmRCeUlkKGl0ZW0ucmlkZUlkKTtcbiAgICAgICAgaWYgKGZ1bGxSaWRlKSB7XG4gICAgICAgICAgcmlkZXMucHVzaChmdWxsUmlkZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgbmV4dEN1cnNvcjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGlmIChyZXN1bHQuTGFzdEV2YWx1YXRlZEtleSkge1xuICAgICAgbmV4dEN1cnNvciA9IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHJlc3VsdC5MYXN0RXZhbHVhdGVkS2V5KSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgIH1cblxuICAgIHJldHVybiB7IHJpZGVzLCBuZXh0Q3Vyc29yIH07XG4gIH1cblxuICBhc3luYyB1cGRhdGUocmlkZTogUmlkZUVudGl0eSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJpZGVEYXRhID0gcmlkZS50b0pTT04oKTtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG5cbiAgICBjb25zdCBpdGVtcyA9IFtcbiAgICAgIC8vIFVwZGF0ZSBtYWluIHJpZGUgaXRlbVxuICAgICAge1xuICAgICAgICBQdXQ6IHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgIFBLOiBgQ0xVQiMke3JpZGVEYXRhLmNsdWJJZH1gLFxuICAgICAgICAgICAgU0s6IGBSSURFIyR7cmlkZURhdGEucmlkZUlkfWAsXG4gICAgICAgICAgICBHU0kxUEs6IGBSSURFIyR7cmlkZURhdGEucmlkZUlkfWAsXG4gICAgICAgICAgICBHU0kxU0s6ICdNRVRBREFUQScsXG4gICAgICAgICAgICBlbnRpdHlUeXBlOiAnUklERScsXG4gICAgICAgICAgICAuLi5yaWRlRGF0YSxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogbm93XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgLy8gVXBkYXRlIGNsdWIgcmlkZSBpbmRleCBpdGVtXG4gICAgICB7XG4gICAgICAgIFB1dDoge1xuICAgICAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgICAgICAgSXRlbToge1xuICAgICAgICAgICAgUEs6IGBDTFVCIyR7cmlkZURhdGEuY2x1YklkfSNSSURFU2AsXG4gICAgICAgICAgICBTSzogYERBVEUjJHtyaWRlRGF0YS5zdGFydERhdGVUaW1lLnNwbGl0KCdUJylbMF19I1JJREUjJHtyaWRlRGF0YS5yaWRlSWR9YCxcbiAgICAgICAgICAgIEdTSTJQSzogYENMVUIjJHtyaWRlRGF0YS5jbHViSWR9I1JJREVTIyR7cmlkZURhdGEuc3RhdHVzfWAsXG4gICAgICAgICAgICBHU0kyU0s6IGBEQVRFIyR7cmlkZURhdGEuc3RhcnREYXRlVGltZS5zcGxpdCgnVCcpWzBdfSNSSURFIyR7cmlkZURhdGEucmlkZUlkfWAsXG4gICAgICAgICAgICBlbnRpdHlUeXBlOiAnQ0xVQl9SSURFX0lOREVYJyxcbiAgICAgICAgICAgIHJpZGVJZDogcmlkZURhdGEucmlkZUlkLFxuICAgICAgICAgICAgdGl0bGU6IHJpZGVEYXRhLnRpdGxlLFxuICAgICAgICAgICAgcmlkZVR5cGU6IHJpZGVEYXRhLnJpZGVUeXBlLFxuICAgICAgICAgICAgZGlmZmljdWx0eTogcmlkZURhdGEuZGlmZmljdWx0eSxcbiAgICAgICAgICAgIHN0YXR1czogcmlkZURhdGEuc3RhdHVzLFxuICAgICAgICAgICAgc3RhcnREYXRlVGltZTogcmlkZURhdGEuc3RhcnREYXRlVGltZSxcbiAgICAgICAgICAgIGN1cnJlbnRQYXJ0aWNpcGFudHM6IHJpZGVEYXRhLmN1cnJlbnRQYXJ0aWNpcGFudHMsXG4gICAgICAgICAgICBtYXhQYXJ0aWNpcGFudHM6IHJpZGVEYXRhLm1heFBhcnRpY2lwYW50cyxcbiAgICAgICAgICAgIGNyZWF0ZWRCeTogcmlkZURhdGEuY3JlYXRlZEJ5LFxuICAgICAgICAgICAgcHVibGlzaGVkQnk6IHJpZGVEYXRhLnB1Ymxpc2hlZEJ5LFxuICAgICAgICAgICAgcHVibGlzaGVkQXQ6IHJpZGVEYXRhLnB1Ymxpc2hlZEF0LFxuICAgICAgICAgICAgdXBkYXRlZEF0OiBub3dcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBdO1xuXG4gICAgYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChuZXcgVHJhbnNhY3RXcml0ZUNvbW1hbmQoeyBUcmFuc2FjdEl0ZW1zOiBpdGVtcyB9KSk7XG4gIH1cblxuICBhc3luYyBkZWxldGUocmlkZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBGaXJzdCBnZXQgdGhlIHJpZGUgdG8ga25vdyBpdHMgY2x1YlxuICAgIGNvbnN0IHJpZGUgPSBhd2FpdCB0aGlzLmZpbmRCeUlkKHJpZGVJZCk7XG4gICAgaWYgKCFyaWRlKSB7XG4gICAgICByZXR1cm47IC8vIEFscmVhZHkgZGVsZXRlZFxuICAgIH1cblxuICAgIGNvbnN0IHJpZGVEYXRhID0gcmlkZS50b0pTT04oKTtcblxuICAgIGNvbnN0IGl0ZW1zID0gW1xuICAgICAgLy8gRGVsZXRlIG1haW4gcmlkZSBpdGVtXG4gICAgICB7XG4gICAgICAgIERlbGV0ZToge1xuICAgICAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICBQSzogYENMVUIjJHtyaWRlRGF0YS5jbHViSWR9YCxcbiAgICAgICAgICAgIFNLOiBgUklERSMke3JpZGVJZH1gXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgLy8gRGVsZXRlIGNsdWIgcmlkZSBpbmRleCBpdGVtXG4gICAgICB7XG4gICAgICAgIERlbGV0ZToge1xuICAgICAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICBQSzogYENMVUIjJHtyaWRlRGF0YS5jbHViSWR9I1JJREVTYCxcbiAgICAgICAgICAgIFNLOiBgREFURSMke3JpZGVEYXRhLnN0YXJ0RGF0ZVRpbWUuc3BsaXQoJ1QnKVswXX0jUklERSMke3JpZGVJZH1gXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgXTtcblxuICAgIGF3YWl0IHRoaXMuZG9jQ2xpZW50LnNlbmQobmV3IFRyYW5zYWN0V3JpdGVDb21tYW5kKHsgVHJhbnNhY3RJdGVtczogaXRlbXMgfSkpO1xuICB9XG5cbiAgLy8gUGhhc2UgMi41OiBBZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGNvbXBsZXRpb24gYW5kIHN1bW1hcnkgc3VwcG9ydFxuICBhc3luYyBmaW5kUGFydGljaXBhdGlvbnMocmlkZUlkOiBzdHJpbmcpOiBQcm9taXNlPFJpZGVQYXJ0aWNpcGF0aW9uW10+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdQSyA9IDpwayBBTkQgYmVnaW5zX3dpdGgoU0ssIDpzayknLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBrJzogYFJJREUjJHtyaWRlSWR9I1BBUlRJQ0lQQU5UU2AsXG4gICAgICAgICc6c2snOiAnUEFSVElDSVBBTlQjJ1xuICAgICAgfVxuICAgIH0pKTtcblxuICAgIHJldHVybiByZXN1bHQuSXRlbXM/Lm1hcChpdGVtID0+IGl0ZW0gYXMgUmlkZVBhcnRpY2lwYXRpb24pIHx8IFtdO1xuICB9XG5cbiAgYXN5bmMgc2F2ZVJpZGVTdW1tYXJ5KHN1bW1hcnk6IFJpZGVTdW1tYXJ5KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChuZXcgUHV0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgSXRlbToge1xuICAgICAgICBQSzogYFJJREUjJHtzdW1tYXJ5LnJpZGVJZH1gLFxuICAgICAgICBTSzogJ1NVTU1BUlknLFxuICAgICAgICBlbnRpdHlUeXBlOiAnUklERV9TVU1NQVJZJyxcbiAgICAgICAgLi4uc3VtbWFyeVxuICAgICAgfVxuICAgIH0pKTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRSaWRlU3VtbWFyeShyaWRlSWQ6IHN0cmluZyk6IFByb21pc2U8UmlkZVN1bW1hcnkgfCBudWxsPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgS2V5OiB7XG4gICAgICAgIFBLOiBgUklERSMke3JpZGVJZH1gLFxuICAgICAgICBTSzogJ1NVTU1BUlknXG4gICAgICB9XG4gICAgfSkpO1xuXG4gICAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgeyBQSywgU0ssIGVudGl0eVR5cGUsIC4uLnN1bW1hcnkgfSA9IHJlc3VsdC5JdGVtO1xuICAgIHJldHVybiBzdW1tYXJ5IGFzIFJpZGVTdW1tYXJ5O1xuICB9XG59Il19