"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DynamoDBRideRepository = void 0;
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const ride_1 = require("../domain/ride/ride");
class DynamoDBRideRepository {
    constructor(dynamoClient, tableName) {
        this.docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
        this.tableName = tableName;
    }
    async create(ride) {
        const rideData = ride.toJSON();
        const now = new Date().toISOString();
        const items = [
            // Main ride item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}`,
                        SK: `RIDE#${rideData.rideId}`,
                        GSI1PK: `RIDE#${rideData.rideId}`,
                        GSI1SK: 'METADATA',
                        entityType: 'RIDE',
                        ...rideData
                    }
                }
            },
            // Club ride index item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}#RIDES`,
                        SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        GSI2PK: `CLUB#${rideData.clubId}#RIDES#${rideData.status}`,
                        GSI2SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        entityType: 'CLUB_RIDE_INDEX',
                        rideId: rideData.rideId,
                        title: rideData.title,
                        rideType: rideData.rideType,
                        difficulty: rideData.difficulty,
                        status: rideData.status,
                        startDateTime: rideData.startDateTime,
                        currentParticipants: rideData.currentParticipants,
                        maxParticipants: rideData.maxParticipants,
                        createdBy: rideData.createdBy,
                        publishedBy: rideData.publishedBy,
                        publishedAt: rideData.publishedAt
                    }
                }
            }
        ];
        await this.docClient.send(new lib_dynamodb_1.TransactWriteCommand({ TransactItems: items }));
    }
    async findById(rideId) {
        const result = await this.docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: this.tableName,
            IndexName: 'GSI1',
            KeyConditionExpression: 'GSI1PK = :pk AND GSI1SK = :sk',
            ExpressionAttributeValues: {
                ':pk': `RIDE#${rideId}`,
                ':sk': 'METADATA'
            }
        }));
        if (!result.Items || result.Items.length === 0) {
            return null;
        }
        const item = result.Items[0];
        return new ride_1.RideEntity(item);
    }
    async findByClubId(clubId, query) {
        let keyCondition;
        let expressionAttributeValues;
        let indexName;
        if (query.status) {
            // Query by status using GSI2
            keyCondition = 'GSI2PK = :pk';
            expressionAttributeValues = {
                ':pk': `CLUB#${clubId}#RIDES#${query.status}`
            };
            indexName = 'GSI2';
            // Add date filtering to GSI2SK if provided
            if (query.startDate || query.endDate) {
                if (query.startDate && query.endDate) {
                    keyCondition += ' AND GSI2SK BETWEEN :startDate AND :endDate';
                    expressionAttributeValues[':startDate'] = `DATE#${query.startDate}`;
                    expressionAttributeValues[':endDate'] = `DATE#${query.endDate}~`;
                }
                else if (query.startDate) {
                    keyCondition += ' AND GSI2SK >= :startDate';
                    expressionAttributeValues[':startDate'] = `DATE#${query.startDate}`;
                }
                else if (query.endDate) {
                    keyCondition += ' AND GSI2SK <= :endDate';
                    expressionAttributeValues[':endDate'] = `DATE#${query.endDate}~`;
                }
            }
            else {
                // Must provide sort key condition for GSI2
                keyCondition += ' AND begins_with(GSI2SK, :skPrefix)';
                expressionAttributeValues[':skPrefix'] = 'DATE#';
            }
        }
        else {
            // Query all rides for club using main table
            keyCondition = 'PK = :pk';
            expressionAttributeValues = {
                ':pk': `CLUB#${clubId}#RIDES`
            };
            // Add date filtering to SK if provided
            if (query.startDate || query.endDate) {
                if (query.startDate && query.endDate) {
                    keyCondition += ' AND SK BETWEEN :startDate AND :endDate';
                    expressionAttributeValues[':startDate'] = `DATE#${query.startDate}#RIDE#`;
                    expressionAttributeValues[':endDate'] = `DATE#${query.endDate}#RIDE#~`;
                }
                else if (query.startDate) {
                    keyCondition += ' AND SK >= :startDate';
                    expressionAttributeValues[':startDate'] = `DATE#${query.startDate}#RIDE#`;
                }
                else if (query.endDate) {
                    keyCondition += ' AND SK <= :endDate';
                    expressionAttributeValues[':endDate'] = `DATE#${query.endDate}#RIDE#~`;
                }
            }
        }
        const queryParams = {
            TableName: this.tableName,
            KeyConditionExpression: keyCondition,
            ExpressionAttributeValues: expressionAttributeValues,
            Limit: query.limit || 20,
            ScanIndexForward: true // Sort by date ascending
        };
        if (indexName) {
            queryParams.IndexName = indexName;
        }
        if (query.cursor) {
            queryParams.ExclusiveStartKey = JSON.parse(Buffer.from(query.cursor, 'base64').toString());
        }
        // Add filtering for other attributes
        const filterExpressions = [];
        if (query.rideType) {
            filterExpressions.push('rideType = :rideType');
            expressionAttributeValues[':rideType'] = query.rideType;
        }
        if (query.difficulty) {
            filterExpressions.push('difficulty = :difficulty');
            expressionAttributeValues[':difficulty'] = query.difficulty;
        }
        if (filterExpressions.length > 0) {
            queryParams.FilterExpression = filterExpressions.join(' AND ');
        }
        const result = await this.docClient.send(new lib_dynamodb_1.QueryCommand(queryParams));
        // Get full ride details for each result
        const rides = [];
        if (result.Items) {
            for (const item of result.Items) {
                const fullRide = await this.findById(item.rideId);
                if (fullRide) {
                    rides.push(fullRide);
                }
            }
        }
        let nextCursor;
        if (result.LastEvaluatedKey) {
            nextCursor = Buffer.from(JSON.stringify(result.LastEvaluatedKey)).toString('base64');
        }
        return { rides, nextCursor };
    }
    async update(ride) {
        const rideData = ride.toJSON();
        const now = new Date().toISOString();
        const items = [
            // Update main ride item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}`,
                        SK: `RIDE#${rideData.rideId}`,
                        GSI1PK: `RIDE#${rideData.rideId}`,
                        GSI1SK: 'METADATA',
                        entityType: 'RIDE',
                        ...rideData,
                        updatedAt: now
                    }
                }
            },
            // Update club ride index item
            {
                Put: {
                    TableName: this.tableName,
                    Item: {
                        PK: `CLUB#${rideData.clubId}#RIDES`,
                        SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        GSI2PK: `CLUB#${rideData.clubId}#RIDES#${rideData.status}`,
                        GSI2SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideData.rideId}`,
                        entityType: 'CLUB_RIDE_INDEX',
                        rideId: rideData.rideId,
                        title: rideData.title,
                        rideType: rideData.rideType,
                        difficulty: rideData.difficulty,
                        status: rideData.status,
                        startDateTime: rideData.startDateTime,
                        currentParticipants: rideData.currentParticipants,
                        maxParticipants: rideData.maxParticipants,
                        createdBy: rideData.createdBy,
                        publishedBy: rideData.publishedBy,
                        publishedAt: rideData.publishedAt,
                        updatedAt: now
                    }
                }
            }
        ];
        await this.docClient.send(new lib_dynamodb_1.TransactWriteCommand({ TransactItems: items }));
    }
    async delete(rideId) {
        // First get the ride to know its club
        const ride = await this.findById(rideId);
        if (!ride) {
            return; // Already deleted
        }
        const rideData = ride.toJSON();
        const items = [
            // Delete main ride item
            {
                Delete: {
                    TableName: this.tableName,
                    Key: {
                        PK: `CLUB#${rideData.clubId}`,
                        SK: `RIDE#${rideId}`
                    }
                }
            },
            // Delete club ride index item
            {
                Delete: {
                    TableName: this.tableName,
                    Key: {
                        PK: `CLUB#${rideData.clubId}#RIDES`,
                        SK: `DATE#${rideData.startDateTime.split('T')[0]}#RIDE#${rideId}`
                    }
                }
            }
        ];
        await this.docClient.send(new lib_dynamodb_1.TransactWriteCommand({ TransactItems: items }));
    }
    // Phase 2.5: Additional methods for completion and summary support
    async findParticipations(rideId) {
        const result = await this.docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: this.tableName,
            KeyConditionExpression: 'PK = :pk AND begins_with(SK, :sk)',
            ExpressionAttributeValues: {
                ':pk': `RIDE#${rideId}#PARTICIPANTS`,
                ':sk': 'PARTICIPANT#'
            }
        }));
        return result.Items?.map(item => item) || [];
    }
    async saveRideSummary(summary) {
        await this.docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: this.tableName,
            Item: {
                PK: `RIDE#${summary.rideId}`,
                SK: 'SUMMARY',
                entityType: 'RIDE_SUMMARY',
                ...summary
            }
        }));
    }
    async findRideSummary(rideId) {
        const result = await this.docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: this.tableName,
            Key: {
                PK: `RIDE#${rideId}`,
                SK: 'SUMMARY'
            }
        }));
        if (!result.Item) {
            return null;
        }
        const { PK, SK, entityType, ...summary } = result.Item;
        return summary;
    }
}
exports.DynamoDBRideRepository = DynamoDBRideRepository;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vZGItcmlkZS1yZXBvc2l0b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1vZGItcmlkZS1yZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHdEQVErQjtBQUMvQiw4Q0FBaUQ7QUFNakQsTUFBYSxzQkFBc0I7SUFJakMsWUFBWSxZQUE0QixFQUFFLFNBQWlCO1FBQ3pELElBQUksQ0FBQyxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQzdCLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLElBQWdCO1FBQzNCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMvQixNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXJDLE1BQU0sS0FBSyxHQUFHO1lBQ1osaUJBQWlCO1lBQ2pCO2dCQUNFLEdBQUcsRUFBRTtvQkFDSCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7b0JBQ3pCLElBQUksRUFBRTt3QkFDSixFQUFFLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxFQUFFO3dCQUM3QixFQUFFLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxFQUFFO3dCQUM3QixNQUFNLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxFQUFFO3dCQUNqQyxNQUFNLEVBQUUsVUFBVTt3QkFDbEIsVUFBVSxFQUFFLE1BQU07d0JBQ2xCLEdBQUcsUUFBUTtxQkFDWjtpQkFDRjthQUNGO1lBQ0QsdUJBQXVCO1lBQ3ZCO2dCQUNFLEdBQUcsRUFBRTtvQkFDSCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7b0JBQ3pCLElBQUksRUFBRTt3QkFDSixFQUFFLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxRQUFRO3dCQUNuQyxFQUFFLEVBQUUsUUFBUSxR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QUFNLEVBQUU7Z0JBQ3BCLEVBQUUsRUFBRSxTQUFTO2FBQ2Q7U0FDRixDQUFDLENBQUMsQ0FBQztRQUVKLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFFRCxNQUFNLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsR0FBRyxPQUFPLEVBQUUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3ZELE9BQU8sT0FBc0IsQ0FBQztJQUNoQyxDQUFDO0NBQ0Y7QUFyVEQsd0RBcVRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgXG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFxuICBQdXRDb21tYW5kLCBcbiAgR2V0Q29tbWFuZCwgXG4gIFF1ZXJ5Q29tbWFuZCwgXG4gIFVwZGF0ZUNvbW1hbmQsXG4gIERlbGV0ZUNvbW1hbmQsXG4gIFRyYW5zYWN0V3JpdGVDb21tYW5kXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBSaWRlRW50aXR5IH0gZnJvbSAnLi4vZG9tYWluL3JpZGUvcmlkZSc7XG5pbXBvcnQgeyBSaWRlUmVwb3NpdG9yeSwgUGFnaW5hdGVkUmlkZXMgfSBmcm9tICcuLi9kb21haW4vcmlkZS9yaWRlLXJlcG9zaXRvcnknO1xuaW1wb3J0IHsgTGlzdFJpZGVzUXVlcnksIFJpZGVTdGF0dXMgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdHlwZXMvcmlkZSc7XG5pbXBvcnQgeyBSaWRlU3VtbWFyeSB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC90eXBlcy9zdHJhdmEnO1xuaW1wb3J0IHsgUmlkZVBhcnRpY2lwYXRpb24gfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdHlwZXMvcGFydGljaXBhdGlvbic7XG5cbmV4cG9ydCBjbGFzcyBEeW5hbW9EQlJpZGVSZXBvc2l0b3J5IGltcGxlbWVudHMgUmlkZVJlcG9zaXRvcnkge1xuICBwcml2YXRlIGRvY0NsaWVudDogRHluYW1vREJEb2N1bWVudENsaWVudDtcbiAgcHJpdmF0ZSB0YWJsZU5hbWU6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihkeW5hbW9DbGllbnQ6IER5bmFtb0RCQ2xpZW50LCB0YWJsZU5hbWU6IHN0cmluZykge1xuICAgIHRoaXMuZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGR5bmFtb0NsaWVudCk7XG4gICAgdGhpcy50YWJsZU5hbWUgPSB0YWJsZU5hbWU7XG4gIH1cblxuICBhc3luYyBjcmVhdGUocmlkZTogUmlkZUVudGl0eSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJpZGVEYXRhID0gcmlkZS50b0pTT04oKTtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG5cbiAgICBjb25zdCBpdGVtcyA9IFtcbiAgICAgIC8vIE1haW4gcmlkZSBpdGVtXG4gICAgICB7XG4gICAgICAgIFB1dDoge1xuICAgICAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgICAgICAgSXRlbToge1xuICAgICAgICAgICAgUEs6IGBDTFVCIyR7cmlkZURhdGEuY2x1YklkfWAsXG4gICAgICAgICAgICBTSzogYFJJREUjJHtyaWRlRGF0YS5yaWRlSWR9YCxcbiAgICAgICAgICAgIEdTSTFQSzogYFJJREUjJHtyaWRlRGF0YS5yaWRlSWR9YCxcbiAgICAgICAgICAgIEdTSTFTSzogJ01FVEFEQVRBJyxcbiAgICAgICAgICAgIGVudGl0eVR5cGU6ICdSSURFJyxcbiAgICAgICAgICAgIC4uLnJpZGVEYXRhXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgLy8gQ2x1YiByaWRlIGluZGV4IGl0ZW1cbiAgICAgIHtcbiAgICAgICAgUHV0OiB7XG4gICAgICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgICBQSzogYENMVUIjJHtyaWRlRGF0YS5jbHViSWR9I1JJREVTYCxcbiAgICAgICAgICAgIFNLOiBgREFURSMke3JpZGVEYXRhLnN0YXJ0RGF0ZVRpbWUuc3BsaXQoJ1QnKVswXX0jUklERSMke3JpZGVEYXRhLnJpZGVJZH1gLFxuICAgICAgICAgICAgR1NJMlBLOiBgQ0xVQiMke3JpZGVEYXRhLmNsdWJJZH0jUklERVMjJHtyaWRlRGF0YS5zdGF0dXN9YCxcbiAgICAgICAgICAgIEdTSTJTSzogYERBVEUjJHtyaWRlRGF0YS5zdGFydERhdGVUaW1lLnNwbGl0KCdUJylbMF19I1JJREUjJHtyaWRlRGF0YS5yaWRlSWR9YCxcbiAgICAgICAgICAgIGVudGl0eVR5cGU6ICdDTFVCX1JJREVfSU5ERVgnLFxuICAgICAgICAgICAgcmlkZUlkOiByaWRlRGF0YS5yaWRlSWQsXG4gICAgICAgICAgICB0aXRsZTogcmlkZURhdGEudGl0bGUsXG4gICAgICAgICAgICByaWRlVHlwZTogcmlkZURhdGEucmlkZVR5cGUsXG4gICAgICAgICAgICBkaWZmaWN1bHR5OiByaWRlRGF0YS5kaWZmaWN1bHR5LFxuICAgICAgICAgICAgc3RhdHVzOiByaWRlRGF0YS5zdGF0dXMsXG4gICAgICAgICAgICBzdGFydERhdGVUaW1lOiByaWRlRGF0YS5zdGFydERhdGVUaW1lLFxuICAgICAgICAgICAgY3VycmVudFBhcnRpY2lwYW50czogcmlkZURhdGEuY3VycmVudFBhcnRpY2lwYW50cyxcbiAgICAgICAgICAgIG1heFBhcnRpY2lwYW50czogcmlkZURhdGEubWF4UGFydGljaXBhbnRzLFxuICAgICAgICAgICAgY3JlYXRlZEJ5OiByaWRlRGF0YS5jcmVhdGVkQnksXG4gICAgICAgICAgICBwdWJsaXNoZWRCeTogcmlkZURhdGEucHVibGlzaGVkQnksXG4gICAgICAgICAgICBwdWJsaXNoZWRBdDogcmlkZURhdGEucHVibGlzaGVkQXRcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBdO1xuXG4gICAgYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChuZXcgVHJhbnNhY3RXcml0ZUNvbW1hbmQoeyBUcmFuc2FjdEl0ZW1zOiBpdGVtcyB9KSk7XG4gIH1cblxuICBhc3luYyBmaW5kQnlJZChyaWRlSWQ6IHN0cmluZyk6IFByb21pc2U8UmlkZUVudGl0eSB8IG51bGw+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEluZGV4TmFtZTogJ0dTSTEnLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ0dTSTFQSyA9IDpwayBBTkQgR1NJMVNLID0gOnNrJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IGBSSURFIyR7cmlkZUlkfWAsXG4gICAgICAgICc6c2snOiAnTUVUQURBVEEnXG4gICAgICB9XG4gICAgfSkpO1xuXG4gICAgaWYgKCFyZXN1bHQuSXRlbXMgfHwgcmVzdWx0Lkl0ZW1zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgaXRlbSA9IHJlc3VsdC5JdGVtc1swXTtcbiAgICByZXR1cm4gbmV3IFJpZGVFbnRpdHkoaXRlbSBhcyBhbnkpO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5Q2x1YklkKGNsdWJJZDogc3RyaW5nLCBxdWVyeTogTGlzdFJpZGVzUXVlcnkpOiBQcm9taXNlPFBhZ2luYXRlZFJpZGVzPiB7XG4gICAgbGV0IGtleUNvbmRpdGlvbjogc3RyaW5nO1xuICAgIGxldCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICAgIGxldCBpbmRleE5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIGlmIChxdWVyeS5zdGF0dXMpIHtcbiAgICAgIC8vIFF1ZXJ5IGJ5IHN0YXR1cyB1c2luZyBHU0kyXG4gICAgICBrZXlDb25kaXRpb24gPSAnR1NJMlBLID0gOnBrJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7XG4gICAgICAgICc6cGsnOiBgQ0xVQiMke2NsdWJJZH0jUklERVMjJHtxdWVyeS5zdGF0dXN9YFxuICAgICAgfTtcbiAgICAgIGluZGV4TmFtZSA9ICdHU0kyJztcblxuICAgICAgLy8gQWRkIGRhdGUgZmlsdGVyaW5nIHRvIEdTSTJTSyBpZiBwcm92aWRlZFxuICAgICAgaWYgKHF1ZXJ5LnN0YXJ0RGF0ZSB8fCBxdWVyeS5lbmREYXRlKSB7XG4gICAgICAgIGlmIChxdWVyeS5zdGFydERhdGUgJiYgcXVlcnkuZW5kRGF0ZSkge1xuICAgICAgICAgIGtleUNvbmRpdGlvbiArPSAnIEFORCBHU0kyU0sgQkVUV0VFTiA6c3RhcnREYXRlIEFORCA6ZW5kRGF0ZSc7XG4gICAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0RGF0ZSddID0gYERBVEUjJHtxdWVyeS5zdGFydERhdGV9YDtcbiAgICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kRGF0ZSddID0gYERBVEUjJHtxdWVyeS5lbmREYXRlfX5gO1xuICAgICAgICB9IGVsc2UgaWYgKHF1ZXJ5LnN0YXJ0RGF0ZSkge1xuICAgICAgICAgIGtleUNvbmRpdGlvbiArPSAnIEFORCBHU0kyU0sgPj0gOnN0YXJ0RGF0ZSc7XG4gICAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0RGF0ZSddID0gYERBVEUjJHtxdWVyeS5zdGFydERhdGV9YDtcbiAgICAgICAgfSBlbHNlIGlmIChxdWVyeS5lbmREYXRlKSB7XG4gICAgICAgICAga2V5Q29uZGl0aW9uICs9ICcgQU5EIEdTSTJTSyA8PSA6ZW5kRGF0ZSc7XG4gICAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmVuZERhdGUnXSA9IGBEQVRFIyR7cXVlcnkuZW5kRGF0ZX1+YDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gTXVzdCBwcm92aWRlIHNvcnQga2V5IGNvbmRpdGlvbiBmb3IgR1NJMlxuICAgICAgICBrZXlDb25kaXRpb24gKz0gJyBBTkQgYmVnaW5zX3dpdGgoR1NJMlNLLCA6c2tQcmVmaXgpJztcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnNrUHJlZml4J10gPSAnREFURSMnO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBRdWVyeSBhbGwgcmlkZXMgZm9yIGNsdWIgdXNpbmcgbWFpbiB0YWJsZVxuICAgICAga2V5Q29uZGl0aW9uID0gJ1BLID0gOnBrJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7XG4gICAgICAgICc6cGsnOiBgQ0xVQiMke2NsdWJJZH0jUklERVNgXG4gICAgICB9O1xuXG4gICAgICAvLyBBZGQgZGF0ZSBmaWx0ZXJpbmcgdG8gU0sgaWYgcHJvdmlkZWRcbiAgICAgIGlmIChxdWVyeS5zdGFydERhdGUgfHwgcXVlcnkuZW5kRGF0ZSkge1xuICAgICAgICBpZiAocXVlcnkuc3RhcnREYXRlICYmIHF1ZXJ5LmVuZERhdGUpIHtcbiAgICAgICAgICBrZXlDb25kaXRpb24gKz0gJyBBTkQgU0sgQkVUV0VFTiA6c3RhcnREYXRlIEFORCA6ZW5kRGF0ZSc7XG4gICAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0RGF0ZSddID0gYERBVEUjJHtxdWVyeS5zdGFydERhdGV9I1JJREUjYDtcbiAgICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kRGF0ZSddID0gYERBVEUjJHtxdWVyeS5lbmREYXRlfSNSSURFI35gO1xuICAgICAgICB9IGVsc2UgaWYgKHF1ZXJ5LnN0YXJ0RGF0ZSkge1xuICAgICAgICAgIGtleUNvbmRpdGlvbiArPSAnIEFORCBTSyA+PSA6c3RhcnREYXRlJztcbiAgICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6c3RhcnREYXRlJ10gPSBgREFURSMke3F1ZXJ5LnN0YXJ0RGF0ZX0jUklERSNgO1xuICAgICAgICB9IGVsc2UgaWYgKHF1ZXJ5LmVuZERhdGUpIHtcbiAgICAgICAgICBrZXlDb25kaXRpb24gKz0gJyBBTkQgU0sgPD0gOmVuZERhdGUnO1xuICAgICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzplbmREYXRlJ10gPSBgREFURSMke3F1ZXJ5LmVuZERhdGV9I1JJREUjfmA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBxdWVyeVBhcmFtczogYW55ID0ge1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246IGtleUNvbmRpdGlvbixcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICBMaW1pdDogcXVlcnkubGltaXQgfHwgMjAsXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiB0cnVlIC8vIFNvcnQgYnkgZGF0ZSBhc2NlbmRpbmdcbiAgICB9O1xuXG4gICAgaWYgKGluZGV4TmFtZSkge1xuICAgICAgcXVlcnlQYXJhbXMuSW5kZXhOYW1lID0gaW5kZXhOYW1lO1xuICAgIH1cblxuICAgIGlmIChxdWVyeS5jdXJzb3IpIHtcbiAgICAgIHF1ZXJ5UGFyYW1zLkV4Y2x1c2l2ZVN0YXJ0S2V5ID0gSlNPTi5wYXJzZShCdWZmZXIuZnJvbShxdWVyeS5jdXJzb3IsICdiYXNlNjQnKS50b1N0cmluZygpKTtcbiAgICB9XG5cbiAgICAvLyBBZGQgZmlsdGVyaW5nIGZvciBvdGhlciBhdHRyaWJ1dGVzXG4gICAgY29uc3QgZmlsdGVyRXhwcmVzc2lvbnM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHF1ZXJ5LnJpZGVUeXBlKSB7XG4gICAgICBmaWx0ZXJFeHByZXNzaW9ucy5wdXNoKCdyaWRlVHlwZSA9IDpyaWRlVHlwZScpO1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnJpZGVUeXBlJ10gPSBxdWVyeS5yaWRlVHlwZTtcbiAgICB9XG4gICAgaWYgKHF1ZXJ5LmRpZmZpY3VsdHkpIHtcbiAgICAgIGZpbHRlckV4cHJlc3Npb25zLnB1c2goJ2RpZmZpY3VsdHkgPSA6ZGlmZmljdWx0eScpO1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmRpZmZpY3VsdHknXSA9IHF1ZXJ5LmRpZmZpY3VsdHk7XG4gICAgfVxuXG4gICAgaWYgKGZpbHRlckV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIHF1ZXJ5UGFyYW1zLkZpbHRlckV4cHJlc3Npb24gPSBmaWx0ZXJFeHByZXNzaW9ucy5qb2luKCcgQU5EICcpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZG9jQ2xpZW50LnNlbmQobmV3IFF1ZXJ5Q29tbWFuZChxdWVyeVBhcmFtcykpO1xuXG4gICAgLy8gR2V0IGZ1bGwgcmlkZSBkZXRhaWxzIGZvciBlYWNoIHJlc3VsdFxuICAgIGNvbnN0IHJpZGVzOiBSaWRlRW50aXR5W10gPSBbXTtcbiAgICBpZiAocmVzdWx0Lkl0ZW1zKSB7XG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmVzdWx0Lkl0ZW1zKSB7XG4gICAgICAgIGNvbnN0IGZ1bGxSaWRlID0gYXdhaXQgdGhpcy5maW5kQnlJZChpdGVtLnJpZGVJZCk7XG4gICAgICAgIGlmIChmdWxsUmlkZSkge1xuICAgICAgICAgIHJpZGVzLnB1c2goZnVsbFJpZGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IG5leHRDdXJzb3I6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBpZiAocmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXkpIHtcbiAgICAgIG5leHRDdXJzb3IgPSBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShyZXN1bHQuTGFzdEV2YWx1YXRlZEtleSkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgICB9XG5cbiAgICByZXR1cm4geyByaWRlcywgbmV4dEN1cnNvciB9O1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlKHJpZGU6IFJpZGVFbnRpdHkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByaWRlRGF0YSA9IHJpZGUudG9KU09OKCk7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuXG4gICAgY29uc3QgaXRlbXMgPSBbXG4gICAgICAvLyBVcGRhdGUgbWFpbiByaWRlIGl0ZW1cbiAgICAgIHtcbiAgICAgICAgUHV0OiB7XG4gICAgICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgICBQSzogYENMVUIjJHtyaWRlRGF0YS5jbHViSWR9YCxcbiAgICAgICAgICAgIFNLOiBgUklERSMke3JpZGVEYXRhLnJpZGVJZH1gLFxuICAgICAgICAgICAgR1NJMVBLOiBgUklERSMke3JpZGVEYXRhLnJpZGVJZH1gLFxuICAgICAgICAgICAgR1NJMVNLOiAnTUVUQURBVEEnLFxuICAgICAgICAgICAgZW50aXR5VHlwZTogJ1JJREUnLFxuICAgICAgICAgICAgLi4ucmlkZURhdGEsXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IG5vd1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIC8vIFVwZGF0ZSBjbHViIHJpZGUgaW5kZXggaXRlbVxuICAgICAge1xuICAgICAgICBQdXQ6IHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgIFBLOiBgQ0xVQiMke3JpZGVEYXRhLmNsdWJJZH0jUklERVNgLFxuICAgICAgICAgICAgU0s6IGBEQVRFIyR7cmlkZURhdGEuc3RhcnREYXRlVGltZS5zcGxpdCgnVCcpWzBdfSNSSURFIyR7cmlkZURhdGEucmlkZUlkfWAsXG4gICAgICAgICAgICBHU0kyUEs6IGBDTFVCIyR7cmlkZURhdGEuY2x1YklkfSNSSURFUyMke3JpZGVEYXRhLnN0YXR1c31gLFxuICAgICAgICAgICAgR1NJMlNLOiBgREFURSMke3JpZGVEYXRhLnN0YXJ0RGF0ZVRpbWUuc3BsaXQoJ1QnKVswXX0jUklERSMke3JpZGVEYXRhLnJpZGVJZH1gLFxuICAgICAgICAgICAgZW50aXR5VHlwZTogJ0NMVUJfUklERV9JTkRFWCcsXG4gICAgICAgICAgICByaWRlSWQ6IHJpZGVEYXRhLnJpZGVJZCxcbiAgICAgICAgICAgIHRpdGxlOiByaWRlRGF0YS50aXRsZSxcbiAgICAgICAgICAgIHJpZGVUeXBlOiByaWRlRGF0YS5yaWRlVHlwZSxcbiAgICAgICAgICAgIGRpZmZpY3VsdHk6IHJpZGVEYXRhLmRpZmZpY3VsdHksXG4gICAgICAgICAgICBzdGF0dXM6IHJpZGVEYXRhLnN0YXR1cyxcbiAgICAgICAgICAgIHN0YXJ0RGF0ZVRpbWU6IHJpZGVEYXRhLnN0YXJ0RGF0ZVRpbWUsXG4gICAgICAgICAgICBjdXJyZW50UGFydGljaXBhbnRzOiByaWRlRGF0YS5jdXJyZW50UGFydGljaXBhbnRzLFxuICAgICAgICAgICAgbWF4UGFydGljaXBhbnRzOiByaWRlRGF0YS5tYXhQYXJ0aWNpcGFudHMsXG4gICAgICAgICAgICBjcmVhdGVkQnk6IHJpZGVEYXRhLmNyZWF0ZWRCeSxcbiAgICAgICAgICAgIHB1Ymxpc2hlZEJ5OiByaWRlRGF0YS5wdWJsaXNoZWRCeSxcbiAgICAgICAgICAgIHB1Ymxpc2hlZEF0OiByaWRlRGF0YS5wdWJsaXNoZWRBdCxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogbm93XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgXTtcblxuICAgIGF3YWl0IHRoaXMuZG9jQ2xpZW50LnNlbmQobmV3IFRyYW5zYWN0V3JpdGVDb21tYW5kKHsgVHJhbnNhY3RJdGVtczogaXRlbXMgfSkpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlKHJpZGVJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gRmlyc3QgZ2V0IHRoZSByaWRlIHRvIGtub3cgaXRzIGNsdWJcbiAgICBjb25zdCByaWRlID0gYXdhaXQgdGhpcy5maW5kQnlJZChyaWRlSWQpO1xuICAgIGlmICghcmlkZSkge1xuICAgICAgcmV0dXJuOyAvLyBBbHJlYWR5IGRlbGV0ZWRcbiAgICB9XG5cbiAgICBjb25zdCByaWRlRGF0YSA9IHJpZGUudG9KU09OKCk7XG5cbiAgICBjb25zdCBpdGVtcyA9IFtcbiAgICAgIC8vIERlbGV0ZSBtYWluIHJpZGUgaXRlbVxuICAgICAge1xuICAgICAgICBEZWxldGU6IHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgUEs6IGBDTFVCIyR7cmlkZURhdGEuY2x1YklkfWAsXG4gICAgICAgICAgICBTSzogYFJJREUjJHtyaWRlSWR9YFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIC8vIERlbGV0ZSBjbHViIHJpZGUgaW5kZXggaXRlbVxuICAgICAge1xuICAgICAgICBEZWxldGU6IHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgUEs6IGBDTFVCIyR7cmlkZURhdGEuY2x1YklkfSNSSURFU2AsXG4gICAgICAgICAgICBTSzogYERBVEUjJHtyaWRlRGF0YS5zdGFydERhdGVUaW1lLnNwbGl0KCdUJylbMF19I1JJREUjJHtyaWRlSWR9YFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIF07XG5cbiAgICBhd2FpdCB0aGlzLmRvY0NsaWVudC5zZW5kKG5ldyBUcmFuc2FjdFdyaXRlQ29tbWFuZCh7IFRyYW5zYWN0SXRlbXM6IGl0ZW1zIH0pKTtcbiAgfVxuXG4gIC8vIFBoYXNlIDIuNTogQWRkaXRpb25hbCBtZXRob2RzIGZvciBjb21wbGV0aW9uIGFuZCBzdW1tYXJ5IHN1cHBvcnRcbiAgYXN5bmMgZmluZFBhcnRpY2lwYXRpb25zKHJpZGVJZDogc3RyaW5nKTogUHJvbWlzZTxSaWRlUGFydGljaXBhdGlvbltdPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnUEsgPSA6cGsgQU5EIGJlZ2luc193aXRoKFNLLCA6c2spJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IGBSSURFIyR7cmlkZUlkfSNQQVJUSUNJUEFOVFNgLFxuICAgICAgICAnOnNrJzogJ1BBUlRJQ0lQQU5UIydcbiAgICAgIH1cbiAgICB9KSk7XG5cbiAgICByZXR1cm4gcmVzdWx0Lkl0ZW1zPy5tYXAoaXRlbSA9PiBpdGVtIGFzIFJpZGVQYXJ0aWNpcGF0aW9uKSB8fCBbXTtcbiAgfVxuXG4gIGFzeW5jIHNhdmVSaWRlU3VtbWFyeShzdW1tYXJ5OiBSaWRlU3VtbWFyeSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuZG9jQ2xpZW50LnNlbmQobmV3IFB1dENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEl0ZW06IHtcbiAgICAgICAgUEs6IGBSSURFIyR7c3VtbWFyeS5yaWRlSWR9YCxcbiAgICAgICAgU0s6ICdTVU1NQVJZJyxcbiAgICAgICAgZW50aXR5VHlwZTogJ1JJREVfU1VNTUFSWScsXG4gICAgICAgIC4uLnN1bW1hcnlcbiAgICAgIH1cbiAgICB9KSk7XG4gIH1cblxuICBhc3luYyBmaW5kUmlkZVN1bW1hcnkocmlkZUlkOiBzdHJpbmcpOiBQcm9taXNlPFJpZGVTdW1tYXJ5IHwgbnVsbD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZG9jQ2xpZW50LnNlbmQobmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEtleToge1xuICAgICAgICBQSzogYFJJREUjJHtyaWRlSWR9YCxcbiAgICAgICAgU0s6ICdTVU1NQVJZJ1xuICAgICAgfVxuICAgIH0pKTtcblxuICAgIGlmICghcmVzdWx0Lkl0ZW0pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHsgUEssIFNLLCBlbnRpdHlUeXBlLCAuLi5zdW1tYXJ5IH0gPSByZXN1bHQuSXRlbTtcbiAgICByZXR1cm4gc3VtbWFyeSBhcyBSaWRlU3VtbWFyeTtcbiAgfVxufSJdfQ==