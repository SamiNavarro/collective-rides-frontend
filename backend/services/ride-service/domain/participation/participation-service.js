"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ParticipationService = void 0;
const participation_1 = require("./participation");
const participation_2 = require("../../../../shared/types/participation");
const ride_1 = require("../../../../shared/types/ride");
const participation_errors_1 = require("./participation-errors");
const ride_errors_1 = require("../ride/ride-errors");
class ParticipationService {
    constructor(participationRepository, rideRepository) {
        this.participationRepository = participationRepository;
        this.rideRepository = rideRepository;
    }
    async joinRide(rideId, userId, request) {
        // Get ride and validate
        const ride = await this.rideRepository.findById(rideId);
        if (!ride) {
            throw new ride_errors_1.RideNotFoundError(rideId);
        }
        // Check if user is already participating (ignore withdrawn/removed)
        const existingParticipation = await this.participationRepository.findByRideAndUser(rideId, userId);
        if (existingParticipation &&
            existingParticipation.status !== participation_2.ParticipationStatus.WITHDRAWN &&
            existingParticipation.status !== participation_2.ParticipationStatus.REMOVED) {
            throw new participation_errors_1.AlreadyParticipatingError(userId, rideId);
        }
        // Check if ride can accept participants
        if (ride.status !== ride_1.RideStatus.PUBLISHED) {
            throw new Error('Can only join published rides');
        }
        let participation;
        if (ride.canAcceptParticipants()) {
            // Join as confirmed participant
            participation = participation_1.ParticipationEntity.create(rideId, ride.clubId, userId, request, participation_2.ParticipationStatus.CONFIRMED);
            // Update ride participant count
            ride.incrementParticipants();
            await this.rideRepository.update(ride);
        }
        else if (ride.isWaitlistAvailable()) {
            // Join waitlist
            const waitlistPosition = await this.participationRepository.getWaitlistPosition(rideId) + 1;
            participation = participation_1.ParticipationEntity.create(rideId, ride.clubId, userId, request, participation_2.ParticipationStatus.WAITLISTED, waitlistPosition);
            // Update ride waitlist count
            ride.incrementWaitlist();
            await this.rideRepository.update(ride);
        }
        else {
            throw new participation_errors_1.RideFullError(rideId);
        }
        await this.participationRepository.create(participation);
        return participation;
    }
    async leaveRide(rideId, userId) {
        const participation = await this.participationRepository.findByRideAndUser(rideId, userId);
        if (!participation) {
            throw new participation_errors_1.ParticipationNotFoundError(`${rideId}:${userId}`);
        }
        // Check if already withdrawn or removed
        if (participation.status === participation_2.ParticipationStatus.WITHDRAWN ||
            participation.status === participation_2.ParticipationStatus.REMOVED) {
            throw new participation_errors_1.ParticipationNotFoundError(`${rideId}:${userId}`);
        }
        // Cannot remove captain without transferring role
        if (participation.role === participation_2.RideRole.CAPTAIN) {
            throw new participation_errors_1.CannotRemoveCaptainError();
        }
        const ride = await this.rideRepository.findById(rideId);
        if (!ride) {
            throw new ride_errors_1.RideNotFoundError(rideId);
        }
        // Store the current status before withdrawing
        const previousStatus = participation.status;
        participation.withdraw();
        await this.participationRepository.update(participation);
        // Update ride counts based on previous status
        if (previousStatus === participation_2.ParticipationStatus.CONFIRMED) {
            ride.decrementParticipants();
            await this.promoteFromWaitlistIfNeeded(rideId, ride);
        }
        else if (previousStatus === participation_2.ParticipationStatus.WAITLISTED) {
            ride.decrementWaitlist();
            await this.reorderWaitlist(rideId);
        }
        await this.rideRepository.update(ride);
    }
    async updateParticipantRole(rideId, userId, request) {
        const participation = await this.participationRepository.findByRideAndUser(rideId, userId);
        if (!participation) {
            throw new participation_errors_1.ParticipationNotFoundError(`${rideId}:${userId}`);
        }
        // Validate role transition
        this.validateRoleTransition(participation.role, request.role);
        participation.updateRole(request.role, request.reason);
        await this.participationRepository.update(participation);
        return participation;
    }
    async removeParticipant(rideId, userId) {
        const participation = await this.participationRepository.findByRideAndUser(rideId, userId);
        if (!participation) {
            throw new participation_errors_1.ParticipationNotFoundError(`${rideId}:${userId}`);
        }
        // Cannot remove captain without transferring role
        if (participation.role === participation_2.RideRole.CAPTAIN) {
            throw new participation_errors_1.CannotRemoveCaptainError();
        }
        const ride = await this.rideRepository.findById(rideId);
        if (!ride) {
            throw new ride_errors_1.RideNotFoundError(rideId);
        }
        participation.remove();
        await this.participationRepository.update(participation);
        // Update ride counts
        if (participation.status === participation_2.ParticipationStatus.CONFIRMED) {
            ride.decrementParticipants();
            await this.promoteFromWaitlistIfNeeded(rideId, ride);
        }
        else if (participation.status === participation_2.ParticipationStatus.WAITLISTED) {
            ride.decrementWaitlist();
            await this.reorderWaitlist(rideId);
        }
        await this.rideRepository.update(ride);
    }
    async getRideParticipants(rideId) {
        return this.participationRepository.findByRideId(rideId);
    }
    async getUserRides(userId, query) {
        return this.participationRepository.findByUserId(userId, query);
    }
    // Phase 2.5: Attendance tracking methods
    async updateAttendance(rideId, userId, attendanceStatus, confirmedBy) {
        const participation = await this.participationRepository.findByRideAndUser(rideId, userId);
        if (!participation) {
            throw new participation_errors_1.ParticipationNotFoundError(`${rideId}:${userId}`);
        }
        if (!participation.canUpdateAttendance()) {
            throw new Error('Cannot update attendance for non-confirmed participant');
        }
        participation.updateAttendance(attendanceStatus, confirmedBy);
        await this.participationRepository.update(participation);
        return participation;
    }
    async linkManualEvidence(rideId, userId, evidenceId, description, confirmedBy) {
        const participation = await this.participationRepository.findByRideAndUser(rideId, userId);
        if (!participation) {
            throw new participation_errors_1.ParticipationNotFoundError(`${rideId}:${userId}`);
        }
        if (!participation.canUpdateAttendance()) {
            throw new Error('Cannot link evidence for non-confirmed participant');
        }
        participation.linkManualEvidence(evidenceId, confirmedBy);
        await this.participationRepository.update(participation);
        return participation;
    }
    async linkStravaEvidence(rideId, userId, stravaActivityId, matchType, metrics) {
        const participation = await this.participationRepository.findByRideAndUser(rideId, userId);
        if (!participation) {
            throw new participation_errors_1.ParticipationNotFoundError(`${rideId}:${userId}`);
        }
        if (!participation.canUpdateAttendance()) {
            throw new Error('Cannot link evidence for non-confirmed participant');
        }
        participation.linkStravaEvidence(stravaActivityId, matchType, metrics);
        await this.participationRepository.update(participation);
        return participation;
    }
    validateRoleTransition(fromRole, toRole) {
        // Define allowed role transitions
        const allowedTransitions = {
            [participation_2.RideRole.PARTICIPANT]: [participation_2.RideRole.LEADER, participation_2.RideRole.CAPTAIN],
            [participation_2.RideRole.LEADER]: [participation_2.RideRole.PARTICIPANT, participation_2.RideRole.CAPTAIN],
            [participation_2.RideRole.CAPTAIN]: [participation_2.RideRole.LEADER] // Captain can step down but not to participant directly
        };
        if (!allowedTransitions[fromRole]?.includes(toRole)) {
            throw new participation_errors_1.InvalidRoleTransitionError(fromRole, toRole);
        }
    }
    async promoteFromWaitlistIfNeeded(rideId, ride) {
        if (!ride.canAcceptParticipants())
            return;
        const participations = await this.participationRepository.findByRideId(rideId);
        const waitlisted = participations
            .filter(p => p.status === participation_2.ParticipationStatus.WAITLISTED)
            .sort((a, b) => (a.waitlistPosition || 0) - (b.waitlistPosition || 0));
        if (waitlisted.length > 0) {
            const nextParticipant = waitlisted[0];
            nextParticipant.promoteFromWaitlist();
            await this.participationRepository.update(nextParticipant);
            ride.incrementParticipants();
            ride.decrementWaitlist();
            // Reorder remaining waitlist
            await this.reorderWaitlist(rideId);
        }
    }
    async reorderWaitlist(rideId) {
        const participations = await this.participationRepository.findByRideId(rideId);
        const waitlisted = participations
            .filter(p => p.status === participation_2.ParticipationStatus.WAITLISTED)
            .sort((a, b) => (a.waitlistPosition || 0) - (b.waitlistPosition || 0));
        for (let i = 0; i < waitlisted.length; i++) {
            waitlisted[i].updateWaitlistPosition(i + 1);
            await this.participationRepository.update(waitlisted[i]);
        }
    }
}
exports.ParticipationService = ParticipationService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGljaXBhdGlvbi1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGFydGljaXBhdGlvbi1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1EQUFzRDtBQUd0RCwwRUFRZ0Q7QUFDaEQsd0RBQTJEO0FBQzNELGlFQU1nQztBQUNoQyxxREFBd0Q7QUFFeEQsTUFBYSxvQkFBb0I7SUFDL0IsWUFDVSx1QkFBZ0QsRUFDaEQsY0FBOEI7UUFEOUIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7SUFDckMsQ0FBQztJQUVKLEtBQUssQ0FBQyxRQUFRLENBQ1osTUFBYyxFQUNkLE1BQWMsRUFDZCxPQUF3QjtRQUV4Qix3QkFBd0I7UUFDeEIsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsTUFBTSxJQUFJLCtCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3JDO1FBRUQsb0VBQW9FO1FBQ3BFLE1BQU0scUJBQXFCLEdBQUcsTUFBTSxJQUFJLENBQUMsdUJBQXVCLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25HLElBQUkscUJBQXFCO1lBQ3JCLHFCQUFxQixDQUFDLE1BQU0sS0FBSyxtQ0FBbUIsQ0FBQyxTQUFTO1lBQzlELHFCQUFxQixDQUFDLE1BQU0sS0FBSyxtQ0FBbUIsQ0FBQyxPQUFPLEVBQUU7WUFDaEUsTUFBTSxJQUFJLGdEQUF5QixDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztTQUNyRDtRQUVELHdDQUF3QztRQUN4QyxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssaUJBQVUsQ0FBQyxTQUFTLEVBQUU7WUFDeEMsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1NB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TSxJQUFJLENBQUMsdUJBQXVCLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9FLE1BQU0sVUFBVSxHQUFHLGNBQWM7YUFDOUIsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxtQ0FBbUIsQ0FBQyxVQUFVLENBQUM7YUFDeEQsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV6RSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMxQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxRDtJQUNILENBQUM7Q0FDRjtBQXJSRCxvREFxUkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXJ0aWNpcGF0aW9uRW50aXR5IH0gZnJvbSAnLi9wYXJ0aWNpcGF0aW9uJztcbmltcG9ydCB7IFBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LCBQYWdpbmF0ZWRVc2VyUmlkZXMgfSBmcm9tICcuL3BhcnRpY2lwYXRpb24tcmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBSaWRlUmVwb3NpdG9yeSB9IGZyb20gJy4uL3JpZGUvcmlkZS1yZXBvc2l0b3J5JztcbmltcG9ydCB7IFxuICBKb2luUmlkZVJlcXVlc3QsIFxuICBVcGRhdGVQYXJ0aWNpcGFudFJlcXVlc3QsXG4gIExpc3RVc2VyUmlkZXNRdWVyeSxcbiAgUGFydGljaXBhdGlvblN0YXR1cyxcbiAgUmlkZVJvbGUsXG4gIEF0dGVuZGFuY2VTdGF0dXMsXG4gIE1hdGNoVHlwZSBcbn0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL3R5cGVzL3BhcnRpY2lwYXRpb24nO1xuaW1wb3J0IHsgUmlkZVN0YXR1cyB9IGZyb20gJy4uLy4uLy4uLy4uL3NoYXJlZC90eXBlcy9yaWRlJztcbmltcG9ydCB7IFxuICBQYXJ0aWNpcGF0aW9uTm90Rm91bmRFcnJvcixcbiAgQWxyZWFkeVBhcnRpY2lwYXRpbmdFcnJvcixcbiAgUmlkZUZ1bGxFcnJvcixcbiAgSW52YWxpZFJvbGVUcmFuc2l0aW9uRXJyb3IsXG4gIENhbm5vdFJlbW92ZUNhcHRhaW5FcnJvclxufSBmcm9tICcuL3BhcnRpY2lwYXRpb24tZXJyb3JzJztcbmltcG9ydCB7IFJpZGVOb3RGb3VuZEVycm9yIH0gZnJvbSAnLi4vcmlkZS9yaWRlLWVycm9ycyc7XG5cbmV4cG9ydCBjbGFzcyBQYXJ0aWNpcGF0aW9uU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcGFydGljaXBhdGlvblJlcG9zaXRvcnk6IFBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgcmlkZVJlcG9zaXRvcnk6IFJpZGVSZXBvc2l0b3J5XG4gICkge31cblxuICBhc3luYyBqb2luUmlkZShcbiAgICByaWRlSWQ6IHN0cmluZyxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICByZXF1ZXN0OiBKb2luUmlkZVJlcXVlc3RcbiAgKTogUHJvbWlzZTxQYXJ0aWNpcGF0aW9uRW50aXR5PiB7XG4gICAgLy8gR2V0IHJpZGUgYW5kIHZhbGlkYXRlXG4gICAgY29uc3QgcmlkZSA9IGF3YWl0IHRoaXMucmlkZVJlcG9zaXRvcnkuZmluZEJ5SWQocmlkZUlkKTtcbiAgICBpZiAoIXJpZGUpIHtcbiAgICAgIHRocm93IG5ldyBSaWRlTm90Rm91bmRFcnJvcihyaWRlSWQpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYWxyZWFkeSBwYXJ0aWNpcGF0aW5nIChpZ25vcmUgd2l0aGRyYXduL3JlbW92ZWQpXG4gICAgY29uc3QgZXhpc3RpbmdQYXJ0aWNpcGF0aW9uID0gYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS5maW5kQnlSaWRlQW5kVXNlcihyaWRlSWQsIHVzZXJJZCk7XG4gICAgaWYgKGV4aXN0aW5nUGFydGljaXBhdGlvbiAmJiBcbiAgICAgICAgZXhpc3RpbmdQYXJ0aWNpcGF0aW9uLnN0YXR1cyAhPT0gUGFydGljaXBhdGlvblN0YXR1cy5XSVRIRFJBV04gJiYgXG4gICAgICAgIGV4aXN0aW5nUGFydGljaXBhdGlvbi5zdGF0dXMgIT09IFBhcnRpY2lwYXRpb25TdGF0dXMuUkVNT1ZFRCkge1xuICAgICAgdGhyb3cgbmV3IEFscmVhZHlQYXJ0aWNpcGF0aW5nRXJyb3IodXNlcklkLCByaWRlSWQpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHJpZGUgY2FuIGFjY2VwdCBwYXJ0aWNpcGFudHNcbiAgICBpZiAocmlkZS5zdGF0dXMgIT09IFJpZGVTdGF0dXMuUFVCTElTSEVEKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhbiBvbmx5IGpvaW4gcHVibGlzaGVkIHJpZGVzJyk7XG4gICAgfVxuXG4gICAgbGV0IHBhcnRpY2lwYXRpb246IFBhcnRpY2lwYXRpb25FbnRpdHk7XG5cbiAgICBpZiAocmlkZS5jYW5BY2NlcHRQYXJ0aWNpcGFudHMoKSkge1xuICAgICAgLy8gSm9pbiBhcyBjb25maXJtZWQgcGFydGljaXBhbnRcbiAgICAgIHBhcnRpY2lwYXRpb24gPSBQYXJ0aWNpcGF0aW9uRW50aXR5LmNyZWF0ZShcbiAgICAgICAgcmlkZUlkLFxuICAgICAgICByaWRlLmNsdWJJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICBQYXJ0aWNpcGF0aW9uU3RhdHVzLkNPTkZJUk1FRFxuICAgICAgKTtcbiAgICAgIFxuICAgICAgLy8gVXBkYXRlIHJpZGUgcGFydGljaXBhbnQgY291bnRcbiAgICAgIHJpZGUuaW5jcmVtZW50UGFydGljaXBhbnRzKCk7XG4gICAgICBhd2FpdCB0aGlzLnJpZGVSZXBvc2l0b3J5LnVwZGF0ZShyaWRlKTtcbiAgICB9IGVsc2UgaWYgKHJpZGUuaXNXYWl0bGlzdEF2YWlsYWJsZSgpKSB7XG4gICAgICAvLyBKb2luIHdhaXRsaXN0XG4gICAgICBjb25zdCB3YWl0bGlzdFBvc2l0aW9uID0gYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS5nZXRXYWl0bGlzdFBvc2l0aW9uKHJpZGVJZCkgKyAxO1xuICAgICAgcGFydGljaXBhdGlvbiA9IFBhcnRpY2lwYXRpb25FbnRpdHkuY3JlYXRlKFxuICAgICAgICByaWRlSWQsXG4gICAgICAgIHJpZGUuY2x1YklkLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIFBhcnRpY2lwYXRpb25TdGF0dXMuV0FJVExJU1RFRCxcbiAgICAgICAgd2FpdGxpc3RQb3NpdGlvblxuICAgICAgKTtcbiAgICAgIFxuICAgICAgLy8gVXBkYXRlIHJpZGUgd2FpdGxpc3QgY291bnRcbiAgICAgIHJpZGUuaW5jcmVtZW50V2FpdGxpc3QoKTtcbiAgICAgIGF3YWl0IHRoaXMucmlkZVJlcG9zaXRvcnkudXBkYXRlKHJpZGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgUmlkZUZ1bGxFcnJvcihyaWRlSWQpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucGFydGljaXBhdGlvblJlcG9zaXRvcnkuY3JlYXRlKHBhcnRpY2lwYXRpb24pO1xuICAgIHJldHVybiBwYXJ0aWNpcGF0aW9uO1xuICB9XG5cbiAgYXN5bmMgbGVhdmVSaWRlKHJpZGVJZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHBhcnRpY2lwYXRpb24gPSBhd2FpdCB0aGlzLnBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LmZpbmRCeVJpZGVBbmRVc2VyKHJpZGVJZCwgdXNlcklkKTtcbiAgICBpZiAoIXBhcnRpY2lwYXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBQYXJ0aWNpcGF0aW9uTm90Rm91bmRFcnJvcihgJHtyaWRlSWR9OiR7dXNlcklkfWApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGFscmVhZHkgd2l0aGRyYXduIG9yIHJlbW92ZWRcbiAgICBpZiAocGFydGljaXBhdGlvbi5zdGF0dXMgPT09IFBhcnRpY2lwYXRpb25TdGF0dXMuV0lUSERSQVdOIHx8IFxuICAgICAgICBwYXJ0aWNpcGF0aW9uLnN0YXR1cyA9PT0gUGFydGljaXBhdGlvblN0YXR1cy5SRU1PVkVEKSB7XG4gICAgICB0aHJvdyBuZXcgUGFydGljaXBhdGlvbk5vdEZvdW5kRXJyb3IoYCR7cmlkZUlkfToke3VzZXJJZH1gKTtcbiAgICB9XG5cbiAgICAvLyBDYW5ub3QgcmVtb3ZlIGNhcHRhaW4gd2l0aG91dCB0cmFuc2ZlcnJpbmcgcm9sZVxuICAgIGlmIChwYXJ0aWNpcGF0aW9uLnJvbGUgPT09IFJpZGVSb2xlLkNBUFRBSU4pIHtcbiAgICAgIHRocm93IG5ldyBDYW5ub3RSZW1vdmVDYXB0YWluRXJyb3IoKTtcbiAgICB9XG5cbiAgICBjb25zdCByaWRlID0gYXdhaXQgdGhpcy5yaWRlUmVwb3NpdG9yeS5maW5kQnlJZChyaWRlSWQpO1xuICAgIGlmICghcmlkZSkge1xuICAgICAgdGhyb3cgbmV3IFJpZGVOb3RGb3VuZEVycm9yKHJpZGVJZCk7XG4gICAgfVxuXG4gICAgLy8gU3RvcmUgdGhlIGN1cnJlbnQgc3RhdHVzIGJlZm9yZSB3aXRoZHJhd2luZ1xuICAgIGNvbnN0IHByZXZpb3VzU3RhdHVzID0gcGFydGljaXBhdGlvbi5zdGF0dXM7XG5cbiAgICBwYXJ0aWNpcGF0aW9uLndpdGhkcmF3KCk7XG4gICAgYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS51cGRhdGUocGFydGljaXBhdGlvbik7XG5cbiAgICAvLyBVcGRhdGUgcmlkZSBjb3VudHMgYmFzZWQgb24gcHJldmlvdXMgc3RhdHVzXG4gICAgaWYgKHByZXZpb3VzU3RhdHVzID09PSBQYXJ0aWNpcGF0aW9uU3RhdHVzLkNPTkZJUk1FRCkge1xuICAgICAgcmlkZS5kZWNyZW1lbnRQYXJ0aWNpcGFudHMoKTtcbiAgICAgIGF3YWl0IHRoaXMucHJvbW90ZUZyb21XYWl0bGlzdElmTmVlZGVkKHJpZGVJZCwgcmlkZSk7XG4gICAgfSBlbHNlIGlmIChwcmV2aW91c1N0YXR1cyA9PT0gUGFydGljaXBhdGlvblN0YXR1cy5XQUlUTElTVEVEKSB7XG4gICAgICByaWRlLmRlY3JlbWVudFdhaXRsaXN0KCk7XG4gICAgICBhd2FpdCB0aGlzLnJlb3JkZXJXYWl0bGlzdChyaWRlSWQpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucmlkZVJlcG9zaXRvcnkudXBkYXRlKHJpZGUpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUGFydGljaXBhbnRSb2xlKFxuICAgIHJpZGVJZDogc3RyaW5nLFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHJlcXVlc3Q6IFVwZGF0ZVBhcnRpY2lwYW50UmVxdWVzdFxuICApOiBQcm9taXNlPFBhcnRpY2lwYXRpb25FbnRpdHk+IHtcbiAgICBjb25zdCBwYXJ0aWNpcGF0aW9uID0gYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS5maW5kQnlSaWRlQW5kVXNlcihyaWRlSWQsIHVzZXJJZCk7XG4gICAgaWYgKCFwYXJ0aWNpcGF0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgUGFydGljaXBhdGlvbk5vdEZvdW5kRXJyb3IoYCR7cmlkZUlkfToke3VzZXJJZH1gKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSByb2xlIHRyYW5zaXRpb25cbiAgICB0aGlzLnZhbGlkYXRlUm9sZVRyYW5zaXRpb24ocGFydGljaXBhdGlvbi5yb2xlLCByZXF1ZXN0LnJvbGUpO1xuXG4gICAgcGFydGljaXBhdGlvbi51cGRhdGVSb2xlKHJlcXVlc3Qucm9sZSwgcmVxdWVzdC5yZWFzb24pO1xuICAgIGF3YWl0IHRoaXMucGFydGljaXBhdGlvblJlcG9zaXRvcnkudXBkYXRlKHBhcnRpY2lwYXRpb24pO1xuXG4gICAgcmV0dXJuIHBhcnRpY2lwYXRpb247XG4gIH1cblxuICBhc3luYyByZW1vdmVQYXJ0aWNpcGFudChyaWRlSWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBwYXJ0aWNpcGF0aW9uID0gYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS5maW5kQnlSaWRlQW5kVXNlcihyaWRlSWQsIHVzZXJJZCk7XG4gICAgaWYgKCFwYXJ0aWNpcGF0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgUGFydGljaXBhdGlvbk5vdEZvdW5kRXJyb3IoYCR7cmlkZUlkfToke3VzZXJJZH1gKTtcbiAgICB9XG5cbiAgICAvLyBDYW5ub3QgcmVtb3ZlIGNhcHRhaW4gd2l0aG91dCB0cmFuc2ZlcnJpbmcgcm9sZVxuICAgIGlmIChwYXJ0aWNpcGF0aW9uLnJvbGUgPT09IFJpZGVSb2xlLkNBUFRBSU4pIHtcbiAgICAgIHRocm93IG5ldyBDYW5ub3RSZW1vdmVDYXB0YWluRXJyb3IoKTtcbiAgICB9XG5cbiAgICBjb25zdCByaWRlID0gYXdhaXQgdGhpcy5yaWRlUmVwb3NpdG9yeS5maW5kQnlJZChyaWRlSWQpO1xuICAgIGlmICghcmlkZSkge1xuICAgICAgdGhyb3cgbmV3IFJpZGVOb3RGb3VuZEVycm9yKHJpZGVJZCk7XG4gICAgfVxuXG4gICAgcGFydGljaXBhdGlvbi5yZW1vdmUoKTtcbiAgICBhd2FpdCB0aGlzLnBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LnVwZGF0ZShwYXJ0aWNpcGF0aW9uKTtcblxuICAgIC8vIFVwZGF0ZSByaWRlIGNvdW50c1xuICAgIGlmIChwYXJ0aWNpcGF0aW9uLnN0YXR1cyA9PT0gUGFydGljaXBhdGlvblN0YXR1cy5DT05GSVJNRUQpIHtcbiAgICAgIHJpZGUuZGVjcmVtZW50UGFydGljaXBhbnRzKCk7XG4gICAgICBhd2FpdCB0aGlzLnByb21vdGVGcm9tV2FpdGxpc3RJZk5lZWRlZChyaWRlSWQsIHJpZGUpO1xuICAgIH0gZWxzZSBpZiAocGFydGljaXBhdGlvbi5zdGF0dXMgPT09IFBhcnRpY2lwYXRpb25TdGF0dXMuV0FJVExJU1RFRCkge1xuICAgICAgcmlkZS5kZWNyZW1lbnRXYWl0bGlzdCgpO1xuICAgICAgYXdhaXQgdGhpcy5yZW9yZGVyV2FpdGxpc3QocmlkZUlkKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnJpZGVSZXBvc2l0b3J5LnVwZGF0ZShyaWRlKTtcbiAgfVxuXG4gIGFzeW5jIGdldFJpZGVQYXJ0aWNpcGFudHMocmlkZUlkOiBzdHJpbmcpOiBQcm9taXNlPFBhcnRpY2lwYXRpb25FbnRpdHlbXT4ge1xuICAgIHJldHVybiB0aGlzLnBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LmZpbmRCeVJpZGVJZChyaWRlSWQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0VXNlclJpZGVzKHVzZXJJZDogc3RyaW5nLCBxdWVyeTogTGlzdFVzZXJSaWRlc1F1ZXJ5KTogUHJvbWlzZTxQYWdpbmF0ZWRVc2VyUmlkZXM+IHtcbiAgICByZXR1cm4gdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS5maW5kQnlVc2VySWQodXNlcklkLCBxdWVyeSk7XG4gIH1cblxuICAvLyBQaGFzZSAyLjU6IEF0dGVuZGFuY2UgdHJhY2tpbmcgbWV0aG9kc1xuICBhc3luYyB1cGRhdGVBdHRlbmRhbmNlKFxuICAgIHJpZGVJZDogc3RyaW5nLFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGF0dGVuZGFuY2VTdGF0dXM6IEF0dGVuZGFuY2VTdGF0dXMsXG4gICAgY29uZmlybWVkQnk6IHN0cmluZ1xuICApOiBQcm9taXNlPFBhcnRpY2lwYXRpb25FbnRpdHk+IHtcbiAgICBjb25zdCBwYXJ0aWNpcGF0aW9uID0gYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS5maW5kQnlSaWRlQW5kVXNlcihyaWRlSWQsIHVzZXJJZCk7XG4gICAgaWYgKCFwYXJ0aWNpcGF0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgUGFydGljaXBhdGlvbk5vdEZvdW5kRXJyb3IoYCR7cmlkZUlkfToke3VzZXJJZH1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXBhcnRpY2lwYXRpb24uY2FuVXBkYXRlQXR0ZW5kYW5jZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCB1cGRhdGUgYXR0ZW5kYW5jZSBmb3Igbm9uLWNvbmZpcm1lZCBwYXJ0aWNpcGFudCcpO1xuICAgIH1cblxuICAgIHBhcnRpY2lwYXRpb24udXBkYXRlQXR0ZW5kYW5jZShhdHRlbmRhbmNlU3RhdHVzLCBjb25maXJtZWRCeSk7XG4gICAgYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS51cGRhdGUocGFydGljaXBhdGlvbik7XG5cbiAgICByZXR1cm4gcGFydGljaXBhdGlvbjtcbiAgfVxuXG4gIGFzeW5jIGxpbmtNYW51YWxFdmlkZW5jZShcbiAgICByaWRlSWQ6IHN0cmluZyxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBldmlkZW5jZUlkOiBzdHJpbmcsXG4gICAgZGVzY3JpcHRpb246IHN0cmluZyxcbiAgICBjb25maXJtZWRCeTogc3RyaW5nXG4gICk6IFByb21pc2U8UGFydGljaXBhdGlvbkVudGl0eT4ge1xuICAgIGNvbnN0IHBhcnRpY2lwYXRpb24gPSBhd2FpdCB0aGlzLnBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LmZpbmRCeVJpZGVBbmRVc2VyKHJpZGVJZCwgdXNlcklkKTtcbiAgICBpZiAoIXBhcnRpY2lwYXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBQYXJ0aWNpcGF0aW9uTm90Rm91bmRFcnJvcihgJHtyaWRlSWR9OiR7dXNlcklkfWApO1xuICAgIH1cblxuICAgIGlmICghcGFydGljaXBhdGlvbi5jYW5VcGRhdGVBdHRlbmRhbmNlKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGxpbmsgZXZpZGVuY2UgZm9yIG5vbi1jb25maXJtZWQgcGFydGljaXBhbnQnKTtcbiAgICB9XG5cbiAgICBwYXJ0aWNpcGF0aW9uLmxpbmtNYW51YWxFdmlkZW5jZShldmlkZW5jZUlkLCBjb25maXJtZWRCeSk7XG4gICAgYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS51cGRhdGUocGFydGljaXBhdGlvbik7XG5cbiAgICByZXR1cm4gcGFydGljaXBhdGlvbjtcbiAgfVxuXG4gIGFzeW5jIGxpbmtTdHJhdmFFdmlkZW5jZShcbiAgICByaWRlSWQ6IHN0cmluZyxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBzdHJhdmFBY3Rpdml0eUlkOiBzdHJpbmcsXG4gICAgbWF0Y2hUeXBlOiBNYXRjaFR5cGUsXG4gICAgbWV0cmljcz86IGFueVxuICApOiBQcm9taXNlPFBhcnRpY2lwYXRpb25FbnRpdHk+IHtcbiAgICBjb25zdCBwYXJ0aWNpcGF0aW9uID0gYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS5maW5kQnlSaWRlQW5kVXNlcihyaWRlSWQsIHVzZXJJZCk7XG4gICAgaWYgKCFwYXJ0aWNpcGF0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgUGFydGljaXBhdGlvbk5vdEZvdW5kRXJyb3IoYCR7cmlkZUlkfToke3VzZXJJZH1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXBhcnRpY2lwYXRpb24uY2FuVXBkYXRlQXR0ZW5kYW5jZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsaW5rIGV2aWRlbmNlIGZvciBub24tY29uZmlybWVkIHBhcnRpY2lwYW50Jyk7XG4gICAgfVxuXG4gICAgcGFydGljaXBhdGlvbi5saW5rU3RyYXZhRXZpZGVuY2Uoc3RyYXZhQWN0aXZpdHlJZCwgbWF0Y2hUeXBlLCBtZXRyaWNzKTtcbiAgICBhd2FpdCB0aGlzLnBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LnVwZGF0ZShwYXJ0aWNpcGF0aW9uKTtcblxuICAgIHJldHVybiBwYXJ0aWNpcGF0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVJvbGVUcmFuc2l0aW9uKGZyb21Sb2xlOiBSaWRlUm9sZSwgdG9Sb2xlOiBSaWRlUm9sZSk6IHZvaWQge1xuICAgIC8vIERlZmluZSBhbGxvd2VkIHJvbGUgdHJhbnNpdGlvbnNcbiAgICBjb25zdCBhbGxvd2VkVHJhbnNpdGlvbnM6IFJlY29yZDxSaWRlUm9sZSwgUmlkZVJvbGVbXT4gPSB7XG4gICAgICBbUmlkZVJvbGUuUEFSVElDSVBBTlRdOiBbUmlkZVJvbGUuTEVBREVSLCBSaWRlUm9sZS5DQVBUQUlOXSxcbiAgICAgIFtSaWRlUm9sZS5MRUFERVJdOiBbUmlkZVJvbGUuUEFSVElDSVBBTlQsIFJpZGVSb2xlLkNBUFRBSU5dLFxuICAgICAgW1JpZGVSb2xlLkNBUFRBSU5dOiBbUmlkZVJvbGUuTEVBREVSXSAvLyBDYXB0YWluIGNhbiBzdGVwIGRvd24gYnV0IG5vdCB0byBwYXJ0aWNpcGFudCBkaXJlY3RseVxuICAgIH07XG5cbiAgICBpZiAoIWFsbG93ZWRUcmFuc2l0aW9uc1tmcm9tUm9sZV0/LmluY2x1ZGVzKHRvUm9sZSkpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkUm9sZVRyYW5zaXRpb25FcnJvcihmcm9tUm9sZSwgdG9Sb2xlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHByb21vdGVGcm9tV2FpdGxpc3RJZk5lZWRlZChyaWRlSWQ6IHN0cmluZywgcmlkZTogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFyaWRlLmNhbkFjY2VwdFBhcnRpY2lwYW50cygpKSByZXR1cm47XG5cbiAgICBjb25zdCBwYXJ0aWNpcGF0aW9ucyA9IGF3YWl0IHRoaXMucGFydGljaXBhdGlvblJlcG9zaXRvcnkuZmluZEJ5UmlkZUlkKHJpZGVJZCk7XG4gICAgY29uc3Qgd2FpdGxpc3RlZCA9IHBhcnRpY2lwYXRpb25zXG4gICAgICAuZmlsdGVyKHAgPT4gcC5zdGF0dXMgPT09IFBhcnRpY2lwYXRpb25TdGF0dXMuV0FJVExJU1RFRClcbiAgICAgIC5zb3J0KChhLCBiKSA9PiAoYS53YWl0bGlzdFBvc2l0aW9uIHx8IDApIC0gKGIud2FpdGxpc3RQb3NpdGlvbiB8fCAwKSk7XG5cbiAgICBpZiAod2FpdGxpc3RlZC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBuZXh0UGFydGljaXBhbnQgPSB3YWl0bGlzdGVkWzBdO1xuICAgICAgbmV4dFBhcnRpY2lwYW50LnByb21vdGVGcm9tV2FpdGxpc3QoKTtcbiAgICAgIGF3YWl0IHRoaXMucGFydGljaXBhdGlvblJlcG9zaXRvcnkudXBkYXRlKG5leHRQYXJ0aWNpcGFudCk7XG4gICAgICBcbiAgICAgIHJpZGUuaW5jcmVtZW50UGFydGljaXBhbnRzKCk7XG4gICAgICByaWRlLmRlY3JlbWVudFdhaXRsaXN0KCk7XG4gICAgICBcbiAgICAgIC8vIFJlb3JkZXIgcmVtYWluaW5nIHdhaXRsaXN0XG4gICAgICBhd2FpdCB0aGlzLnJlb3JkZXJXYWl0bGlzdChyaWRlSWQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVvcmRlcldhaXRsaXN0KHJpZGVJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcGFydGljaXBhdGlvbnMgPSBhd2FpdCB0aGlzLnBhcnRpY2lwYXRpb25SZXBvc2l0b3J5LmZpbmRCeVJpZGVJZChyaWRlSWQpO1xuICAgIGNvbnN0IHdhaXRsaXN0ZWQgPSBwYXJ0aWNpcGF0aW9uc1xuICAgICAgLmZpbHRlcihwID0+IHAuc3RhdHVzID09PSBQYXJ0aWNpcGF0aW9uU3RhdHVzLldBSVRMSVNURUQpXG4gICAgICAuc29ydCgoYSwgYikgPT4gKGEud2FpdGxpc3RQb3NpdGlvbiB8fCAwKSAtIChiLndhaXRsaXN0UG9zaXRpb24gfHwgMCkpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3YWl0bGlzdGVkLmxlbmd0aDsgaSsrKSB7XG4gICAgICB3YWl0bGlzdGVkW2ldLnVwZGF0ZVdhaXRsaXN0UG9zaXRpb24oaSArIDEpO1xuICAgICAgYXdhaXQgdGhpcy5wYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeS51cGRhdGUod2FpdGxpc3RlZFtpXSk7XG4gICAgfVxuICB9XG59Il19