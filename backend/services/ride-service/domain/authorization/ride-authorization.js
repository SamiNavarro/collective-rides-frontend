"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RideAuthorizationService = void 0;
const ride_authorization_1 = require("../../../../shared/types/ride-authorization");
const club_authorization_1 = require("../../../../shared/types/club-authorization");
const ride_1 = require("../../../../shared/types/ride");
const authorization_errors_1 = require("../../../../shared/authorization/authorization-errors");
class RideAuthorizationService {
    static async requireRideCapability(capability, authContext, clubId, rideId, rideCreatedBy) {
        // System admin override
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return;
        }
        // Check club membership and role
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            throw new authorization_errors_1.InsufficientPrivilegesError(capability, authContext.userId, `club:${clubId}`);
        }
        // Get capabilities for user's club role
        const roleCapabilities = this.ROLE_CAPABILITIES[membership.role] || [];
        // Special case: ride creator can manage their own draft rides
        if (rideCreatedBy === authContext.userId &&
            (capability === ride_authorization_1.RideCapability.MANAGE_RIDES || capability === ride_authorization_1.RideCapability.CANCEL_RIDES)) {
            return;
        }
        // Check if user has required capability
        if (!roleCapabilities.includes(capability)) {
            throw new authorization_errors_1.InsufficientPrivilegesError(capability, authContext.userId, `club:${clubId}`);
        }
    }
    static canViewRide(authContext, clubId, rideStatus, rideScope, rideCreatedBy, isPublic) {
        // System admin can view all rides
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return true;
        }
        // Public rides are viewable by anyone (read-only)
        if (isPublic && rideStatus === ride_1.RideStatus.PUBLISHED) {
            return true;
        }
        // Phase 2.3: Only club rides supported
        if (rideScope !== ride_1.RideScope.CLUB) {
            return false;
        }
        // Check club membership
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            return false;
        }
        // Draft rides: only creator and leadership can view
        if (rideStatus === ride_1.RideStatus.DRAFT) {
            if (rideCreatedBy === authContext.userId) {
                return true;
            }
            const roleCapabilities = this.ROLE_CAPABILITIES[membership.role] || [];
            return roleCapabilities.includes(ride_authorization_1.RideCapability.VIEW_DRAFT_RIDES);
        }
        // Published rides: all club members can view
        return true;
    }
    static canPublishRide(authContext, clubId) {
        // System admin can publish any ride
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return true;
        }
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            return false;
        }
        const roleCapabilities = this.ROLE_CAPABILITIES[membership.role] || [];
        return roleCapabilities.includes(ride_authorization_1.RideCapability.PUBLISH_OFFICIAL_RIDES);
    }
    static getUserRideCapabilities(authContext, clubId) {
        // System admin has all capabilities
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return Object.values(ride_authorization_1.RideCapability);
        }
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            return [];
        }
        return this.ROLE_CAPABILITIES[membership.role] || [];
    }
}
RideAuthorizationService.ROLE_CAPABILITIES = {
    [club_authorization_1.ClubRole.MEMBER]: [
        ride_authorization_1.RideCapability.VIEW_CLUB_RIDES,
        ride_authorization_1.RideCapability.JOIN_RIDES,
        ride_authorization_1.RideCapability.CREATE_RIDE_PROPOSALS
    ],
    [club_authorization_1.ClubRole.ADMIN]: [
        ride_authorization_1.RideCapability.VIEW_CLUB_RIDES,
        ride_authorization_1.RideCapability.JOIN_RIDES,
        ride_authorization_1.RideCapability.CREATE_RIDE_PROPOSALS,
        ride_authorization_1.RideCapability.VIEW_DRAFT_RIDES,
        ride_authorization_1.RideCapability.PUBLISH_OFFICIAL_RIDES,
        ride_authorization_1.RideCapability.MANAGE_PARTICIPANTS,
        ride_authorization_1.RideCapability.MANAGE_RIDES,
        ride_authorization_1.RideCapability.CANCEL_RIDES,
        ride_authorization_1.RideCapability.ASSIGN_LEADERSHIP
    ],
    [club_authorization_1.ClubRole.OWNER]: [
        ...Object.values(ride_authorization_1.RideCapability)
    ]
};
exports.RideAuthorizationService = RideAuthorizationService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmlkZS1hdXRob3JpemF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmlkZS1hdXRob3JpemF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG9GQUE2RTtBQUM3RSxvRkFBb0Y7QUFDcEYsd0RBQXNFO0FBQ3RFLGdHQUFvRztBQUVwRyxNQUFhLHdCQUF3QjtJQXVCbkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FDaEMsVUFBMEIsRUFDMUIsV0FBd0IsRUFDeEIsTUFBYyxFQUNkLE1BQWUsRUFDZixhQUFzQjtRQUV0Qix3QkFBd0I7UUFDeEIsSUFBSSxXQUFXLENBQUMsa0JBQWtCLEVBQUUsUUFBUSxDQUFDLGtCQUFrQixDQUFDLEVBQUU7WUFDaEUsT0FBTztTQUNSO1FBRUQsaUNBQWlDO1FBQ2pDLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxDQUFDO1FBQ3RGLElBQUksQ0FBQyxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDakQsTUFBTSxJQUFJLGtEQUEyQixDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsTUFBTSxFQUFFLFFBQVEsTUFBTSxFQUFFLENBQUMsQ0FBQztTQUN6RjtRQUVELHdDQUF3QztRQUN4QyxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsSUFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVuRiw4REFBOEQ7UUFDOUQsSUFBSSxhQUFhLEtBQUssV0FBVyxDQUFDLE1BQU07WUFDcEMsQ0FBQyxVQUFVLEtBQUssbUNBQWMsQ0FBQyxZQUFZLElBQUksVUFBVSxLQUFLLG1DQUFjLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDOUYsT0FBTztTQUNSO1FBRUQsd0NBQXdDO1FBQ3hDLElBQUksQ0FB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QUksVUFBVSxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDakQsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUVELE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxJQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO0lBQ25FLENBQUM7O0FBN0h1QiwwQ0FBaUIsR0FBdUM7SUFDOUUsQ0FBQyw2QkFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ2pCLG1DQUFjLENBQUMsZUFBZTtRQUM5QixtQ0FBYyxDQUFDLFVBQVU7UUFDekIsbUNBQWMsQ0FBQyxxQkFBcUI7S0FDckM7SUFDRCxDQUFDLDZCQUFRLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDaEIsbUNBQWMsQ0FBQyxlQUFlO1FBQzlCLG1DQUFjLENBQUMsVUFBVTtRQUN6QixtQ0FBYyxDQUFDLHFCQUFxQjtRQUNwQyxtQ0FBYyxDQUFDLGdCQUFnQjtRQUMvQixtQ0FBYyxDQUFDLHNCQUFzQjtRQUNyQyxtQ0FBYyxDQUFDLG1CQUFtQjtRQUNsQyxtQ0FBYyxDQUFDLFlBQVk7UUFDM0IsbUNBQWMsQ0FBQyxZQUFZO1FBQzNCLG1DQUFjLENBQUMsaUJBQWlCO0tBQ2pDO0lBQ0QsQ0FBQyw2QkFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ2hCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxtQ0FBYyxDQUFDO0tBQ2pDO0NBQ0YsQ0FBQztBQXJCUyw0REFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSaWRlQ2FwYWJpbGl0eSB9IGZyb20gJy4uLy4uLy4uLy4uL3NoYXJlZC90eXBlcy9yaWRlLWF1dGhvcml6YXRpb24nO1xuaW1wb3J0IHsgQ2x1YlJvbGUsIEF1dGhDb250ZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL3R5cGVzL2NsdWItYXV0aG9yaXphdGlvbic7XG5pbXBvcnQgeyBSaWRlU3RhdHVzLCBSaWRlU2NvcGUgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvdHlwZXMvcmlkZSc7XG5pbXBvcnQgeyBJbnN1ZmZpY2llbnRQcml2aWxlZ2VzRXJyb3IgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvYXV0aG9yaXphdGlvbi9hdXRob3JpemF0aW9uLWVycm9ycyc7XG5cbmV4cG9ydCBjbGFzcyBSaWRlQXV0aG9yaXphdGlvblNlcnZpY2Uge1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBST0xFX0NBUEFCSUxJVElFUzogUmVjb3JkPENsdWJSb2xlLCBSaWRlQ2FwYWJpbGl0eVtdPiA9IHtcbiAgICBbQ2x1YlJvbGUuTUVNQkVSXTogW1xuICAgICAgUmlkZUNhcGFiaWxpdHkuVklFV19DTFVCX1JJREVTLFxuICAgICAgUmlkZUNhcGFiaWxpdHkuSk9JTl9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5LkNSRUFURV9SSURFX1BST1BPU0FMU1xuICAgIF0sXG4gICAgW0NsdWJSb2xlLkFETUlOXTogW1xuICAgICAgUmlkZUNhcGFiaWxpdHkuVklFV19DTFVCX1JJREVTLFxuICAgICAgUmlkZUNhcGFiaWxpdHkuSk9JTl9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5LkNSRUFURV9SSURFX1BST1BPU0FMUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5LlZJRVdfRFJBRlRfUklERVMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5QVUJMSVNIX09GRklDSUFMX1JJREVTLFxuICAgICAgUmlkZUNhcGFiaWxpdHkuTUFOQUdFX1BBUlRJQ0lQQU5UUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5Lk1BTkFHRV9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5LkNBTkNFTF9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5LkFTU0lHTl9MRUFERVJTSElQXG4gICAgXSxcbiAgICBbQ2x1YlJvbGUuT1dORVJdOiBbXG4gICAgICAuLi5PYmplY3QudmFsdWVzKFJpZGVDYXBhYmlsaXR5KVxuICAgIF1cbiAgfTtcblxuICBzdGF0aWMgYXN5bmMgcmVxdWlyZVJpZGVDYXBhYmlsaXR5KFxuICAgIGNhcGFiaWxpdHk6IFJpZGVDYXBhYmlsaXR5LFxuICAgIGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCxcbiAgICBjbHViSWQ6IHN0cmluZyxcbiAgICByaWRlSWQ/OiBzdHJpbmcsXG4gICAgcmlkZUNyZWF0ZWRCeT86IHN0cmluZ1xuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBTeXN0ZW0gYWRtaW4gb3ZlcnJpZGVcbiAgICBpZiAoYXV0aENvbnRleHQuc3lzdGVtQ2FwYWJpbGl0aWVzPy5pbmNsdWRlcygnTUFOQUdFX0FMTF9DTFVCUycpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgY2x1YiBtZW1iZXJzaGlwIGFuZCByb2xlXG4gICAgY29uc3QgbWVtYmVyc2hpcCA9IGF1dGhDb250ZXh0LmNsdWJNZW1iZXJzaGlwcz8uZmluZCgobTogYW55KSA9PiBtLmNsdWJJZCA9PT0gY2x1YklkKTtcbiAgICBpZiAoIW1lbWJlcnNoaXAgfHwgbWVtYmVyc2hpcC5zdGF0dXMgIT09ICdhY3RpdmUnKSB7XG4gICAgICB0aHJvdyBuZXcgSW5zdWZmaWNpZW50UHJpdmlsZWdlc0Vycm9yKGNhcGFiaWxpdHksIGF1dGhDb250ZXh0LnVzZXJJZCwgYGNsdWI6JHtjbHViSWR9YCk7XG4gICAgfVxuXG4gICAgLy8gR2V0IGNhcGFiaWxpdGllcyBmb3IgdXNlcidzIGNsdWIgcm9sZVxuICAgIGNvbnN0IHJvbGVDYXBhYmlsaXRpZXMgPSB0aGlzLlJPTEVfQ0FQQUJJTElUSUVTW21lbWJlcnNoaXAucm9sZSBhcyBDbHViUm9sZV0gfHwgW107XG4gICAgXG4gICAgLy8gU3BlY2lhbCBjYXNlOiByaWRlIGNyZWF0b3IgY2FuIG1hbmFnZSB0aGVpciBvd24gZHJhZnQgcmlkZXNcbiAgICBpZiAocmlkZUNyZWF0ZWRCeSA9PT0gYXV0aENvbnRleHQudXNlcklkICYmIFxuICAgICAgICAoY2FwYWJpbGl0eSA9PT0gUmlkZUNhcGFiaWxpdHkuTUFOQUdFX1JJREVTIHx8IGNhcGFiaWxpdHkgPT09IFJpZGVDYXBhYmlsaXR5LkNBTkNFTF9SSURFUykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGhhcyByZXF1aXJlZCBjYXBhYmlsaXR5XG4gICAgaWYgKCFyb2xlQ2FwYWJpbGl0aWVzLmluY2x1ZGVzKGNhcGFiaWxpdHkpKSB7XG4gICAgICB0aHJvdyBuZXcgSW5zdWZmaWNpZW50UHJpdmlsZWdlc0Vycm9yKGNhcGFiaWxpdHksIGF1dGhDb250ZXh0LnVzZXJJZCwgYGNsdWI6JHtjbHViSWR9YCk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGNhblZpZXdSaWRlKFxuICAgIGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCxcbiAgICBjbHViSWQ6IHN0cmluZyxcbiAgICByaWRlU3RhdHVzOiBSaWRlU3RhdHVzLFxuICAgIHJpZGVTY29wZTogUmlkZVNjb3BlLFxuICAgIHJpZGVDcmVhdGVkQnk6IHN0cmluZyxcbiAgICBpc1B1YmxpYzogYm9vbGVhblxuICApOiBib29sZWFuIHtcbiAgICAvLyBTeXN0ZW0gYWRtaW4gY2FuIHZpZXcgYWxsIHJpZGVzXG4gICAgaWYgKGF1dGhDb250ZXh0LnN5c3RlbUNhcGFiaWxpdGllcz8uaW5jbHVkZXMoJ01BTkFHRV9BTExfQ0xVQlMnKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gUHVibGljIHJpZGVzIGFyZSB2aWV3YWJsZSBieSBhbnlvbmUgKHJlYWQtb25seSlcbiAgICBpZiAoaXNQdWJsaWMgJiYgcmlkZVN0YXR1cyA9PT0gUmlkZVN0YXR1cy5QVUJMSVNIRUQpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFBoYXNlIDIuMzogT25seSBjbHViIHJpZGVzIHN1cHBvcnRlZFxuICAgIGlmIChyaWRlU2NvcGUgIT09IFJpZGVTY29wZS5DTFVCKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgY2x1YiBtZW1iZXJzaGlwXG4gICAgY29uc3QgbWVtYmVyc2hpcCA9IGF1dGhDb250ZXh0LmNsdWJNZW1iZXJzaGlwcz8uZmluZCgobTogYW55KSA9PiBtLmNsdWJJZCA9PT0gY2x1YklkKTtcbiAgICBpZiAoIW1lbWJlcnNoaXAgfHwgbWVtYmVyc2hpcC5zdGF0dXMgIT09ICdhY3RpdmUnKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gRHJhZnQgcmlkZXM6IG9ubHkgY3JlYXRvciBhbmQgbGVhZGVyc2hpcCBjYW4gdmlld1xuICAgIGlmIChyaWRlU3RhdHVzID09PSBSaWRlU3RhdHVzLkRSQUZUKSB7XG4gICAgICBpZiAocmlkZUNyZWF0ZWRCeSA9PT0gYXV0aENvbnRleHQudXNlcklkKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgXG4gICAgICBjb25zdCByb2xlQ2FwYWJpbGl0aWVzID0gdGhpcy5ST0xFX0NBUEFCSUxJVElFU1ttZW1iZXJzaGlwLnJvbGUgYXMgQ2x1YlJvbGVdIHx8IFtdO1xuICAgICAgcmV0dXJuIHJvbGVDYXBhYmlsaXRpZXMuaW5jbHVkZXMoUmlkZUNhcGFiaWxpdHkuVklFV19EUkFGVF9SSURFUyk7XG4gICAgfVxuXG4gICAgLy8gUHVibGlzaGVkIHJpZGVzOiBhbGwgY2x1YiBtZW1iZXJzIGNhbiB2aWV3XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBzdGF0aWMgY2FuUHVibGlzaFJpZGUoYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0LCBjbHViSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIC8vIFN5c3RlbSBhZG1pbiBjYW4gcHVibGlzaCBhbnkgcmlkZVxuICAgIGlmIChhdXRoQ29udGV4dC5zeXN0ZW1DYXBhYmlsaXRpZXM/LmluY2x1ZGVzKCdNQU5BR0VfQUxMX0NMVUJTJykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IG1lbWJlcnNoaXAgPSBhdXRoQ29udGV4dC5jbHViTWVtYmVyc2hpcHM/LmZpbmQoKG06IGFueSkgPT4gbS5jbHViSWQgPT09IGNsdWJJZCk7XG4gICAgaWYgKCFtZW1iZXJzaGlwIHx8IG1lbWJlcnNoaXAuc3RhdHVzICE9PSAnYWN0aXZlJykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IHJvbGVDYXBhYmlsaXRpZXMgPSB0aGlzLlJPTEVfQ0FQQUJJTElUSUVTW21lbWJlcnNoaXAucm9sZSBhcyBDbHViUm9sZV0gfHwgW107XG4gICAgcmV0dXJuIHJvbGVDYXBhYmlsaXRpZXMuaW5jbHVkZXMoUmlkZUNhcGFiaWxpdHkuUFVCTElTSF9PRkZJQ0lBTF9SSURFUyk7XG4gIH1cblxuICBzdGF0aWMgZ2V0VXNlclJpZGVDYXBhYmlsaXRpZXMoYXV0aENvbnRleHQ6IEF1dGhDb250ZXh0LCBjbHViSWQ6IHN0cmluZyk6IFJpZGVDYXBhYmlsaXR5W10ge1xuICAgIC8vIFN5c3RlbSBhZG1pbiBoYXMgYWxsIGNhcGFiaWxpdGllc1xuICAgIGlmIChhdXRoQ29udGV4dC5zeXN0ZW1DYXBhYmlsaXRpZXM/LmluY2x1ZGVzKCdNQU5BR0VfQUxMX0NMVUJTJykpIHtcbiAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKFJpZGVDYXBhYmlsaXR5KTtcbiAgICB9XG5cbiAgICBjb25zdCBtZW1iZXJzaGlwID0gYXV0aENvbnRleHQuY2x1Yk1lbWJlcnNoaXBzPy5maW5kKChtOiBhbnkpID0+IG0uY2x1YklkID09PSBjbHViSWQpO1xuICAgIGlmICghbWVtYmVyc2hpcCB8fCBtZW1iZXJzaGlwLnN0YXR1cyAhPT0gJ2FjdGl2ZScpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5ST0xFX0NBUEFCSUxJVElFU1ttZW1iZXJzaGlwLnJvbGUgYXMgQ2x1YlJvbGVdIHx8IFtdO1xuICB9XG59Il19