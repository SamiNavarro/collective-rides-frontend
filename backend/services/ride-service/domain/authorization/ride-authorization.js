"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RideAuthorizationService = void 0;
const ride_authorization_1 = require("../../../../shared/types/ride-authorization");
const club_authorization_1 = require("../../../../shared/types/club-authorization");
const ride_1 = require("../../../../shared/types/ride");
const authorization_errors_1 = require("../../../../shared/authorization/authorization-errors");
class RideAuthorizationService {
    static async requireRideCapability(capability, authContext, clubId, rideId, rideCreatedBy) {
        // System admin override
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return;
        }
        // Check club membership and role
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            throw new authorization_errors_1.InsufficientPrivilegesError(capability, authContext.userId, `club:${clubId}`);
        }
        // Get capabilities for user's club role
        const roleCapabilities = this.ROLE_CAPABILITIES[membership.role] || [];
        // Special case: ride creator can manage their own draft rides
        if (rideCreatedBy === authContext.userId &&
            (capability === ride_authorization_1.RideCapability.MANAGE_RIDES || capability === ride_authorization_1.RideCapability.CANCEL_RIDES)) {
            return;
        }
        // Check if user has required capability
        if (!roleCapabilities.includes(capability)) {
            throw new authorization_errors_1.InsufficientPrivilegesError(capability, authContext.userId, `club:${clubId}`);
        }
    }
    static canViewRide(authContext, clubId, rideStatus, rideScope, rideCreatedBy, isPublic) {
        // System admin can view all rides
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return true;
        }
        // Public rides are viewable by anyone (read-only)
        if (isPublic && rideStatus === ride_1.RideStatus.PUBLISHED) {
            return true;
        }
        // Phase 2.3: Only club rides supported
        if (rideScope !== ride_1.RideScope.CLUB) {
            return false;
        }
        // Check club membership
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            return false;
        }
        // Draft rides: only creator and leadership can view
        if (rideStatus === ride_1.RideStatus.DRAFT) {
            if (rideCreatedBy === authContext.userId) {
                return true;
            }
            const roleCapabilities = this.ROLE_CAPABILITIES[membership.role] || [];
            return roleCapabilities.includes(ride_authorization_1.RideCapability.VIEW_DRAFT_RIDES);
        }
        // Published rides: all club members can view
        return true;
    }
    static canPublishRide(authContext, clubId) {
        // System admin can publish any ride
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return true;
        }
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            return false;
        }
        const roleCapabilities = this.ROLE_CAPABILITIES[membership.role] || [];
        return roleCapabilities.includes(ride_authorization_1.RideCapability.PUBLISH_OFFICIAL_RIDES);
    }
    static getUserRideCapabilities(authContext, clubId) {
        // System admin has all capabilities
        if (authContext.systemCapabilities?.includes('MANAGE_ALL_CLUBS')) {
            return Object.values(ride_authorization_1.RideCapability);
        }
        const membership = authContext.clubMemberships?.find((m) => m.clubId === clubId);
        if (!membership || membership.status !== 'active') {
            return [];
        }
        return this.ROLE_CAPABILITIES[membership.role] || [];
    }
}
RideAuthorizationService.ROLE_CAPABILITIES = {
    [club_authorization_1.ClubRole.MEMBER]: [
        ride_authorization_1.RideCapability.VIEW_CLUB_RIDES,
        ride_authorization_1.RideCapability.JOIN_RIDES,
        ride_authorization_1.RideCapability.CREATE_RIDE_PROPOSALS
    ],
    [club_authorization_1.ClubRole.CAPTAIN]: [
        ride_authorization_1.RideCapability.VIEW_CLUB_RIDES,
        ride_authorization_1.RideCapability.JOIN_RIDES,
        ride_authorization_1.RideCapability.CREATE_RIDE_PROPOSALS,
        ride_authorization_1.RideCapability.VIEW_DRAFT_RIDES,
        ride_authorization_1.RideCapability.PUBLISH_OFFICIAL_RIDES,
        ride_authorization_1.RideCapability.MANAGE_PARTICIPANTS
    ],
    [club_authorization_1.ClubRole.ADMIN]: [
        ride_authorization_1.RideCapability.VIEW_CLUB_RIDES,
        ride_authorization_1.RideCapability.JOIN_RIDES,
        ride_authorization_1.RideCapability.CREATE_RIDE_PROPOSALS,
        ride_authorization_1.RideCapability.VIEW_DRAFT_RIDES,
        ride_authorization_1.RideCapability.PUBLISH_OFFICIAL_RIDES,
        ride_authorization_1.RideCapability.MANAGE_PARTICIPANTS,
        ride_authorization_1.RideCapability.MANAGE_RIDES,
        ride_authorization_1.RideCapability.CANCEL_RIDES,
        ride_authorization_1.RideCapability.ASSIGN_LEADERSHIP
    ],
    [club_authorization_1.ClubRole.OWNER]: [
        ...Object.values(ride_authorization_1.RideCapability)
    ]
};
exports.RideAuthorizationService = RideAuthorizationService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmlkZS1hdXRob3JpemF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmlkZS1hdXRob3JpemF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG9GQUE2RTtBQUM3RSxvRkFBb0Y7QUFDcEYsd0RBQXNFO0FBQ3RFLGdHQUFvRztBQUVwRyxNQUFhLHdCQUF3QjtJQStCbkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FDaEMsVUFBMEIsRUFDMUIsV0FBd0IsRUFDeEIsTUFBYyxFQUNkLE1BQWUsRUFDZixhQUFzQjtRQUV0Qix3QkFBd0I7UUFDeEIsSUFBSSxXQUFXLENBQUMsa0JBQWtCLEVBQUUsUUFBUSxDQUFDLGtCQUFrQixDQUFDLEVBQUU7WUFDaEUsT0FBTztTQUNSO1FBRUQsaUNBQWlDO1FBQ2pDLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxDQUFDO1FBQ3RGLElBQUksQ0FBQyxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDakQsTUFBTSxJQUFJLGtEQUEyQixDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsTUFBTSxFQUFFLFFBQVEsTUFBTSxFQUFFLENBQUMsQ0FBQztTQUN6RjtRQUVELHdDQUF3QztRQUN4QyxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsSUFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVuRiw4REFBOEQ7UUFDOUQsSUFBSSxhQUFhLEtBQUssV0FBVyxDQUFDLE1BQU07WUFDcEMsQ0FBQyxVQUFVLEtBQUssbUNBQWMsQ0FBQyxZQUFZLElBQUksVUFBVSxLQUFLLG1DQUFjLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDOUYsT0FBTztTQUNSO1FBRUQsd0NBQXdDO1FBQ3hDLElBQUksQ0FB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QUksVUFBVSxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDakQsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUVELE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxJQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO0lBQ25FLENBQUM7O0FBckl1QiwwQ0FBaUIsR0FBdUM7SUFDOUUsQ0FBQyw2QkFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ2pCLG1DQUFjLENBQUMsZUFBZTtRQUM5QixtQ0FBYyxDQUFDLFVBQVU7UUFDekIsbUNBQWMsQ0FBQyxxQkFBcUI7S0FDckM7SUFDRCxDQUFDLDZCQUFRLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDbEIsbUNBQWMsQ0FBQyxlQUFlO1FBQzlCLG1DQUFjLENBQUMsVUFBVTtRQUN6QixtQ0FBYyxDQUFDLHFCQUFxQjtRQUNwQyxtQ0FBYyxDQUFDLGdCQUFnQjtRQUMvQixtQ0FBYyxDQUFDLHNCQUFzQjtRQUNyQyxtQ0FBYyxDQUFDLG1CQUFtQjtLQUNuQztJQUNELENBQUMsNkJBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUNoQixtQ0FBYyxDQUFDLGVBQWU7UUFDOUIsbUNBQWMsQ0FBQyxVQUFVO1FBQ3pCLG1DQUFjLENBQUMscUJBQXFCO1FBQ3BDLG1DQUFjLENBQUMsZ0JBQWdCO1FBQy9CLG1DQUFjLENBQUMsc0JBQXNCO1FBQ3JDLG1DQUFjLENBQUMsbUJBQW1CO1FBQ2xDLG1DQUFjLENBQUMsWUFBWTtRQUMzQixtQ0FBYyxDQUFDLFlBQVk7UUFDM0IsbUNBQWMsQ0FBQyxpQkFBaUI7S0FDakM7SUFDRCxDQUFDLDZCQUFRLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDaEIsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLG1DQUFjLENBQUM7S0FDakM7Q0FDRixDQUFDO0FBN0JTLDREQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJpZGVDYXBhYmlsaXR5IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2hhcmVkL3R5cGVzL3JpZGUtYXV0aG9yaXphdGlvbic7XG5pbXBvcnQgeyBDbHViUm9sZSwgQXV0aENvbnRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvdHlwZXMvY2x1Yi1hdXRob3JpemF0aW9uJztcbmltcG9ydCB7IFJpZGVTdGF0dXMsIFJpZGVTY29wZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NoYXJlZC90eXBlcy9yaWRlJztcbmltcG9ydCB7IEluc3VmZmljaWVudFByaXZpbGVnZXNFcnJvciB9IGZyb20gJy4uLy4uLy4uLy4uL3NoYXJlZC9hdXRob3JpemF0aW9uL2F1dGhvcml6YXRpb24tZXJyb3JzJztcblxuZXhwb3J0IGNsYXNzIFJpZGVBdXRob3JpemF0aW9uU2VydmljZSB7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFJPTEVfQ0FQQUJJTElUSUVTOiBSZWNvcmQ8Q2x1YlJvbGUsIFJpZGVDYXBhYmlsaXR5W10+ID0ge1xuICAgIFtDbHViUm9sZS5NRU1CRVJdOiBbXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5WSUVXX0NMVUJfUklERVMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5KT0lOX1JJREVTLFxuICAgICAgUmlkZUNhcGFiaWxpdHkuQ1JFQVRFX1JJREVfUFJPUE9TQUxTXG4gICAgXSxcbiAgICBbQ2x1YlJvbGUuQ0FQVEFJTl06IFtcbiAgICAgIFJpZGVDYXBhYmlsaXR5LlZJRVdfQ0xVQl9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5LkpPSU5fUklERVMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5DUkVBVEVfUklERV9QUk9QT1NBTFMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5WSUVXX0RSQUZUX1JJREVTLFxuICAgICAgUmlkZUNhcGFiaWxpdHkuUFVCTElTSF9PRkZJQ0lBTF9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5Lk1BTkFHRV9QQVJUSUNJUEFOVFNcbiAgICBdLFxuICAgIFtDbHViUm9sZS5BRE1JTl06IFtcbiAgICAgIFJpZGVDYXBhYmlsaXR5LlZJRVdfQ0xVQl9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5LkpPSU5fUklERVMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5DUkVBVEVfUklERV9QUk9QT1NBTFMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5WSUVXX0RSQUZUX1JJREVTLFxuICAgICAgUmlkZUNhcGFiaWxpdHkuUFVCTElTSF9PRkZJQ0lBTF9SSURFUyxcbiAgICAgIFJpZGVDYXBhYmlsaXR5Lk1BTkFHRV9QQVJUSUNJUEFOVFMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5NQU5BR0VfUklERVMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5DQU5DRUxfUklERVMsXG4gICAgICBSaWRlQ2FwYWJpbGl0eS5BU1NJR05fTEVBREVSU0hJUFxuICAgIF0sXG4gICAgW0NsdWJSb2xlLk9XTkVSXTogW1xuICAgICAgLi4uT2JqZWN0LnZhbHVlcyhSaWRlQ2FwYWJpbGl0eSlcbiAgICBdXG4gIH07XG5cbiAgc3RhdGljIGFzeW5jIHJlcXVpcmVSaWRlQ2FwYWJpbGl0eShcbiAgICBjYXBhYmlsaXR5OiBSaWRlQ2FwYWJpbGl0eSxcbiAgICBhdXRoQ29udGV4dDogQXV0aENvbnRleHQsXG4gICAgY2x1YklkOiBzdHJpbmcsXG4gICAgcmlkZUlkPzogc3RyaW5nLFxuICAgIHJpZGVDcmVhdGVkQnk/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gU3lzdGVtIGFkbWluIG92ZXJyaWRlXG4gICAgaWYgKGF1dGhDb250ZXh0LnN5c3RlbUNhcGFiaWxpdGllcz8uaW5jbHVkZXMoJ01BTkFHRV9BTExfQ0xVQlMnKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGNsdWIgbWVtYmVyc2hpcCBhbmQgcm9sZVxuICAgIGNvbnN0IG1lbWJlcnNoaXAgPSBhdXRoQ29udGV4dC5jbHViTWVtYmVyc2hpcHM/LmZpbmQoKG06IGFueSkgPT4gbS5jbHViSWQgPT09IGNsdWJJZCk7XG4gICAgaWYgKCFtZW1iZXJzaGlwIHx8IG1lbWJlcnNoaXAuc3RhdHVzICE9PSAnYWN0aXZlJykge1xuICAgICAgdGhyb3cgbmV3IEluc3VmZmljaWVudFByaXZpbGVnZXNFcnJvcihjYXBhYmlsaXR5LCBhdXRoQ29udGV4dC51c2VySWQsIGBjbHViOiR7Y2x1YklkfWApO1xuICAgIH1cblxuICAgIC8vIEdldCBjYXBhYmlsaXRpZXMgZm9yIHVzZXIncyBjbHViIHJvbGVcbiAgICBjb25zdCByb2xlQ2FwYWJpbGl0aWVzID0gdGhpcy5ST0xFX0NBUEFCSUxJVElFU1ttZW1iZXJzaGlwLnJvbGUgYXMgQ2x1YlJvbGVdIHx8IFtdO1xuICAgIFxuICAgIC8vIFNwZWNpYWwgY2FzZTogcmlkZSBjcmVhdG9yIGNhbiBtYW5hZ2UgdGhlaXIgb3duIGRyYWZ0IHJpZGVzXG4gICAgaWYgKHJpZGVDcmVhdGVkQnkgPT09IGF1dGhDb250ZXh0LnVzZXJJZCAmJiBcbiAgICAgICAgKGNhcGFiaWxpdHkgPT09IFJpZGVDYXBhYmlsaXR5Lk1BTkFHRV9SSURFUyB8fCBjYXBhYmlsaXR5ID09PSBSaWRlQ2FwYWJpbGl0eS5DQU5DRUxfUklERVMpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgcmVxdWlyZWQgY2FwYWJpbGl0eVxuICAgIGlmICghcm9sZUNhcGFiaWxpdGllcy5pbmNsdWRlcyhjYXBhYmlsaXR5KSkge1xuICAgICAgdGhyb3cgbmV3IEluc3VmZmljaWVudFByaXZpbGVnZXNFcnJvcihjYXBhYmlsaXR5LCBhdXRoQ29udGV4dC51c2VySWQsIGBjbHViOiR7Y2x1YklkfWApO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBjYW5WaWV3UmlkZShcbiAgICBhdXRoQ29udGV4dDogQXV0aENvbnRleHQsXG4gICAgY2x1YklkOiBzdHJpbmcsXG4gICAgcmlkZVN0YXR1czogUmlkZVN0YXR1cyxcbiAgICByaWRlU2NvcGU6IFJpZGVTY29wZSxcbiAgICByaWRlQ3JlYXRlZEJ5OiBzdHJpbmcsXG4gICAgaXNQdWJsaWM6IGJvb2xlYW5cbiAgKTogYm9vbGVhbiB7XG4gICAgLy8gU3lzdGVtIGFkbWluIGNhbiB2aWV3IGFsbCByaWRlc1xuICAgIGlmIChhdXRoQ29udGV4dC5zeXN0ZW1DYXBhYmlsaXRpZXM/LmluY2x1ZGVzKCdNQU5BR0VfQUxMX0NMVUJTJykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFB1YmxpYyByaWRlcyBhcmUgdmlld2FibGUgYnkgYW55b25lIChyZWFkLW9ubHkpXG4gICAgaWYgKGlzUHVibGljICYmIHJpZGVTdGF0dXMgPT09IFJpZGVTdGF0dXMuUFVCTElTSEVEKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBQaGFzZSAyLjM6IE9ubHkgY2x1YiByaWRlcyBzdXBwb3J0ZWRcbiAgICBpZiAocmlkZVNjb3BlICE9PSBSaWRlU2NvcGUuQ0xVQikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGNsdWIgbWVtYmVyc2hpcFxuICAgIGNvbnN0IG1lbWJlcnNoaXAgPSBhdXRoQ29udGV4dC5jbHViTWVtYmVyc2hpcHM/LmZpbmQoKG06IGFueSkgPT4gbS5jbHViSWQgPT09IGNsdWJJZCk7XG4gICAgaWYgKCFtZW1iZXJzaGlwIHx8IG1lbWJlcnNoaXAuc3RhdHVzICE9PSAnYWN0aXZlJykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIERyYWZ0IHJpZGVzOiBvbmx5IGNyZWF0b3IgYW5kIGxlYWRlcnNoaXAgY2FuIHZpZXdcbiAgICBpZiAocmlkZVN0YXR1cyA9PT0gUmlkZVN0YXR1cy5EUkFGVCkge1xuICAgICAgaWYgKHJpZGVDcmVhdGVkQnkgPT09IGF1dGhDb250ZXh0LnVzZXJJZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3Qgcm9sZUNhcGFiaWxpdGllcyA9IHRoaXMuUk9MRV9DQVBBQklMSVRJRVNbbWVtYmVyc2hpcC5yb2xlIGFzIENsdWJSb2xlXSB8fCBbXTtcbiAgICAgIHJldHVybiByb2xlQ2FwYWJpbGl0aWVzLmluY2x1ZGVzKFJpZGVDYXBhYmlsaXR5LlZJRVdfRFJBRlRfUklERVMpO1xuICAgIH1cblxuICAgIC8vIFB1Ymxpc2hlZCByaWRlczogYWxsIGNsdWIgbWVtYmVycyBjYW4gdmlld1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgc3RhdGljIGNhblB1Ymxpc2hSaWRlKGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCwgY2x1YklkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAvLyBTeXN0ZW0gYWRtaW4gY2FuIHB1Ymxpc2ggYW55IHJpZGVcbiAgICBpZiAoYXV0aENvbnRleHQuc3lzdGVtQ2FwYWJpbGl0aWVzPy5pbmNsdWRlcygnTUFOQUdFX0FMTF9DTFVCUycpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBjb25zdCBtZW1iZXJzaGlwID0gYXV0aENvbnRleHQuY2x1Yk1lbWJlcnNoaXBzPy5maW5kKChtOiBhbnkpID0+IG0uY2x1YklkID09PSBjbHViSWQpO1xuICAgIGlmICghbWVtYmVyc2hpcCB8fCBtZW1iZXJzaGlwLnN0YXR1cyAhPT0gJ2FjdGl2ZScpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCByb2xlQ2FwYWJpbGl0aWVzID0gdGhpcy5ST0xFX0NBUEFCSUxJVElFU1ttZW1iZXJzaGlwLnJvbGUgYXMgQ2x1YlJvbGVdIHx8IFtdO1xuICAgIHJldHVybiByb2xlQ2FwYWJpbGl0aWVzLmluY2x1ZGVzKFJpZGVDYXBhYmlsaXR5LlBVQkxJU0hfT0ZGSUNJQUxfUklERVMpO1xuICB9XG5cbiAgc3RhdGljIGdldFVzZXJSaWRlQ2FwYWJpbGl0aWVzKGF1dGhDb250ZXh0OiBBdXRoQ29udGV4dCwgY2x1YklkOiBzdHJpbmcpOiBSaWRlQ2FwYWJpbGl0eVtdIHtcbiAgICAvLyBTeXN0ZW0gYWRtaW4gaGFzIGFsbCBjYXBhYmlsaXRpZXNcbiAgICBpZiAoYXV0aENvbnRleHQuc3lzdGVtQ2FwYWJpbGl0aWVzPy5pbmNsdWRlcygnTUFOQUdFX0FMTF9DTFVCUycpKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhSaWRlQ2FwYWJpbGl0eSk7XG4gICAgfVxuXG4gICAgY29uc3QgbWVtYmVyc2hpcCA9IGF1dGhDb250ZXh0LmNsdWJNZW1iZXJzaGlwcz8uZmluZCgobTogYW55KSA9PiBtLmNsdWJJZCA9PT0gY2x1YklkKTtcbiAgICBpZiAoIW1lbWJlcnNoaXAgfHwgbWVtYmVyc2hpcC5zdGF0dXMgIT09ICdhY3RpdmUnKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuUk9MRV9DQVBBQklMSVRJRVNbbWVtYmVyc2hpcC5yb2xlIGFzIENsdWJSb2xlXSB8fCBbXTtcbiAgfVxufSJdfQ==