"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lambda_utils_1 = require("../../../../shared/utils/lambda-utils");
const auth_context_1 = require("../../../../shared/auth/auth-context");
const dynamodb_ride_repository_1 = require("../../infrastructure/dynamodb-ride-repository");
const dynamodb_participation_repository_1 = require("../../infrastructure/dynamodb-participation-repository");
const dynamodb_membership_helper_1 = require("../../infrastructure/dynamodb-membership-helper");
const participation_service_1 = require("../../domain/participation/participation-service");
const ride_authorization_1 = require("../../domain/authorization/ride-authorization");
const ride_authorization_2 = require("../../../../shared/types/ride-authorization");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const tableName = process.env.DYNAMODB_TABLE_NAME;
const rideRepository = new dynamodb_ride_repository_1.DynamoDBRideRepository(dynamoClient, tableName);
const participationRepository = new dynamodb_participation_repository_1.DynamoDBParticipationRepository(dynamoClient, tableName);
const membershipHelper = new dynamodb_membership_helper_1.MembershipHelper(dynamoClient, tableName);
const participationService = new participation_service_1.ParticipationService(participationRepository, rideRepository);
const handler = async (event) => {
    try {
        // Get auth context
        const authContext = await (0, auth_context_1.getAuthContext)(event);
        const clubId = event.pathParameters?.clubId;
        const rideId = event.pathParameters?.rideId;
        if (!clubId || !rideId) {
            return (0, lambda_utils_1.createResponse)(400, { error: 'Club ID and Ride ID are required' });
        }
        // Populate club memberships for authorization
        const memberships = await membershipHelper.getUserMemberships(authContext.userId);
        authContext.clubMemberships = memberships;
        // Check authorization - club membership required to join rides
        await ride_authorization_1.RideAuthorizationService.requireRideCapability(ride_authorization_2.RideCapability.JOIN_RIDES, authContext, clubId, rideId);
        // Parse request (optional body)
        const request = event.body ? (0, lambda_utils_1.parseJSON)(event.body) : {};
        // Join ride
        const participation = await participationService.joinRide(rideId, authContext.userId, request);
        return (0, lambda_utils_1.createResponse)(201, {
            success: true,
            data: participation.toJSON(),
            timestamp: new Date().toISOString()
        });
    }
    catch (error) {
        console.error('Join ride error:', error);
        if (error.statusCode) {
            return (0, lambda_utils_1.createResponse)(error.statusCode, {
                error: error.message,
                errorType: error.errorType
            });
        }
        return (0, lambda_utils_1.createResponse)(500, { error: 'Internal server error' });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam9pbi1yaWRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiam9pbi1yaWRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3RUFBa0Y7QUFDbEYsdUVBQXNFO0FBQ3RFLDRGQUF1RjtBQUN2Riw4R0FBeUc7QUFDekcsZ0dBQW1GO0FBQ25GLDRGQUF3RjtBQUN4RixzRkFBeUY7QUFDekYsb0ZBQTZFO0FBRzdFLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFvQixDQUFDO0FBQ25ELE1BQU0sY0FBYyxHQUFHLElBQUksaURBQXNCLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQzNFLE1BQU0sdUJBQXVCLEdBQUcsSUFBSSxtRUFBK0IsQ0FBQyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDN0YsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLDZDQUFnQixDQUFDLFlBQVksRUFBRSxTQUFTLENBQUMsQ0FBQztBQUN2RSxNQUFNLG9CQUFvQixHQUFHLElBQUksNENBQW9CLENBQUMsdUJBQXVCLEVBQUUsY0FBYyxDQUFDLENBQUM7QUFFeEYsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTJCLEVBQWtDLEVBQUU7SUFDM0YsSUFBSTtRQUNGLG1CQUFtQjtRQUNuQixNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUEsNkJBQWMsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUNoRCxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQztRQUM1QyxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQztRQUU1QyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3RCLE9BQU8sSUFBQSw2QkFBYyxFQUFDLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSxrQ0FBa0MsRUFBRSxDQUFDLENBQUM7U0FDM0U7UUFFRCw4Q0FBOEM7UUFDOUMsTUFBTSxXQUFXLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEYsV0FBVyxDQUFDLGVBQWUsR0FBRyxXQUFXLENBQUM7UUFFMUMsK0RBQStEO1FBQy9ELE1BQU0sNkNBQXdCLENBQUMscUJBQXFCLENBQ2xELG1DQUFjLENBQUMsVUFBVSxFQUN6QixXQUFXLEVBQ1gsTUFBTSxFQUNOLE1BQU0sQ0FDUCxDQUFDO1FBRUYsZ0NBQWdDO1FBQ2hDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUEsd0JBQVMsRUFBa0IsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFFekUsWUFBWTtRQUNaLE1BQU0sYUFBYSxHQUFHLE1BQU0sb0JBQW9CLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRS9GLE9BQU8sSUFBQSw2QkFBYyxFQUFDLEdBQUcsRUFBRTtZQUN6QixPQUFPLEVBQUUsSUFBSTtZQUNiLElBQUksRUFBRSxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQzVCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUNwQyxDQUFDLENBQUM7S0FFSjtJQUFDLE9BQU8sS0FBVSxFQUFFO1FBQ25CLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFekMsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3BCLE9BQU8sSUFBQSw2QkFBYyxFQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUU7Z0JBQ3RDLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTztnQkFDcEIsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO2FBQzNCLENBQUMsQ0FBQztTQUNKO1FBRUQsT0FBTyxJQUFBLDZCQUFjLEVBQUMsR0FBRyxFQUFFLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztLQUNoRTtBQUNILENBQUMsQ0FBQztBQS9DVyxRQUFBLE9BQU8sV0ErQ2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgY3JlYXRlUmVzcG9uc2UsIHBhcnNlSlNPTiB9IGZyb20gJy4uLy4uLy4uLy4uL3NoYXJlZC91dGlscy9sYW1iZGEtdXRpbHMnO1xuaW1wb3J0IHsgZ2V0QXV0aENvbnRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvYXV0aC9hdXRoLWNvbnRleHQnO1xuaW1wb3J0IHsgRHluYW1vREJSaWRlUmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL2luZnJhc3RydWN0dXJlL2R5bmFtb2RiLXJpZGUtcmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBEeW5hbW9EQlBhcnRpY2lwYXRpb25SZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvZHluYW1vZGItcGFydGljaXBhdGlvbi1yZXBvc2l0b3J5JztcbmltcG9ydCB7IE1lbWJlcnNoaXBIZWxwZXIgfSBmcm9tICcuLi8uLi9pbmZyYXN0cnVjdHVyZS9keW5hbW9kYi1tZW1iZXJzaGlwLWhlbHBlcic7XG5pbXBvcnQgeyBQYXJ0aWNpcGF0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL2RvbWFpbi9wYXJ0aWNpcGF0aW9uL3BhcnRpY2lwYXRpb24tc2VydmljZSc7XG5pbXBvcnQgeyBSaWRlQXV0aG9yaXphdGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi9kb21haW4vYXV0aG9yaXphdGlvbi9yaWRlLWF1dGhvcml6YXRpb24nO1xuaW1wb3J0IHsgUmlkZUNhcGFiaWxpdHkgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvdHlwZXMvcmlkZS1hdXRob3JpemF0aW9uJztcbmltcG9ydCB7IEpvaW5SaWRlUmVxdWVzdCB9IGZyb20gJy4uLy4uLy4uLy4uL3NoYXJlZC90eXBlcy9wYXJ0aWNpcGF0aW9uJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IHRhYmxlTmFtZSA9IHByb2Nlc3MuZW52LkRZTkFNT0RCX1RBQkxFX05BTUUhO1xuY29uc3QgcmlkZVJlcG9zaXRvcnkgPSBuZXcgRHluYW1vREJSaWRlUmVwb3NpdG9yeShkeW5hbW9DbGllbnQsIHRhYmxlTmFtZSk7XG5jb25zdCBwYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeSA9IG5ldyBEeW5hbW9EQlBhcnRpY2lwYXRpb25SZXBvc2l0b3J5KGR5bmFtb0NsaWVudCwgdGFibGVOYW1lKTtcbmNvbnN0IG1lbWJlcnNoaXBIZWxwZXIgPSBuZXcgTWVtYmVyc2hpcEhlbHBlcihkeW5hbW9DbGllbnQsIHRhYmxlTmFtZSk7XG5jb25zdCBwYXJ0aWNpcGF0aW9uU2VydmljZSA9IG5ldyBQYXJ0aWNpcGF0aW9uU2VydmljZShwYXJ0aWNpcGF0aW9uUmVwb3NpdG9yeSwgcmlkZVJlcG9zaXRvcnkpO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICB0cnkge1xuICAgIC8vIEdldCBhdXRoIGNvbnRleHRcbiAgICBjb25zdCBhdXRoQ29udGV4dCA9IGF3YWl0IGdldEF1dGhDb250ZXh0KGV2ZW50KTtcbiAgICBjb25zdCBjbHViSWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uY2x1YklkO1xuICAgIGNvbnN0IHJpZGVJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5yaWRlSWQ7XG4gICAgXG4gICAgaWYgKCFjbHViSWQgfHwgIXJpZGVJZCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDQwMCwgeyBlcnJvcjogJ0NsdWIgSUQgYW5kIFJpZGUgSUQgYXJlIHJlcXVpcmVkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBQb3B1bGF0ZSBjbHViIG1lbWJlcnNoaXBzIGZvciBhdXRob3JpemF0aW9uXG4gICAgY29uc3QgbWVtYmVyc2hpcHMgPSBhd2FpdCBtZW1iZXJzaGlwSGVscGVyLmdldFVzZXJNZW1iZXJzaGlwcyhhdXRoQ29udGV4dC51c2VySWQpO1xuICAgIGF1dGhDb250ZXh0LmNsdWJNZW1iZXJzaGlwcyA9IG1lbWJlcnNoaXBzO1xuXG4gICAgLy8gQ2hlY2sgYXV0aG9yaXphdGlvbiAtIGNsdWIgbWVtYmVyc2hpcCByZXF1aXJlZCB0byBqb2luIHJpZGVzXG4gICAgYXdhaXQgUmlkZUF1dGhvcml6YXRpb25TZXJ2aWNlLnJlcXVpcmVSaWRlQ2FwYWJpbGl0eShcbiAgICAgIFJpZGVDYXBhYmlsaXR5LkpPSU5fUklERVMsXG4gICAgICBhdXRoQ29udGV4dCxcbiAgICAgIGNsdWJJZCxcbiAgICAgIHJpZGVJZFxuICAgICk7XG5cbiAgICAvLyBQYXJzZSByZXF1ZXN0IChvcHRpb25hbCBib2R5KVxuICAgIGNvbnN0IHJlcXVlc3QgPSBldmVudC5ib2R5ID8gcGFyc2VKU09OPEpvaW5SaWRlUmVxdWVzdD4oZXZlbnQuYm9keSkgOiB7fTtcblxuICAgIC8vIEpvaW4gcmlkZVxuICAgIGNvbnN0IHBhcnRpY2lwYXRpb24gPSBhd2FpdCBwYXJ0aWNpcGF0aW9uU2VydmljZS5qb2luUmlkZShyaWRlSWQsIGF1dGhDb250ZXh0LnVzZXJJZCwgcmVxdWVzdCk7XG5cbiAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoMjAxLCB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogcGFydGljaXBhdGlvbi50b0pTT04oKSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0pvaW4gcmlkZSBlcnJvcjonLCBlcnJvcik7XG4gICAgXG4gICAgaWYgKGVycm9yLnN0YXR1c0NvZGUpIHtcbiAgICAgIHJldHVybiBjcmVhdGVSZXNwb25zZShlcnJvci5zdGF0dXNDb2RlLCB7IFxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgZXJyb3JUeXBlOiBlcnJvci5lcnJvclR5cGUgXG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDUwMCwgeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSk7XG4gIH1cbn07Il19